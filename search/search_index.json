{"config":{"lang":["en"],"separator":"[\\s\\u200b\\u3000\\-\u3001\u3002\uff0c\uff0e\uff1f\uff01\uff1b]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"About","text":"<ul> <li> <p>\ud83d\udd2d Currently, I'm a Senior Machine Learning Engineer at NetEase Fuxi, focusing on Data-Centric AI.</p> </li> <li> <p>\ud83d\udd2d Previously, I worked at ByteDance as an Machine Learning Engineer in the AIOps field. My primary focus was on developing and implementing algorithms for time series forecasting, anomaly detection, and root cause analysis. The main objective was to proactively detect system failures and swiftly identify root causes, thereby reducing Mean Time To Repair (MTTR) through the analysis of Metrics, Logs, and Traces.</p> </li> <li> <p>\ud83d\udd2d Prior to ByteDance, I contributed to algorithm research in network security (risk management) at Tencent. My work centered on developing anomaly detection algorithms leveraging association analysis and subspace clustering techniques, with a primary application in anti-robot systems. I take pride in the effectiveness of our algorithms, which successfully intercepted numerous attacks. I'm deeply grateful to my mentor, Mr. Liao, whose extensive experience in the security field significantly enhanced my professional growth.</p> </li> <li> <p>\ud83d\udd2d My academic background is in statistics, having earned both my undergraduate degree from Hainan University (HNU) and my graduate degree from Sun Yat-sen University (SYSU) in this field.</p> </li> </ul>"},{"location":"#presentation","title":"Presentation","text":"<ul> <li>2024/07: Build Modern Python Application\u2014\u2014MPPT Practice</li> <li>2023/12: MPPT: A Modern Python Package Template</li> <li>2023/08: Data Mining Odyssey</li> <li>2020/09: Technical debt in machine learning systems</li> </ul>"},{"location":"#current-projects","title":"Current Projects","text":"<ul> <li>\ud83c\udf31 I\u2019m currently working on my projects</li> </ul>"},{"location":"#blog","title":"blog \u53d1\u5e03\u94fe\u6761","text":"<p>obsidian - mkdocs - cloudflare mkdocs\u7ee7\u627f\u4e86python\u7684\u6781\u7b80\uff0c\u975e\u5e38\u7b26\u5408\u6211\u7684\u9700\u6c42\uff0c\u53ea\u9700\u8981\u4e24\u4e2a\u6587\u4ef6\u5c31\u53ef\u4ee5\u90e8\u7f72\u5728cloudflare\u4e0a\u3002</p>"},{"location":"#note-meaning","title":"Note Meaning","text":""},{"location":"#note-type","title":"Note Type","text":"<ol> <li>\u95ea\u5ff5\u7b14\u8bb0 (Fleeting Note)</li> <li>\u6c38\u4e45\u7b14\u8bb0 (Permanent Note)</li> <li>\u9879\u76ee\u7b14\u8bb0 (Project Note)</li> </ol> <p>\u5148\u770b\u5185\u5b58\u7ba1\u7406\uff0c\u518d\u8fdb\u7a0b\u8c03\u5ea6\uff0c\u6700\u540eiommu\uff0c nbio\u4e00\u4e2a\u4e00\u4e2a\u7684\u6a21\u5757\u770b</p> <pre><code>    /* nbio */\n\u00a0 \u00a0 struct amdgpu_nbio \u00a0 \u00a0 \u00a0nbio;\n\u00a0 \u00a0 /* hdp */\n\u00a0 \u00a0 struct amdgpu_hdp \u00a0 \u00a0 \u00a0 hdp;\n\u00a0 \u00a0 /* smuio */\n\u00a0 \u00a0 struct amdgpu_smuio \u00a0 \u00a0 smuio;\n\u00a0 \u00a0 /* mmhub */\n\u00a0 \u00a0 struct amdgpu_mmhub \u00a0 \u00a0 mmhub;\n\u00a0 \u00a0 /* gfxhub */\n\u00a0 \u00a0 struct amdgpu_gfxhub \u00a0 \u00a0 \u00a0 \u00a0gfxhub;\n\u00a0 \u00a0 /* gfx */\n\u00a0 \u00a0 struct amdgpu_gfx \u00a0 \u00a0 \u00a0 gfx;\n\u00a0 \u00a0 /* sdma */\n\u00a0 \u00a0 struct amdgpu_sdma \u00a0 \u00a0 \u00a0sdma;\n\u00a0 \u00a0 /* lsdma */\n\u00a0 \u00a0 struct amdgpu_lsdma \u00a0 \u00a0 lsdma;\n\u00a0 \u00a0 /* uvd */\n\u00a0 \u00a0 struct amdgpu_uvd \u00a0 \u00a0 \u00a0 uvd;\n\u00a0 \u00a0 /* vce */\n\u00a0 \u00a0 struct amdgpu_vce \u00a0 \u00a0 \u00a0 vce;\n\u00a0 \u00a0 /* vcn */\n\u00a0 \u00a0 struct amdgpu_vcn \u00a0 \u00a0 \u00a0 vcn;\n\u00a0 \u00a0 /* jpeg */\n\u00a0 \u00a0 struct amdgpu_jpeg \u00a0 \u00a0 \u00a0jpeg;\n\u00a0 \u00a0 /* vpe */\n\u00a0 \u00a0 struct amdgpu_vpe \u00a0 \u00a0 \u00a0 vpe;\n\u00a0 \u00a0 /* umsch */\n\u00a0 \u00a0 struct amdgpu_umsch_mm \u00a0 \u00a0 \u00a0umsch_mm;\n\u00a0 \u00a0 bool \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0enable_umsch_mm;\n\u00a0 \u00a0 /* firmwares */\n\u00a0 \u00a0 struct amdgpu_firmware \u00a0 \u00a0 \u00a0firmware;\n\u00a0 \u00a0 /* PSP */\n\u00a0 \u00a0 struct psp_context \u00a0 \u00a0 \u00a0psp;\n\u00a0 \u00a0 /* GDS */\n\u00a0 \u00a0 struct amdgpu_gds \u00a0 \u00a0 \u00a0 gds;\n\u00a0 \u00a0 /* for userq and VM fences */\n\u00a0 \u00a0 struct amdgpu_seq64 \u00a0 \u00a0 seq64;\n\u00a0 \u00a0 /* KFD */\n\u00a0 \u00a0 struct amdgpu_kfd_dev \u00a0 \u00a0 \u00a0 kfd;\n\u00a0 \u00a0 /* UMC */\n\u00a0 \u00a0 struct amdgpu_umc \u00a0 \u00a0 \u00a0 umc;\n</code></pre> <p>\u53cb\u60c5\u94fe\u63a5 ML system \u5165\u5751\u6307\u5357 \u5fb7\u666e\u738b \u73b0\u4ee3C++\u6559\u7a0b Linux\u4e3b\u7ebf\u5185\u6838\u8ddf\u8e2a \u8f6f\u4ef6\u67b6\u6784\u8bbe\u8ba1</p>"},{"location":"Linux/KUnit/","title":"KUnit","text":"<p>\u8981\u4f7f\u7528\u4e0d\u540c\u7684<code>.kunitconfig</code>\u6587\u4ef6\uff08\u4f8b\u5982\u63d0\u4f9b\u7528\u4e8e\u6d4b\u8bd5\u7279\u5b9a\u5b50\u7cfb\u7edf\u7684\u6587\u4ef6\uff09\uff0c\u8bf7\u5c06\u5176\u4f5c\u4e3a\u9009\u9879\u4f20\u9012\uff1a</p> <p>./tools/testing/kunit/kunit.py run --kunitconfig=drivers/gpu/drm/tests/.kunitconfig</p>"},{"location":"Linux/Resize%20Bar/","title":"Resize Bar","text":"<p>pci_resize_resource()</p> <ol> <li> <p>intel <pre><code>static void\n\n_resize_bar(struct drm_i915_private *i915, int resno, resource_size_t size)\n\n{\n\n\u00a0 \u00a0 struct pci_dev *pdev = to_pci_dev(i915-&gt;drm.dev);\n\n\u00a0 \u00a0 int bar_size = pci_rebar_bytes_to_size(size);\n\n\u00a0 \u00a0 int ret;\n\n\n\n\u00a0 \u00a0 _release_bars(pdev);\n\n\n\n\u00a0 \u00a0 ret = pci_resize_resource(pdev, resno, bar_size);\n\n\u00a0 \u00a0 if (ret) {\n\n\u00a0 \u00a0 \u00a0 \u00a0 drm_info(&amp;i915-&gt;drm, \"Failed to resize BAR%d to %dM (%pe)\\n\",\n\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0resno, 1 &lt;&lt; bar_size, ERR_PTR(ret));\n\n\u00a0 \u00a0 \u00a0 \u00a0 return;\n\n\u00a0 \u00a0 }\n\n\n\n\u00a0 \u00a0 drm_info(&amp;i915-&gt;drm, \"BAR%d resized to %dM\\n\", resno, 1 &lt;&lt; bar_size);\n\n}\n</code></pre></p> </li> <li> <p>amd AMDKCL_ENABLE_RESIZE_FB_BAR</p> </li> </ol>"},{"location":"Linux/dma-buf/","title":"Dma buf","text":""},{"location":"Linux/dma-buf/#dma-api","title":"DMA API","text":""},{"location":"Linux/dma-buf/#coherent-dma-mapping","title":"coherent DMA mapping","text":"<p>gmc_v12_0_sw_init     r = dma_set_mask_and_coherent(adev-&gt;dev, DMA_BIT_MASK(44)); \u8bbe\u5b9acoherent DMA \u64cd\u4f5c\u7684\u5730\u5740\u63a9\u7801</p>"},{"location":"Linux/dma-buf/#streaming-dma-mapping","title":"streaming DMA mapping","text":"<p>1\u3001map/umap\u5355\u4e2a\u7684dma buffer</p> <p>2\u3001map/umap\u591a\u4e2a\u5f62\u6210scatterlist\u7684dma buffer kfd_mem_dmamap_userptr     ret = dma_map_sgtable(adev-&gt;dev, ttm-&gt;sg, direction, 0);</p> <p>amdgpu_amdkfd_gpuvm_get_sg_table     ret = sg_alloc_table(sg, chunks, GFP_KERNEL);     for_each_sg(sg-&gt;sgl, s, sg-&gt;orig_nents, idx)</p>"},{"location":"Linux/dma-buf/#dma","title":"\u5171\u4eabDMA\u7f13\u51b2\u533a","text":"<p>\u5bfc\u51fa\u8005 - \u5b9e\u73b0\u5e76\u7ba1\u7406<code>strcut dma_bud_ops</code>\u4e2d\u7f13\u51b2\u533a\u7684\u64cd\u4f5c - \u5141\u8bb8\u5176\u4ed6\u7528\u6237\u901a\u8fc7\u4f7f\u7528<code>dma_buf</code>\u5171\u4eabAPI\u6765\u5171\u4eab\u7f13\u51b2\u533a - \u7ba1\u7406\u7f13\u51b2\u533a\u5206\u914d\u7684\u8be6\u7ec6\u4fe1\u606f\uff0c\u5305\u88c5\u5728<code>dma_buf</code>\u7ed3\u6784\u4f53\u4e2d - \u51b3\u5b9a\u53d1\u751f\u5206\u914d\u7684\u5b9e\u9645\u540e\u5907\u5b58\u50a8 - \u8d1f\u8d23\u6539\u7f13\u51b2\u533a\u7684\u6240\u6709(\u5171\u4eab)\u7528\u6237\u7684\u5206\u6563\u5217\u8868\u7684\u4efb\u4f55\u8fc1\u79fb \u7f13\u51b2\u7528\u6237 - \u662f\u7f13\u51b2\u533a\u7684(\u8bb8\u591a)\u5171\u4eab\u7528\u6237\u4e4b\u4e00 - \u4e0d\u9700\u8981\u62c5\u5fc3\u7f13\u51b2\u533a\u662f\u5982\u4f55\u5206\u914d\u7684\uff0c\u6216\u8005\u5728\u54ea\u91cc\u5206\u914d\u7684 - \u5e76\u4e14\u9700\u8981\u4e00\u79cd\u673a\u5236\u6765\u8bbf\u95ee\u6784\u6210\u5185\u5b58\u4e2d\u7f13\u51b2\u533a\u7684\u5206\u6563\u5217\u8868\uff0c\u6620\u5c04\u5230\u81ea\u5df1\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u4fbf\u5b83\u53ef\u4ee5\u8bbf\u95ee\u540c\u4e00\u5185\u5b58\u533a\u57df\u3002\u8be5\u63a5\u53e3\u7531<code>struct dma_buf_attachment</code> \u63d0\u4f9b</p>"},{"location":"Linux/dma-buf/#_1","title":"\u7528\u6237\u7a7a\u95f4\u63a5\u53e3","text":"<p>\u5927\u591a\u6570\u60c5\u51b5\u4e0b\uff0cDMA\u7f13\u51b2\u533a\u6587\u4ef6\u63cf\u8ff0\u7b26\u53ea\u662f\u7528\u6237\u7a7a\u95f4\u7684\u4e0d\u900f\u660e\u5bf9\u8c61\uff0c\u56e0\u6b64\u516c\u5f00\u7684\u901a\u7528\u63a5\u53e3\u975e\u5e38\u5c11\u3002\u4f46\u6709\u4e00\u4e9b\u4e8b\u60c5\u9700\u8981\u8003\u8651: - \u652f\u6301DMA\u7f13\u51b2\u533a\u5185\u5bb9\u7684\u5185\u5b58\u6620\u5c04 - DMA\u7f13\u51b2\u533aFD\u662f\u53ef\u67e5\u8be2\u7684 - DMA\u7f13\u51b2\u533aFD\u662f\u652f\u6301\u4e00\u4e9bdma-buf\u7279\u5b9a\u7684ioctl</p>"},{"location":"Linux/dma-buf/#dma_1","title":"\u57fa\u672c\u64cd\u4f5c\u5408\u8bbe\u5907DMA\u8bbf\u95ee","text":"<p>\u8bbe\u5907DMA\u8bbf\u95ee\u5171\u4eabDMA\u7f13\u51b2\u533a\uff0c\u901a\u5e38\u9700\u8981\u91c7\u7528\u4e0b\u5217\u6b65\u9aa4 - \u5bfc\u51fa\u8005\u4f7f\u7528<code>DEFINE_DMA_BUF_EXPORT_INFO()</code>\u5b9a\u4e49<code>dma-buf</code>\u5b9e\u4f8b\uff0c\u5e76\u8c03\u7528<code>dma_buf_export()</code>,\u5c06\u79c1\u6709\u7f13\u51b2\u533a\u5bf9\u8c61\u5c01\u88c5\u5230dma_buf\u4e2d. \u7136\u540e\uff0c\u8c03\u7528<code>dma_buf_fd()</code>\u5c06<code>dma_buf</code>\u4f5c\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\u5bfc\u51fa\u5230\u7528\u6237\u7a7a\u95f4\u3002 - \u7528\u6237\u7a7a\u95f4\u5c06\u6b64\u6587\u4ef6\u63cf\u8ff0\u7b26\u4f20\u9012\u7ed9\u5b83\u5e0c\u671b\u5171\u4eab\u6b64\u7f13\u51b2\u533a\u7684\u6240\u6709\u9a71\u52a8\u7a0b\u5e8f: \u9996\u5148\u4f7f\u7528dma_buf_get()\u5c06\u6587\u4ef6\u63cf\u8ff0\u7b26\u8f6c\u6362\u4e3adma_buf\uff1b\u7136\u540e\u4f7f\u7528dma_buf_attach()\u5c06\u7f13\u51b2\u533a\u9644\u52a0\u5230\u8bbe\u5907\u3002 - \u4e00\u65e6\u7f13\u51b2\u533a\u8fde\u63a5\u5230\u8bbe\u5907\uff0c\u7528\u6237\u7a7a\u95f4\u5c31\u53ef\u4ee5\u542f\u52a8\u5bf9\u5171\u4eab\u7f13\u51b2\u533a\u7684DMA\u8bbf\u95ee\u3002\u5728\u5185\u6838\u4e2d\uff0c\u8fd9\u662f\u901a\u8fc7\u8c03\u7528<code>dma_buf_map_attachnment()</code>\u548c<code>dma_buf_unmap_attachnment()</code>\u6765\u5b8c\u6210\u7684\u3002 - \u4e00\u65e6\u9a71\u52a8\u7a0b\u5e8f\u4f7f\u7528\u5b8c\u5171\u4eab\u7f13\u51b2\u533a\uff0c\u8c03\u7528<code>dam_buf_detach()</code>,\u7136\u540e\u518d\u8c03\u7528<code>dma_buf_put()</code>\u91ca\u653e\u4f7f\u7528<code>dma_buf_get()</code>\u7684\u5f15\u7528\u3002</p>"},{"location":"Linux/dma-buf/#fence","title":"\u9690\u5f0f\u56f4\u680f(fence)\u67e5\u8be2\u652f\u6301","text":"<p>\u4e3a\u4e86\u652f\u6301\u7f13\u51b2\u533a\u8bbf\u95ee\u7684\u8de8\u8bbe\u5907\u548c\u8de8\u9a71\u52a8\u7a0b\u5e8f\u540c\u6b65\uff0c\u53ef\u4ee5\u5c06\u9690\u5f0f\u56f4\u680f(\u5728\u5185\u6838\u5185\u90e8\u7528struct dam_fence\u8868\u793a)\u9644\u52a0\u5230dma_buf\u3002dma_resv\u7ed3\u6784\u4e2d\u63d0\u4f9b\u4e86\u5b83\u7684\u7c98\u5408\u5242\u548c\u4e00\u4e9b\u76f8\u5173\u7684\u4e1c\u897f\u3002 \u7528\u6237\u7a7a\u95f4\u53ef\u4ee5\u4f7f\u7528poll()\u548c\u76f8\u5173\u7cfb\u7edf\u8c03\u7528\uff0c\u67e5\u8be2\u8fd9\u4e9b\u9690\u5f0f\u8ddf\u8e2a\u7684\u6805\u680f\u72b6\u6001: - \u68c0\u67e5EPOLLIN (\u5373\u8bfb\u8bbf\u95ee) \u53ef\u7528\u4e8e\u67e5\u8be2\u6700\u8fd1\u7684\u5199\uff0c\u6216\u72ec\u5360\u6805\u680f\u7684\u72b6\u6001\u3002 - \u68c0\u67e5EPOLLOUT (\u5373\u8bfb\u8bbf\u95ee) \u53ef\u7528\u4e8e\u67e5\u8be2\u6240\u6709\u9644\u52a0\u6805\u680f(\u5171\u4eab\u6805\u680f\u548c\u72ec\u5360\u6805\u680f) \u7684\u72b6\u6001\u3002 \u8bf7\u6ce8\u610f\uff0c\u8fd9\u4ec5\u8868\u793a\u76f8\u5e94\u6805\u680f\u5df2\u5b8c\u6210\uff0c\u5373DMA\u4f20\u8f93\u5df2\u5b8c\u6210\u3002\u5728CPU\u8bbf\u95ee\u5f00\u59cb\u4e4b\u524d\uff0c\u7f13\u5b58\u5237\u65b0\u548c\u4efb\u4f55\u5176\u4ed6\u5fc5\u8981\u7684\u51c6\u5907\u5de5\u4f5c\u4ecd\u7136\u9700\u8981\u7ee7\u7eed\u8fdb\u884c\u3002 \u4f5c\u4e3apoll()\u7684\u66ff\u4ee3\u65b9\u6848\uff0c\u53ef\u4ee5\u4f7f\u7528dma_buf_sync_file_export\u5c06DMA\u7f13\u51b2\u533a\u4e0a\u7684\u6805\u680f\u96c6\u5bfc\u51fa\u4e3async_file.</p> <p>\u5176\u4e2damdgpu\u901a\u8fc7drm_gem_object -&gt; funcs -&gt; export(amdgpu_gem_prime_export)\u6765\u63d0\u4f9b\u652f\u6301 <pre><code>struct dma_buf *amdgpu_gem_prime_export(struct drm_gem_object *gobj,\n                    int flags)\n{\n    struct amdgpu_bo *bo = gem_to_amdgpu_bo(gobj);\n    struct dma_buf *buf;\n\n    if (amdgpu_ttm_tt_get_usermm(bo-&gt;tbo.ttm) ||\n        bo-&gt;flags &amp; AMDGPU_GEM_CREATE_VM_ALWAYS_VALID)\n        return ERR_PTR(-EPERM);\n\n    buf = drm_gem_prime_export(gobj, flags);\n    if (!IS_ERR(buf))\n        buf-&gt;ops = &amp;amdgpu_dmabuf_ops;\n\n    return buf;\n}\n</code></pre> <pre><code>const struct dma_buf_ops amdgpu_dmabuf_ops = {\n\u00a0 \u00a0 .attach = amdgpu_dma_buf_attach,\n\u00a0 \u00a0 .pin = amdgpu_dma_buf_pin,\n\u00a0 \u00a0 .unpin = amdgpu_dma_buf_unpin,\n\u00a0 \u00a0 .map_dma_buf = amdgpu_dma_buf_map,\n\u00a0 \u00a0 .unmap_dma_buf = amdgpu_dma_buf_unmap,\n\u00a0 \u00a0 .release = drm_gem_dmabuf_release,\n\u00a0 \u00a0 .begin_cpu_access = amdgpu_dma_buf_begin_cpu_access,\n\u00a0 \u00a0 .mmap = drm_gem_dmabuf_mmap,\n\u00a0 \u00a0 .vmap = drm_gem_dmabuf_vmap,\n\u00a0 \u00a0 .vunmap = drm_gem_dmabuf_vunmap,\n};\n</code></pre></p> <p><pre><code>amdgpu_dma_buf_attach()\n\u00a0 \u00a0 if (pci_p2pdma_distance(adev-&gt;pdev, attach-&gt;dev, false) &lt; 0)\n\u00a0 \u00a0 \u00a0 \u00a0 attach-&gt;peer2peer = false;\n</code></pre> amdgpu\u5728dma-buf\u7684attachment\u52a0\u5165\u4e86\u4e00\u4e2a\u51fd\u6570\u6307\u9488dma_buf_attach_ops\uff0c\u5728\u8c03\u7528dma_buf_move_notify\u65f6\u56de\u8c03\u8be5ops\u51fd\u6570\uff0c\u4ee5\u8c03\u7528amdgpu_dma_buf_move_notify() <pre><code>struct dma_buf_attachment *\ndma_buf_dynamic_attach(struct dma_buf *dmabuf, struct device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0const struct dma_buf_attach_ops *importer_ops, void *importer_priv)\n</code></pre></p> <pre><code>void dma_buf_move_notify(struct dma_buf *dmabuf)\n{\n    struct dma_buf_attachment *attach;\n\n    dma_resv_assert_held(dmabuf-&gt;resv);\n\n    list_for_each_entry(attach, &amp;dmabuf-&gt;attachments, node)\n        if (attach-&gt;importer_ops)\n            attach-&gt;importer_ops-&gt;move_notify(attach);\n}\nEXPORT_SYMBOL_NS_GPL(dma_buf_move_notify, DMA_BUF);\n</code></pre> <p>dma_buf_move_notify \u901a\u77e5\u6240\u6709attachments\uff0cdmabuf\u5df2\u7ecf\u88ab\u79fb\u52a8\uff0c\u9700\u8981\u9500\u6bc1\u6216\u8005\u91cd\u65b0\u521b\u5efa\u6620\u5c04 amdgpu_bo_move_notify -&gt; dma_buf_move_notify</p>"},{"location":"Linux/dma-buf/#dma-fence","title":"DMA Fence","text":"<p>DMA fence, \u7531struct dma_fence \u8868\u793a\uff0c\u662f\u7528\u4e8eDMA\u64cd\u4f5c\u7684\u5185\u6838\u5185\u90e8\u540c\u6b65\u539f\u8bed\uff0c\u4f8b\u5982GPU\u6e32\u67d3\uff0c \u89c6\u9891\u7f16\u89e3\u7801\u6216\u5728\u5c4f\u5e55\u4e0a\u663e\u793a\u7f13\u51b2\u533a\u3002 Fence\u901a\u8fc7dma_fence_init()\u8fdb\u884c\u521d\u59cb\u5316\uff0c\u5e76\u901a\u8fc7dam_fence_signal()\u8fdb\u884c\u5b8c\u6210\u3002Fence\u4e0e\u4e0a\u4e0b\u6587\u76f8\u5173\u8054\uff0c\u901a\u8fc7<code>dma_fence_context_alloc()</code>\u5206\u914d,\u540c\u4e00\u4e0a\u4e0b\u6587\u4e2d\u7684\u6240\u6709Fence\u90fd\u662f\u5b8c\u5168\u6709\u5e8f\u7684\u3002 \u7531\u4e8eFence\u7684\u76ee\u7684\u662f\u4fc3\u8fdb\u8de8\u8bbe\u5907\u548c\u8de8\u5e94\u7528\u7a0b\u5e8f\u7684\u540c\u6b65\uff0c\u6709\u591a\u79cd\u4f7f\u7528\u65b9\u5f0f: - \u53ef\u4ee5\u5c06\u5355\u4e2aFence\u516c\u5f00\u4e3async_file\uff0c\u4ece\u7528\u6237\u7a7a\u95f4\u4f5c\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\u8bbf\u95ee\uff0c\u901a\u8fc7\u8c03\u7528sync_file_create()\u521b\u5efa\u3002\u8fd9\u79f0\u4e3a\u663e\u793aFence, \u7528\u6237\u7a7a\u95f4\u4f20\u9012\u663e\u793a\u540c\u6b65\u70b9\u3002 - \u4e00\u4e9b\u5b50\u7cfb\u7edf\u8fd8\u5177\u6709\u81ea\u5df1\u7684\u663e\u793aFence \u539f\u8bed\uff0c\u5982drm_syncobj\u3002 \u4e0esync_file\u76f8\u6bd4\uff0cdrm_syncobj\u5141\u8bb8\u66f4\u65b0\u5e95\u5c42\u6805\u680f\u3002 - \u8fd8\u6709\u9690\u5f0f\u6805\u680f\uff0c\u5176\u4e2d\u540c\u6b65\u70b9\u4f5c\u4e3a\u5171\u4eab\u7684<code>dma_buf</code>\u5b9e\u4f8b\u7684\u4e00\u90e8\u5206\u9690\u5f0f\u4f20\u9012\u3002\u8fd9\u79cd\u9690\u5f0f\u6805\u680f\u5b58\u50a8\u5728\u901a\u8fc7<code>dma_buf.resv</code>\u6307\u9488\u7684<code>struct dma_resv</code>\u4e2d.</p>"},{"location":"Linux/dma-buf/#dma-resv-reservation-objects","title":"DMA RESV (Reservation Objects)","text":"<p>amdgpu_gem_object_create     amdgpu_bo_create() -&gt; drm_gem_private_object_init() -&gt; dma_resv_init(&amp;obj-&gt;_resv);     (*obj)-&gt;funcs = &amp;amdgpu_gem_object_funcs | .export = amdgpu_gem_prime_export</p> <p>\u8003\u8651\u5982\u4e0b\u573a\u666f \u4e00\u4e2admabuf\uff0c\u5148\u7531GPU\u5b8c\u6210\u6e32\u67d3\uff0c\u7136\u540e\u518d\u4ea4\u7ed9DRM\u8fdb\u884c\u663e\u793a\u8f93\u51fa\u3002\u90a3\u4e48GPU\u6e32\u67d3\u5b8c\u6210\u540e\uff0c\u5982\u4f55\u901a\u77e5DRM\u8fdb\u884c\u663e\u793a\u8f93\u51fa\u5462\uff1f\u4e5f\u5c31\u662fGPU\u548cDRM\u4e4b\u95f4\u5982\u4f55\u8fdb\u884c\u540c\u6b65?\u8fd9\u5c31\u9700\u8981\u5f15\u5165fence\u7528\u4e8e\u8bbe\u5907\u95f4\u7684\u540c\u6b65\uff0cfence\u7528\u4e8e\u8868\u793a\u4e00\u4e2a\u64cd\u4f5c\u7684\u5b8c\u6210\u72b6\u6001\uff0c\u6545fence\u6709\u4e24\u4e2a\u72b6\u6001\uff0cnot done\u548cdone\u3002 \u9996\u5148GPU\u5728\u5f00\u59cb\u6e32\u67d3\u64cd\u4f5c\u524d\uff0c\u521b\u5efa\u4e00\u4e2afence\uff0c\u6ce8\u518c\u56de\u8c03\u51fd\u6570\uff0c\u5c06fence\u6dfb\u52a0\u5230dmabuf\u4e2d\uff0c\u968f\u540eDRM\u7b49\u5f85\u8be5fence done\u3002\u5f53GPU\u6e32\u67d3\u5b8c\u6210\u4e2d\u65ad\u4e0a\u6765\u540e\uff0c\u4f1a\u901a\u77e5fence done\u3002\u968f\u540eDRM\u7ebf\u7a0b\u88ab\u5524\u9192\uff0c\u8fdb\u884c\u663e\u793a\u64cd\u4f5c\u3002 \u53e6\u5916\uff0cdma fence\u8fd8\u9700\u8981\u8003\u8651\u591a\u8bbe\u5907\u8bbf\u95ee\u7684\u60c5\u51b5\uff0c\u5373\u6709\u53ef\u80fd\u6709\u591a\u4e2a\u8bbe\u5907\u5728\u7b49\u5f85fence\u5b8c\u6210\uff0c\u90a3\u4e48fence\u5c31\u5fc5\u987b\u652f\u6301\u591a\u4e2a\u8bbe\u5907\u7684\u7b49\u5f85\u3002</p> <p>\u4e3e\u4f8b\u8bf4\u660e\uff0cGPU\u7ebf\u7a0b\u4f1a\u5728\u64cd\u4f5cdmabuf\u524d\uff0c\u521b\u5efafence\uff0c\u5e76\u7b49\u5f85fence\u5b8c\u6210\uff0c\u540c\u65f6DRM\u4e5f\u4f1a\u7b49\u5f85\u8be5fence\u5b8c\u6210\u3002\u5f53GPU\u6e32\u67d3\u5b8c\u6210\u4e2d\u65ad\u4ea7\u751f\u540e\uff0c\u4f1a\u8c03\u7528fence done\uff0c\u4f9d\u6b21\u5524\u9192GPU DRM\u7ebf\u7a0b\uff0cGPU\u7ebf\u7a0b\u53ef\u4ee5\u7ee7\u7eed\u4e0b\u4e00\u5e27\u56fe\u50cf\u7684\u6e32\u67d3\uff0c\u800cDRM\u5c31\u53ef\u4ee5\u5c06\u5df2\u7ecf\u5b8c\u6210\u6e32\u67d3\u7684\u56fe\u50cf\u663e\u793a\u5230\u5c4f\u5e55\u3002 \u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\u8c03\u7528\u7684\u63a5\u53e3\u6709: 1. dma_fence_init(): \u521d\u59cb\u5316\u4e00\u4e2adma_fence\u5bf9\u8c61 2. dma_resv_reserve_shared(): \u4ecedma resv \u4e2d\u4fdd\u7559\u4e00\u4e2ashare fence\u6307\u9488 3. dma_resv_add_shared_fence(): \u5c06dma fence\u6dfb\u52a0\u5230resv\u5bf9\u8c61 4. dma_fence_default_wait(): \u5411dma fence\u6ce8\u518c\u56de\u8c03\u51fd\u6570dma_fence_default_wait_cb, \u5e76\u7761\u7720\u7b49\u5f85dma fence\u5b8c\u6210 5. dma_fence_signal(): \u6807\u5fd7dma fence\u5b8c\u6210\uff0c\u5e76\u56de\u8c03dma fence\u4e2d\u7684\u6240\u6709\u56de\u8c03\u51fd\u6570 \u5176\u4e2d\u6709\u4e00\u4e2adma_resv\u5bf9\u8c61\uff0c\u7b80\u5355\u6765\u8bf4dma_resv\u662f\u4e00\u4e2a\u5b58\u653edma_fence\u7684\u5730\u65b9\uff0c\u4e00\u4e2admabuf\u53ef\u80fd\u540c\u65f6\u6709\u82e5\u5e72\u4e2adma fence\uff0c\u4e14dma fence\u8fd8\u6709\u5171\u4eab\u548c\u72ec\u5360\u4e24\u79cd\u3002dma_resv\u53ef\u4ee5\u7406\u89e3\u4e3a\u4e00\u5757\u5185\u5b58\u533a\u57df\uff0c\u4e13\u95e8\u5b58\u653edma fence\uff0c\u6545\u8981\u5c06dma fence\u6dfb\u52a0\u5230dmabuf\u65f6\uff0c\u8981\u5148\u8c03\u7528dma_resv_reserve_shared()\u9884\u7559\u51fadma fence\u7684\u4f4d\u7f6e\uff0c\u7136\u540e\u518d\u8c03\u7528dma_resv_add_shared_fence()\u6dfb\u52a0\u5230dma resv\u3002</p>"},{"location":"Linux/dma-buf/#dma-fence_1","title":"DMA Fence\u4f5c\u7528","text":"<p>fence \u540c\u6b65\u673a\u5236\u53ef\u4ee5\u786e\u4fdd buffer \u5728\u5171\u4eab\u8fc7\u7a0b\u4e2d\uff0c\u9a71\u52a8\u7a0b\u5e8f\u6216\u7528\u6237\u7a7a\u95f4\u4e0d\u4f1a\u5bf9\u4e00\u4e2a\u6b63\u5728\u88ab\u5199\u5165\u7684 buffer \u8fdb\u884c\u8bfb\u64cd\u4f5c\uff0c\u6216\u5bf9\u4e00\u4e2a\u4ecd\u5728\u88ab\u5176\u4ed6\u6a21\u5757\u4f7f\u7528\u7684 buffer \u8fdb\u884c\u5199\u64cd\u4f5c\u3002fence \u786e\u4fdd\u4e86\u8fd9\u4e9b\u64cd\u4f5c\u80fd\u591f\u6709\u5e8f\u8fdb\u884c\uff0c\u5373\u53ea\u4f1a\u5728 buffer \u4e0d\u88ab\u4f7f\u7528\u65f6\u624d\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u3002\u4f8b\u5982\uff0c\u5f53\u4e00\u4e2aGPU\u7684job\u88ab\u585e\u8fdb\u961f\u5217\u65f6\uff0c\u8be5job\u4e2d\u7684buffer\u4f1a\u88ab\u5173\u8054\u4e0a\u4e00\u4e2afence\uff0c\u5176\u4ed6\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4ee5\u501f\u52a9\u8be5fence\u6765\u8fdb\u884c\u540c\u6b65\u3002\u5728\u6536\u5230\u8be5fence\u7684\u4fe1\u53f7\u4e4b\u524d\uff0c\u8fd9\u4e9b\u9a71\u52a8\u7a0b\u5e8f\u4e0d\u4f1a\u5bf9\u8be5buffer\u8fdb\u884c\u4efb\u4f55\u64cd\u4f5c\uff0cfence signal\u8868\u660e\u8be5buffer\u53ef\u4ee5\u88ab\u6b63\u5e38\u4f7f\u7528\u4e86\u3002\u540c\u6837\u5730\uff0c\u4e3a\u4e86\u8ba9GPU\u9a71\u52a8\u80fd\u7b49\u5f85buffer\u4ece\u663e\u793a\u5c4f\u4e2d\u5207\u6362\u51fa\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed9\u663e\u793a\u9a71\u52a8\u91c7\u7528\u76f8\u540c\u7684fence\u673a\u5236\uff0c\u4ee5\u4fbfGPU\u80fd\u518d\u6b21\u4f7f\u7528\u8fd9\u4e9bbuffer\u8fdb\u884c\u6e32\u67d3\u3002 fence\u65f6\u8be5\u673a\u5236\u7684\u6838\u5fc3\u5143\u7d20\uff0c\u6bcf\u5f53\u5411kernel\u53d1\u9001buffer\u76f8\u5173\u7684\u8bf7\u6c42\u65f6\uff0c\u8be5buffer\u90fd\u4f1a\u9644\u5e26\u4e00\u4e2afence\u3002\u7528\u6237\u7a7a\u95f4\u6216\u8005\u5176\u4ed6\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528fence\u6765\u7b49\u5f85\u786c\u4ef6\u5de5\u4f5c\u5b8c\u6210\u3002\u56e0\u6b64\u4e00\u65e6\u5de5\u4f5c\u5b8c\u6210\uff0c\u8be5fence\u5c31\u4f1a\u88absignal\uff0c\u7b49\u5f85\u8be5fence\u7684\u6a21\u5757\u4e5f\u5c31\u53ef\u4ee5\u7ee7\u7eed\u5bf9\u8be5buffer\u8fdb\u884c\u4ed6\u4eec\u60f3\u8981\u7684\u64cd\u4f5c\u4e86\u3002</p> <p>\u867d\u7136implicit Fence\u5728buffer\u540c\u6b65\u65b9\u9762\u8d77\u4e86\u5f88\u5927\u4f5c\u7528\uff0c\u4f46\u5728\u67d0\u4e9b\u60c5\u51b5\u4e0b\uff0c\u6574\u4e2a\u684c\u9762\u7684\u5408\u6210\u53ef\u80fd\u4f1a\u88ab\u5361\u4f4f\u3002\u60f3\u8c61\u4e00\u4e0b\u4e0b\u9762\u7684\u5408\u6210\u8fc7\u7a0b\uff1a\u6709ABC\u4e09\u4e2abuffer\u9700\u8981\u5904\u7406\uff0cA\u548cB\u88abGPU\u62ff\u53bb\u540c\u65f6\u505a\u6e32\u67d3\uff0c\u800cC\u5c06\u4f5c\u4e3aA\u4e0eB\u5408\u6210\u7684\u7ed3\u679c\u62ff\u53bb\u663e\u793a\u3002\u4f46\u53ea\u6709\u5728AB\u8fd9\u4e24\u4e2abuffer\u90fd\u6e32\u67d3\u5b8c\u6210\u65f6\u624d\u4f1a\u901a\u77e5compositor\u505a\u5408\u6210\uff0c\u56e0\u6b64\u5982\u679cB\u7684\u6e32\u67d3\u65f6\u95f4\u592a\u957f\uff0c\u5c06\u5bfc\u81f4\u6574\u4e2a\u684c\u9762\u7684\u5408\u6210\u56e0\u4e3a\u9700\u8981\u7b49\u5f85B\u800c\u88abblock\u4f4f\uff0c\u4e8e\u662fC\u5c31\u65e0\u6cd5\u53ca\u65f6\u7684\u663e\u793a\u51fa\u6765\u3002</p>"},{"location":"Linux/dma-buf/#sync-file","title":"sync file","text":"<p>DRM\u5b9e\u73b0Explicit Fence\u9700\u8981\u5efa\u7acb\u5728\u4e24\u4e2akernel\u57fa\u7840\u6846\u67b6\u4e4b\u4e0a: <code>struct dma_fence</code> -- \u8be5\u7ed3\u6784\u4f53\u8868\u793afence\uff0c\u548c<code>struct sync_file</code> -- \u7528\u6765\u63d0\u4f9b\u4e0e\u7528\u6237\u7a7a\u95f4\u5171\u4eab\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26. \u5728\u4f7f\u7528fence\u65f6\uff0cdispaly\u5e95\u5c42\u9a71\u52a8\u9700\u8981\u7b49\u5f85\u8be5fence\u53d1\u51fa\u4fe1\u53f7\u540e\uff0c\u624d\u80fd\u5728\u5c4f\u5e55\u4e0a\u663e\u793a\u8be5buffer\u3002\u5728Explicit Fence\u7684\u5b9e\u73b0\u4e2d\uff0cfence\u4ece\u7528\u6237\u7a7a\u95f4\u53d1\u9001\u7ed9\u5185\u6838\u7a7a\u95f4\uff0cdisplay\u5e95\u5c42\u9a71\u52a8\u540c\u6837\u4f1a\u7ed9\u7528\u6237\u7a7a\u95f4\u8fd4\u56de\u4e00\u4e2a\u65b0\u7684fence\uff0c\u8be5fence\u88ab\u5c01\u88c5\u5728sync_file\u7ed3\u6784\u4f53\u4e2d\uff0c\u5f53\u8be5buffer\u88ab\u663e\u793a\u5230\u5c4f\u5e55\u4e0a\u65f6\uff0c\u5b83\u6240\u5bf9\u5e94\u7684fence\u5c31\u4f1a\u88absignal\u3002\u540c\u6837\u7684\uff0c\u5728\u6e32\u67d3\u6d4b\u4e5f\u91c7\u7528\u76f8\u540c\u7684\u7b49\u5f85\u6d41\u7a0b\u3002 \u5fc5\u987b\u4f7f\u7528atomic modesetting\u3002\u6211\u4eec\u4e0d\u6253\u7b97\u652f\u6301legacy API\u3002 DRM\u8981\u7b49\u5f85fence\u9700\u8981\u901a\u8fc7\u6bcf\u4e2aDRM plane</p>"},{"location":"Linux/linux%20modules%20%E7%BC%96%E8%AF%91/","title":"Linux modules \u7f16\u8bd1","text":"<p>\u53ea\u7f16\u8bd1\u5355\u4e2a\u6a21\u5757 make modules_prepare \u8fd9\u5c06\u51c6\u5907\u6a21\u5757\u7f16\u8bd1\u73af\u5883\u5e76\u751f\u6210<code>Module.symvers</code>\u6587\u4ef6 make -j32 M=drivers/gpu/drm/amd/amdgpu modules</p> <p>\u4fdd\u7559\u6c47\u7f16\u6587\u4ef6 make -j32 M=drivers/gpu/drm/amd/amdgpu KCFLAGS=\"-S\" modules</p> <p>git log -L '/^int drm_prime_fd_to_handle_ioctl(/',/^}/:drivers/gpu/drm/drm_prime.c</p>"},{"location":"Linux/shell/","title":"Shell","text":"<p>makefile\u4e2d\u4f7f\u7528 <pre><code>define KCL_MACRO_CHECK_COMMAND \u00a0\n$(shell if ! [ -f $(config-file) ] || grep -q \"#define $(1)\" $(config-file) ; \\\n\u00a0 \u00a0 then echo \"Error: Symbol $(1) is found in $(config-file)\"; fi)\nendef\n</code></pre> \u7531\u4e8e\u6362\u884c\u7b26 <code>\\</code> \u540e\u8ddf\u6709\u7a7a\u683c\u5bfc\u81f4\u7f16\u8bd1\u9519\u8bef\uff0c\u63a8\u6d4bshell\u6709\u5f3a\u683c\u5f0f\u8981\u6c42</p>"},{"location":"Linux/%E5%86%85%E6%A0%B8pcie%E8%AE%BE%E5%A4%87%E5%87%BD%E6%95%B0/","title":"\u5185\u6838pcie\u8bbe\u5907\u51fd\u6570","text":"<p>pci_resource_start\u662f\u4e00\u4e2a\u5728linux\u5185\u6838\u4e2d\u83b7\u53d6PCI\u8bbe\u5907\u8d44\u6e90\u8d77\u59cb\u5730\u5740\u7684\u51fd\u6570\u3002\u8fd9\u4e2a\u51fd\u6570\u5c5e\u4e8epci_dev\u7ed3\u6784\u4f53\u7684resource\u6570\u7ec4\u7684\u6210\u5458\uff0c\u8be5\u6570\u7ec4\u4fdd\u5b58\u4e86PCI\u8bbe\u5907\u7684\u5404\u79cd\u8d44\u6e90\u7684\u4fe1\u606f\u3002 \u5728bios\u542f\u52a8\u65f6\uff0c\u4f1a\u8bfb\u53d6pci\u914d\u7f6e\u7a7a\u95f4\u4ece\u800c\u5c06\u8bbe\u5907\u5185\u5b58\u6620\u5c04\u5230\u7cfb\u7edf\u7269\u7406\u7a7a\u95f4\u4e2d\u7684 memory space \u6216\u8005 io space\uff0c <pre><code>resource_size_t pci_resource_start(struct pci_dev *dev, int bar);\n</code></pre> \u5176\u4e2d\uff0cdev\u662f\u6307\u5411PCI\u8bbe\u5907\u7ed3\u6784\u4f53\u7684\u6307\u9488\uff0c bar\u662fBAR\u7684\u7f16\u53f7(\u901a\u5e38\u4e3a0\u52305). \u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0c<code>pci_resource_start</code> \u8fd4\u56de\u7684\u662fPCI\u8bbe\u5907\u5728\u7269\u7406\u5185\u5b58\u6216I/O \u7aef\u53e3\u7a7a\u95f4\u4e2d\u7684\u5730\u5740\uff0c\u800c\u4e0d\u662fCPU\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u7684\u865a\u62df\u5730\u5740\u3002\u5982\u679c\u9a71\u52a8\u7a0b\u5e8f\u9700\u8981\u8bbf\u95ee\uff0c\u8fd8\u9700\u8981\u4f7f\u7528 <code>ioremap</code> \u51fd\u6570. \u6b64\u5916\uff0c<code>pci_resource_start</code> \u51fd\u6570\u8fd4\u56de\u7684\u5730\u5740\u662fPCI\u603b\u7ebf\u57df\u7684\u5730\u5740\uff0c\u800c\u4e0d\u662f\u5728CPU\u7684\u5b58\u50a8\u5668\u57df\u5730\u5740\u3002\u56e0\u6b64\u5728\u5c06\u8fd9\u4e2a\u5730\u5740\u63d0\u4f9b\u7ed9\u7528\u6237\u7a7a\u95f4\u8fdb\u884c\u8bbf\u95ee\u7684\u65f6\u5019\uff0c\u8fd8\u9700\u8981\u8fdb\u884c\u5730\u5740\u7a7a\u95f4\u7684\u8f6c\u6362\u3002<code>\u901a\u5e38\u4f7f\u7528pci_resource_to_user</code> \u6765\u5b8c\u6210\uff0c</p> <p><pre><code>int pci_resource_to_user(struct pci_dev *dev, int bar, struct resource *rsrc, resource_size_t *user_base, resource_size_t *user_length);\n</code></pre> \u4f7f\u7528<code>pci_resource_to_user</code>\u51fd\u6570\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u51e0\u70b9\uff1a 1. <code>pci_resource_to_user</code>\u51fd\u6570\u7528\u4e8e\u5c06PCI\u8bbe\u5907\u7684\u8d44\u6e90\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4\uff0c\u4ee5\u4fbf\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u53ef\u4ee5\u76f4\u63a5\u8bbf\u95ee\u8bbe\u5907\u7684\u5bc4\u5b58\u5668\u6216\u7f13\u51b2\u533a\u3002 2. \u5728\u8c03\u7528<code>pci_resource_to_user</code>\u51fd\u6570\u4e4b\u524d\uff0c\u9700\u8981\u5148\u8c03\u7528<code>pci_request_regions</code>\u51fd\u6570\u6765\u8bf7\u6c42PCI\u8bbe\u5907\u7684\u8d44\u6e90\u3002 3. <code>bar</code>\u53c2\u6570\u6307\u5b9a\u8981\u6620\u5c04\u7684\u57fa\u5740\u5bc4\u5b58\u5668\uff08BAR\uff09\u7d22\u5f15\u3002BAR\u662fPCI\u8bbe\u5907\u4e2d\u7528\u4e8e\u6307\u5b9a\u8bbe\u5907\u5728\u7cfb\u7edf\u5185\u5b58\u4e2d\u7684\u5730\u5740\u8303\u56f4\u7684\u5bc4\u5b58\u5668\u3002 4. <code>rsrc</code>\u53c2\u6570\u7528\u4e8e\u5b58\u50a8\u6620\u5c04\u540e\u7684\u8d44\u6e90\u4fe1\u606f\uff0c\u5305\u62ec\u7269\u7406\u5730\u5740\u3001\u957f\u5ea6\u7b49\u3002 5. <code>user_base</code>\u548c<code>user_length</code>\u53c2\u6570\u7528\u4e8e\u5b58\u50a8\u6620\u5c04\u540e\u7684\u7528\u6237\u7a7a\u95f4\u57fa\u5740\u548c\u957f\u5ea6\u3002 6. \u5728\u4f7f\u7528\u5b8c\u6620\u5c04\u7684\u8d44\u6e90\u540e\uff0c\u5e94\u8be5\u8c03\u7528<code>pci_release_regions</code>\u51fd\u6570\u91ca\u653ePCI\u8bbe\u5907\u7684\u8d44\u6e90\u3002</p>"},{"location":"Linux/%E7%BB%88%E7%AB%AF%E5%BF%AB%E6%8D%B7%E9%94%AE/","title":"\u7ec8\u7aef\u5feb\u6377\u952e","text":"\u5feb\u6377\u952e \u529f\u80fd\u63cf\u8ff0 <code>Ctrl + A</code> \u5149\u6807\u5feb\u901f\u8df3\u81f3\u884c\u9996\u3002 <code>Ctrl + E</code> \u5149\u6807\u5feb\u901f\u8df3\u81f3\u884c\u5c3e\u3002 <code>Ctrl + U</code> \u5220\u9664\u5149\u6807\u81f3\u884c\u9996\u7684\u6240\u6709\u5185\u5bb9\u3002 <code>Ctrl + K</code> \u5220\u9664\u5149\u6807\u81f3\u884c\u5c3e\u7684\u6240\u6709\u5185\u5bb9\u3002 <code>Ctrl + W</code> \u5220\u9664\u5149\u6807\u524d\u7684\u4e00\u4e2a\u5355\u8bcd\u3002 <code>Ctrl + L</code> \u6e05\u7a7a\u6574\u4e2a\u7ec8\u7aef\u5c4f\u5e55\u3002 <code>Ctrl + C</code> \u505c\u6b62\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\u6216\u547d\u4ee4\u3002 <code>Ctrl + D</code> \u6ce8\u9500\u6216\u9000\u51fa\u7ec8\u7aef\u3002 <code>Ctrl + Z</code> \u6682\u505c\u6b63\u5728\u6267\u884c\u7684\u8fdb\u7a0b\uff08\u4e4b\u540e\u53ef\u6062\u590d\u6267\u884c\uff09\u3002 <code>Ctrl + R</code> \u5728\u547d\u4ee4\u5386\u53f2\u4e2d\u8fdb\u884c\u9006\u5411\u641c\u7d22\u3002 \u4e0a\u7bad\u5934\u00a0<code>\u2191</code> \u4ece\u547d\u4ee4\u5386\u53f2\u4e2d\u663e\u793a\u5148\u524d\u7684\u547d\u4ee4\u3002 \u4e0b\u7bad\u5934\u00a0<code>\u2193</code> \u4ece\u547d\u4ee4\u5386\u53f2\u4e2d\u663e\u793a\u540e\u7eed\u7684\u547d\u4ee4\u3002 <code>!!</code> \u91cd\u590d\u6267\u884c\u6700\u8fd1\u7684\u547d\u4ee4\u3002 <code>!n</code> \u91cd\u590d\u6267\u884c\u547d\u4ee4\u5386\u53f2\u4e2d\u7684\u7b2c n \u6761\u547d\u4ee4\u3002 <code>Tab</code> \u81ea\u52a8\u8865\u5168\u547d\u4ee4\uff0c\u6587\u4ef6\u540d\u6216\u76ee\u5f55\u540d\u3002 \u8fde\u7eed\u6309\u00a0<code>Tab</code>\u00a0\u4e24\u6b21 \u5217\u51fa\u6240\u6709\u53ef\u80fd\u7684\u8865\u5168\u9009\u9879\u3002 <code>Ctrl + Shift + C</code> \u590d\u5236\u6240\u9009\u6587\u672c\u6216\u547d\u4ee4\u3002 <code>Ctrl + Shift + V</code> \u7c98\u8d34\u5df2\u590d\u5236\u7684\u6587\u672c\u6216\u547d\u4ee4\u3002 <code>Ctrl + Shift + N</code> \u6253\u5f00\u65b0\u7684\u7ec8\u7aef\u7a97\u53e3\u3002 <code>Ctrl + Shift + T</code> \u5728\u5f53\u524d\u7ec8\u7aef\u4e2d\u6253\u5f00\u65b0\u7684\u9009\u9879\u5361\u3002 <code>Ctrl + Tab</code>\u00a0\u6216\u00a0<code>Ctrl + PageDown</code> \u5728\u7ec8\u7aef\u7684\u9009\u9879\u5361\u4e4b\u95f4\u5207\u6362"},{"location":"Linux/DRM/0.%20drm-intro/","title":"0. drm intro","text":"<p>\u63a5\u89e6linux\u684c\u9762\u6bd4\u8f83\u591a\u7684\u4eba\u4e00\u5b9a\u4f1a\u5bf9DRM\u8fd9\u4e2a\u540d\u5b57\u6bd4\u8f83\u719f\u6089\u3002\u7f51\u4e0a\u4e5f\u6709\u5927\u628a\u8d44\u6599\u5728\u89e3\u91caDRM\u5230\u5e95\u662f\u4ec0\u4e48\u3002DRM\u4e3b\u8981\u5206\u4e3aKMS\u4e0eRender\u4e24\u5927\u90e8\u5206\uff0c\u672c\u6587\u5b9e\u8d28\u4e0a\u662f\u5728\u5206\u6790DRM\u4e2dKMS\u76f8\u5173\u7684\u6846\u67b6\u5b9e\u73b0\u3002\u800cRender\u76f8\u5173\u7684API\u662f\u7279\u5b9a\u4e8e\u9a71\u52a8\u7684\uff0c\u5185\u6838\u5e76\u4e0d\u4e3a\u7528\u6237\u6001\u63d0\u4f9b\u4e00\u4e2a\u901a\u7528\u7684IOCTL\u63a5\u53e3\u3002\u5982\u679c\u540e\u7eed\u65f6\u95f4\u5145\u8db3\uff0c\u6211\u5c06\u4f1a\u5206\u6790\u4e00\u4e0bVC4\u7684Render API\uff0c\u4ee5\u53ca\u76f8\u5e94\u7684\u7528\u6237\u6001\u5b9e\u73b0\u3002\u4ece\u529f\u80fd\u4e0a\u8bb2\uff0cKMS\u8d1f\u8d23\u642d\u5efa\u663e\u793a\u63a7\u5236\u5668\u7684pipeline\uff0c\u5e76\u63a7\u5236\u663e\u793a\u786c\u4ef6\u5c06\u56fe\u50cf\u7f13\u51b2\u533ascanout\u5230\u5c4f\u5e55\u4e0a\uff0c\u800c\u5982\u4f55\u52a0\u901f\u751f\u6210framebuffer\u4e2d\u7684\u5185\u5bb9\u5219\u662f3D\u5f15\u64ce\uff08\u5373Render API\uff09\u8d1f\u8d23\u7684\u4e8b\u60c5\u3002</p> <p>\u5bf9\u4e8eKMS\uff0c\u6709\u5982\u4e0b\u8981\u7d20\uff1a</p> <ul> <li>\u663e\u5b58\u7ba1\u7406\u5668</li> <li>modesetting API</li> <li>\u663e\u793aAPI</li> </ul> <p>\u5728\u7814\u7a76\u521d\u671f\uff0c\u7814\u7a76\u6848\u4f8b\u6700\u597d\u786c\u4ef6\u65e0\u5173\uff0c\u4e14\u6bd4\u8f83\u5bb9\u6613\u61c2\u539f\u7406\uff0c\u4e14\u80fd\u591f\u6b63\u5e38\u8fd0\u884c\uff0c\u53ef\u4ee5\u53c2\u8003virtio-gpu\u548cQXL\u865a\u62df\u663e\u5361\u3002\u7b49\u5230\u5bf9\u5185\u6838DRM\u5b50\u7cfb\u7edf\u6709\u4e00\u5b9a\u7684\u7406\u89e3\u540e\uff0c\u53ef\u4ee5\u5206\u6790\u7b80\u5355\u7684\u663e\u5361\u786c\u4ef6\uff0c\u5982VC4\uff08\u6811\u8393\u6d3e3B\u7684\u663e\u5361\uff09\u3002</p>"},{"location":"Linux/DRM/0.%20drm-intro/#_1","title":"\u9605\u8bfb\u8def\u5f84","text":"<p>\u9700\u8981\u770b\u7684\u4e1c\u897f\u6709\u70b9\u591a\uff0c\u751a\u81f3\u8bf4\u6bd4\u8f83\u4e71\u3002\u5148\u5217\u4e3e\u4e00\u4e0b\uff1a</p> <p>\u5185\u6838\u4e2d\u7684\u5185\u5bb9\uff1a</p> <ul> <li>DRM\u9a71\u52a8\u901a\u7528\u4ee3\u7801\uff1a\u5305\u62ecGEM\uff0cKMS</li> <li>AMD\u663e\u5361\u76f8\u5173\u7684\u4ee3\u7801\uff1aAMDGPU\uff0cRADEON\uff0cAMDKFD\uff08\u901a\u7528\u8ba1\u7b97ROCM\u6846\u67b6\u5185\u6838\u9a71\u52a8\uff09</li> </ul> <p>\u7528\u6237\u6001\u4ee3\u7801\uff1a</p> <ul> <li>MESA\uff1a OpenGL state tracker\uff0c gallium 3D\uff0c vulkan\uff0c egl\uff08\u91cd\u70b9\uff09\uff0cgbm</li> <li>libdrm\uff1a\u57fa\u672c\u4e3a\u5185\u6838\u63d0\u4f9b\u7684IOCTL\u7684wrapper</li> </ul> <p>\u6211\u60f3\u8981\u91cd\u70b9\u7406\u89e3\u7684\u90e8\u5206\uff1a</p> <ul> <li>context\u5230\u5e95\u662f\u4ec0\u4e48\uff1f\u5982OpenGL\u548cegl\u521b\u5efa\u7684context</li> <li>mesa\u7684\u67b6\u6784</li> <li>wayland\u6e32\u67d3\u7684\u57fa\u672c\u539f\u7406</li> <li>DRI\u5230\u5e95\u7531\u4ec0\u4e48\u6784\u6210</li> </ul> <p>\u8fd9\u91cc\u6211\u89c9\u5f97\u8fd8\u662f\u5148\u4eceMESA\u8fd9\u91cc\u7740\u624b\uff0c\u6bd5\u7adf\u5185\u6838\u9a71\u52a8\u7f3a\u5c11\u6587\u6863\uff0c\u4e14\u6211\u5bf9\u63a5\u53e3\u5c42\u5230\u5e95\u600e\u4e48\u7528\u8fd8\u662f\u4e0d\u662f\u5f88\u719f\u6089\u3002\u770b\u4e00\u4e0b\u7b80\u5355\u7684DUMB\u9a71\u52a8\u5982\u4f55\u5b9e\u73b0\u4e5f\u662f\u4e00\u4e2a\u7406\u89e3KMS\u6bd4\u8f83\u597d\u7684\u65b9\u6cd5\u3002</p> <p>\u6309\u7167feature\u6765\u6574\u7406 <code>drm_driver.driver_feature = DRIVER_ATOMIC  | DRIVER_GEM | DRIVER_MODESET |  DRIVER_PRIME | DRIVER_RENDER | DRIVER_SYNCOBJ</code></p> <p>[[Overview]] \u6709\u5f88\u591a\u6587\u7ae0\u90fd\u662f\u4ece\u5e94\u7528\u5c42\u81f3\u4e0a\u800c\u4e0b\u7684\u89e3\u6790DRM\uff0c\u6240\u4ee5\u9996\u5148\u8df3\u4e0d\u8fc7\u7684\u5c31\u662fDRIVER_MODESET\u529f\u80fd\uff0cKMS\u8bbe\u7f6e\uff0c\u76f8\u5e94\u7684\u8fd8\u6709\u4e00\u4e9bgithub test code\u6765\u89e3\u91caframe buffer\u7684\u663e\u793a\u8fc7\u7a0b\u3002 [[1.1 drm-kms]] [[1.2 drm-Atomic-KMS]] [[1.3 drm-howto]] [[Mutter\u7a97\u53e3\u7ba1\u7406\u5668\u5b9e\u73b0\u5206\u6790]]</p> <p>\u5176\u6b21\u5e94\u8be5\u5c31\u662f\u663e\u5b58\u7ba1\u7406GEM [[2.1 drm-gem]] [[2.2 drm-gem-prime]] [[2.3 dma-buf]] [[2.5.1 drm-mm]] [[2.5.2 drm-buddy]] [[2.6 ttm_pool]]</p> <p>\u6700\u540e\u662f\u6e32\u67d3\u548c\u8c03\u5ea6 [[3.3 drm-sched]] [[3.2 drm-fence]]</p>"},{"location":"Linux/DRM/1.1%20drm-kms/","title":"1.1 drm kms","text":"<p>KMS\u5168\u79f0\u662f<code>Kernel Mode Setting</code>\uff0c\u8fd9\u91cc\u7684mode\u662f\u6307\u663e\u793a\u63a7\u5236\u5668\u7684mode\uff0c\u8be6\u89c1\u4e0b\u9762\u5bf9<code>drm_mode</code>\u7684\u5206\u6790\u3002\u4e0e<code>KMS</code>\u76f8\u5bf9\u5e94\u7684\u662f<code>User Mode Setting</code>\uff0c\u65e9\u671fUnix\u7684Xorg\u51e0\u4e4e\u5b8c\u6574\u5b9e\u73b0\u4e86\u4e00\u5957\u56fe\u5f62\u6808\uff0c\u6b64\u65f6<code>Mode Setting</code>\u8fd9\u9879\u529f\u80fd\u4e3b\u8981\u662f\u7531\u7528\u6237\u6001\u7684DDX\uff08Device Depedent Driver\uff09\u5b9e\u73b0\u7684\u3002<code>UMS</code>\u7531\u4e8e\u5b58\u5728\u5404\u79cd\u5404\u6837\u7684\u95ee\u9898\uff0c\u5df2\u7ecf\u88ab\u653e\u5f03\uff0c\u76ee\u524d\u4e3b\u6d41\u9a71\u52a8\u5df2\u7ecf\u5728\u591a\u5e74\u4ee5\u524d\u5b8c\u6210\u4e86<code>KMS</code>\u63a5\u53e3\u7684\u8fc1\u79fb\uff0c\u5e76\u5c06<code>Mode Setting</code>\u76f8\u5173\u7684\u5b9e\u73b0\u4ece\u7528\u6237\u6001\u79fb\u52a8\u5230\u4e86\u5185\u6838\u6001\u3002\u672c\u6587\u7740\u91cd\u5206\u6790\u5185\u6838KMS\u76f8\u5173\u529f\u80fd\u7684\u6846\u67b6\u5b9e\u73b0\u3002</p> <p>\u4e8b\u5b9e\u4e0a\uff0c\u663e\u793a\u63a7\u5236\u5668\u7684\u8bbe\u8ba1\u4ece\u6700\u521d\uff08CRT\u663e\u793a\u5668\u65f6\u4ee3\uff09\u5230\u73b0\u5728\uff08LCD\u663e\u793a\u5668\u65f6\u4ee3\uff09\u5e76\u6ca1\u6709\u6839\u672c\u6027\u7684\u53d8\u5316\u3002KMS\u5c06\u6574\u4e2a\u663e\u793a\u63a7\u5236\u5668\u7684\u663e\u793apipeline\u62bd\u8c61\u6210\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a</p> <ul> <li>plane</li> <li>crtc</li> <li>encoder</li> <li>connector</li> </ul> <p>\u5176\u4e2d\u6bcf\u4e00\u4e2a\u90e8\u5206\u7684\u542b\u4e49\u53ef\u4ee5\u53c2\u8003\u5185\u6838\u6587\u6863\uff0c\u8fd9\u91cc\u4e0d\u8d58\u8ff0\uff0c\u8fd9\u91cc\u53ea\u5206\u6790\u5176\u5728\u5185\u6838\u6846\u67b6\u4e2d\u662f\u5982\u4f55\u5b9e\u73b0\u7684\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#_1","title":"\u5bf9\u8c61\u7ba1\u7406","text":"<p>\u5bf9\u4e8e\u8fd9\u51e0\u4e2a\u5bf9\u8c61\uff0cDRM\u6846\u67b6\u5c06\u5176\u79f0\u4f5c\u201c\u5bf9\u8c61\u201d\uff0c\u6709\u4e00\u4e2a\u516c\u5171\u7684\u57fa\u7c7b<code>struct drm_mode_object</code>\uff0c\u8fd9\u4e2a\u51e0\u4e2a\u5bf9\u8c61\u90fd\u7531\u8fd9\u4e2a\u57fa\u7c7b\u6269\u5c55\u800c\u6765\u3002\u4e8b\u5b9e\u4e0a\uff0c\u8fd9\u4e2a\u57fa\u7c7b\u6269\u5c55\u51fa\u6765\u7684\u5b50\u7c7b\u5e76\u4e0d\u662f\u53ea\u6709\u4e0a\u9762\u63d0\u5230\u7684\u51e0\u79cd\u3002</p> <pre><code>struct drm_mode_object {\n  uint32_t id;\n  uint32_t type;\n  struct drm_object_properties *properties;\n  struct kref refcount;\n  void (*free_cb)(struct kref *kref);\n};\n</code></pre> <p>\u5176\u4e2did\u548ctype\u5206\u522b\u4e3a\u8fd9\u4e2a\u5bf9\u8c61\u5728KMS\u5b50\u7cfb\u7edf\u4e2d\u7684ID\u548c\u7c7b\u578b\uff08\u5373\u4e0a\u9762\u63d0\u5230\u7684\u51e0\u79cd\uff09\u3002\u6ce8\u610f\u6240\u6709\u7684<code>drm_mode_object</code>\u7684id\u5171\u7528\u4e00\u4e2anamespace\uff0c\u4fdd\u5b58\u5728<code>drm_device-&gt;mode_config.object_idr</code>\u4e2d\u3002\u56e0\u6b64\uff0c\u6846\u67b6\u63d0\u4f9b\u4e86<code>drm_mode_object_find</code>\u51fd\u6570\u7528\u4e8e\u67e5\u627e\u5bf9\u5e94id\u7684\u5bf9\u8c61\u3002\u5f53\u524dDRM\u6846\u67b6\u4e2d\u5b58\u5728\u5982\u4e0b\u7684\u5bf9\u8c61\u7c7b\u578b\uff1a</p> <pre><code>#define DRM_MODE_OBJECT_CRTC 0xcccccccc\n#define DRM_MODE_OBJECT_CONNECTOR 0xc0c0c0c0\n#define DRM_MODE_OBJECT_ENCODER 0xe0e0e0e0\n#define DRM_MODE_OBJECT_MODE 0xdededede\n#define DRM_MODE_OBJECT_PROPERTY 0xb0b0b0b0\n#define DRM_MODE_OBJECT_FB 0xfbfbfbfb\n#define DRM_MODE_OBJECT_BLOB 0xbbbbbbbb\n#define DRM_MODE_OBJECT_PLANE 0xeeeeeeee\n#define DRM_MODE_OBJECT_ANY 0\n</code></pre> <p>\u4ece<code>drm_mode_object</code>\u7684\u5b9a\u4e49\u4e2d\u5373\u53ef\u53d1\u73b0\u5176\u5b9e\u73b0\u4e86\u4e24\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u529f\u80fd\uff1a</p> <ul> <li>\u5f15\u7528\u8ba1\u6570\u53ca\u751f\u547d\u5468\u671f\u7ba1\u7406</li> <li>\u5c5e\u6027\u7ba1\u7406</li> </ul> <p>\u5c5e\u6027\u5728DRM\u4e2d\u7531<code>struct drm_property</code>\u8868\u793a\uff0c\u5176\u672c\u8d28\u662f\u4e00\u4e2a<code>DRM_MODE_OBJECT_PROPERTY</code>\u7c7b\u578b\u7684<code>drm_mode_object</code>\u3002\u4e00\u4e2a<code>drm_mode_object</code>\u7684\u6240\u6709\u5c5e\u6027\u4fdd\u5b58\u5728\u5176\u5185\u90e8\u7684<code>drm_object_properties</code>\u4e2d\uff0c\u5176\u5b9e\u73b0\u5982\u4e0b\uff1a <pre><code>struct drm_object_properties {\n  int count;\n  struct drm_property *properties[DRM_OBJECT_MAX_PROPERTY];\n  uint64_t values[DRM_OBJECT_MAX_PROPERTY];\n};\n</code></pre> \u53ef\u4ee5\u770b\u5230\u6bcf\u4e00\u4e2a\u5bf9\u8c61\u6700\u591a\u53ef\u4ee5\u670924\u4e2a\u5c5e\u6027\u3002\u8fd9\u91cc\u6ce8\u610f\u4e00\u4e2a\u5b9e\u73b0\u7ec6\u8282\uff0c<code>drm_property</code>\u8868\u793a\u4e00\u4e2a\u5c5e\u6027\u5bf9\u8c61\uff0c\u63cf\u8ff0\u5c5e\u6027\u7684\u7c7b\u578b\uff08\u5982\u6574\u5f62\uff0crange\uff0c\u6d6e\u70b9\u6570\u7b49\uff09\u3001\u540d\u79f0\u548c\u53d6\u503c\u8303\u56f4\uff08\u7ea6\u675f\uff09\u3002<code>drm_object_properties</code>\u4e2d\u7684properties\u4fdd\u5b58\u5c5e\u6027\u7684\u7c7b\u578b\uff0c\u800c<code>values</code>\u4fdd\u5b58\u5bf9\u5e94\u7c7b\u578b\u7684\u503c\u3002\u8fd9\u662f\u56e0\u4e3a\u540c\u4e00\u7c7b\u578b\u7684\u5bf9\u8c61\u57fa\u672c\u4e0a\u90fd\u5171\u6709\u7279\u5b9a\u540d\u79f0\u548c\u7c7b\u578b\u7684\u5c5e\u6027\uff0c\u72ec\u7acb\u7684\u5c5e\u6027\u5bf9\u8c61\u4f7f\u5f97\u6211\u4eec\u4e0d\u9700\u8981\u4e3a\u5728\u6bcf\u4e00\u4e2a\u5bf9\u8c61\u4e2d\u90fd\u4fdd\u5b58\u540c\u6837\u7684\u5c5e\u6027\u540d\u79f0\u548c\u7c7b\u578b\u3002\u5bf9\u8c61\u7684\u5c5e\u6027\u53ef\u4ee5\u901a\u8fc7<code>drm_object_property_*</code>\u51fd\u6570\u64cd\u4f5c\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#helper","title":"helper\u67b6\u6784","text":"<p>helper\u67b6\u6784\u662f\u6211\u8d77\u7684\u540d\uff0c\u77e5\u9053\u662f\u6307\u4ec0\u4e48\u4e1c\u897f\u5c31\u597d\u3002DRM\u5b50\u7cfb\u7edf\u7684API\u6bd4\u8f83\u96be\u62bd\u8c61\uff0c\u7b80\u5355\u6765\u8bf4\u5c31\u662f\u786c\u4ef6\u5404\u6709\u5404\u7684\u4e0d\u540c\uff0c\u5f88\u591a\u60c5\u51b5\u4e0b\uff0c\u9a71\u52a8\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u5171\u540c\u7684\u5b9e\u73b0\uff0c\u800c\u5728\u5176\u5b83\u60c5\u51b5\u4e0b\uff0c\u9a71\u52a8\u9700\u8981\u63d0\u4f9b\u81ea\u5df1\u7684\u5b9e\u73b0\u3002\u56e0\u6b64\uff0cDRM\u9a71\u52a8\u6838\u5fc3\u7684\u63a5\u53e3\u4f7f\u7528\u4e86helper\u67b6\u6784\uff0c\u5176\u57fa\u672c\u601d\u60f3\u662f\u901a\u8fc7\u4e00\u7ec4\u56de\u8c03\u51fd\u6570\u62bd\u8c61\u7279\u5b9a\u7ec4\u4ef6\u7684\u64cd\u4f5c\uff0c\u6bd4\u5982<code>drm_connector_funcs</code>\uff0c\u540c\u65f6\u53c8\u4f7f\u7528\u53e6\u5916\u4e00\u7ec4helper\u51fd\u6570\u7ed9\u51fa\u4e86\u539f\u5148\u90a3\u7ec4\u56de\u8c03\u51fd\u6570\u7684\u901a\u7528\u5b9e\u73b0\uff0c\u8ba9\u5f00\u53d1\u6700\u8005\u5b9e\u73b0\u8fd9\u7ec4helper\u51fd\u6570\u62bd\u8c61\u51fa\u7684\u56de\u8c03\u51fd\u6570\u5373\u53ef\u3002</p> <p>\u8fd9\u6837\u53cc\u5c42\u7684\u5b9e\u73b0\u5373\u80fd\u4fdd\u8bc1\u5f00\u53d1\u8005\u6709\u8db3\u591f\u9ad8\u7684\u81ea\u7531\u5ea6\uff08\u5b8c\u5168\u4e0d\u7528helper\u51fd\u6570\uff09\uff0c\u4e5f\u80fd\u7b80\u5316\u5f00\u53d1\u8005\u7684\u5f00\u53d1\uff08\u4f7f\u7528helper\u51fd\u6570\uff09\uff0c\u540c\u65f6\u63d0\u4f9b\u7ed9\u5f00\u53d1\u8005hook\u7279\u5b9ahelper\u51fd\u6570\u7684\u80fd\u529b\u3002\u4e0b\u9762\u4ee5<code>drm_connector</code>\u4e3a\u4f8b\u8bf4\u660ehelper\u67b6\u6784\u7684\u5b9e\u73b0\u4e0e\u4f7f\u7528\u65b9\u5f0f\u3002</p> <p>\u6b63\u5e38\u60c5\u51b5\u4e0b\uff0c\u521b\u5efa<code>drm_connector</code>\u5bf9\u8c61\u65f6\u9700\u8981\u63d0\u4f9b<code>struct drm_connector_funcs</code>\u56de\u8c03\u51fd\u6570\u7ec4\uff0c\u800c\u4f7f\u7528helper\u51fd\u6570\u65f6\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528helper\u51fd\u6570\u586b\u5145\u5bf9\u5e94\u56de\u8c03\u51fd\u6570\uff1a <pre><code>static const struct drm_connector_funcs vc4_hdmi_connector_funcs = {\n        .detect = vc4_hdmi_connector_detect,\n        .fill_modes = drm_helper_probe_single_connector_modes,\n        .destroy = vc4_hdmi_connector_destroy,\n        .reset = drm_atomic_helper_connector_reset,\n        .atomic_duplicate_state = drm_atomic_helper_connector_duplicate_state,\n        .atomic_destroy_state = drm_atomic_helper_connector_destroy_state,\n};\n</code></pre> \u4e8b\u5b9e\u4e0ahelper\u51fd\u6570\u5e76\u4e0d\u4e07\u80fd\uff0c\u53ea\u662f\u62bd\u8c61\u51fa\u4e86\u5927\u591a\u6570\u9a71\u52a8\u7a0b\u5e8f\u5e94\u8be5\u5171\u4eab\u7684\u884c\u4e3a\uff0c\u800c\u7279\u5b9a\u4e8e\u786c\u4ef6\u7684\u90e8\u5206\uff0c\u5219\u9700\u8981\u4ee5\u56de\u8c03\u51fd\u6570\u7684\u5f62\u5f0f\u63d0\u4f9b\u7ed9helper\u51fd\u6570\uff0c\u8fd9\u4e2a\u56de\u8c03\u51fd\u6570\u7ec4\u7531<code>struct drm_connector_helper_funcs</code>\u63d0\u4f9b\u3002\u5728\u521b\u5efa<code>drm_connector</code>\u65f6\uff0c\u9700\u8981\u901a\u8fc7<code>drm_connector_helper_add</code>\u51fd\u6570\u6ce8\u518c\u3002\u51fd\u6570\u5c06\u5bf9\u5e94\u7684\u56de\u8c03\u51fd\u6570\u5bf9\u8c61\u7684\u5730\u5740\u4fdd\u5b58\u5728\u4e86<code>drm_connector</code>\u4e2d\u7684<code>helper_private</code>\u6307\u9488\u4e2d\uff0c\u5982\u4e0b\uff1a <pre><code>static inline void drm_connector_helper_add(struct drm_connector *connector,\n                                            const struct drm_connector_helper_funcs *funcs)\n{\n        connector-&gt;helper_private = funcs;\n}\n</code></pre> \u8fd9\u4e00\u5957\u5b9e\u73b0\u4f4d\u4e8e<code>include/drm/drm_modeset_helper_vtables.h</code>\u4e2d\uff0c\u5176\u4ed6\u7684DRM\u5bf9\u8c61\u90fd\u6709\u7c7b\u4f3c\u7684\u5b9e\u73b0\uff0c\u53ef\u4ee5\u8be6\u7ec6\u9605\u8bfb<code>drm_connector_helper_funcs</code>\u7684\u6ce8\u91ca\uff0c\u7406\u89e3\u5176\u4e2d\u5bf9\u5e94\u7684\u56de\u8c03\u51fd\u6570\u7684\u7528\u9014\u3002\u5728\u5b9e\u73b0DRM\u9a71\u52a8\u65f6\uff0chelper\u67b6\u6784\u4f1a\u9891\u7e41\u7528\u5230\uff0c\u5408\u7406\u638c\u63e1helper\u51fd\u6570\u53ef\u4ee5\u6781\u5927\u7b80\u5316\u5f00\u53d1\uff0c\u63d0\u5347\u9a71\u52a8\u7a0b\u5e8f\u7684\u517c\u5bb9\u6027\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#_2","title":"\u9a71\u52a8\u5165\u53e3","text":"<p>\u6211\u4eec\u77e5\u9053<code>drm_device</code>\u7528\u4e8e\u62bd\u8c61\u4e00\u4e2a\u5b8c\u6574\u7684DRM\u8bbe\u5907\uff0c\u800c\u5176\u4e2d\u4e0e<code>Mode Setting</code>\u76f8\u5173\u7684\u90e8\u5206\u5219\u7531<code>drm_mode_config</code>\u8fdb\u884c\u7ba1\u7406\u3002\u4e3a\u4e86\u8ba9\u4e00\u4e2a<code>drm_device</code>\u652f\u6301<code>KMS</code>\u76f8\u5173\u7684API\uff0cDRM\u6846\u67b6\u8981\u6c42\u9a71\u52a8\uff1a</p> <ul> <li>\u6ce8\u518c<code>drm_driver</code>\u65f6\uff0c<code>driver_features</code>\u6807\u5fd7\u4f4d\u4e2d\u9700\u8981\u5b58\u5728<code>DRIVER_MODESET</code></li> <li>\u5728probe\u51fd\u6570\u4e2d\u8c03\u7528<code>drm_mode_config_init</code>\u51fd\u6570\u521d\u59cb\u5316KMS\u6846\u67b6\uff0c\u672c\u8d28\u4e0a\u662f\u521d\u59cb\u5316<code>drm_device</code>\u4e2d\u7684<code>mode_config</code>\u7ed3\u6784\u4f53</li> <li>\u586b\u5145mode_config\u4e2dint min_width, min_height; int max_width, max_height\u7684\u503c\uff0c\u8fd9\u4e9b\u503c\u662fframebuffer\u7684\u5927\u5c0f\u9650\u5236</li> <li>\u8bbe\u7f6emode_config-&gt;funcs\u6307\u9488\uff0c\u672c\u8d28\u4e0a\u662f\u4e00\u7ec4\u7531\u9a71\u52a8\u5b9e\u73b0\u7684\u56de\u8c03\u51fd\u6570\uff0c\u6db5\u76d6<code>KMS</code>\u4e2d\u4e00\u4e9b\u76f8\u5f53\u57fa\u672c\u7684\u64cd\u4f5c</li> <li>\u6700\u540e\u521d\u59cb\u5316<code>drm_device</code>\u4e2d\u5305\u542b\u7684<code>drm_connector</code>\uff0c<code>drm_crtc</code>\u7b49\u5bf9\u8c61</li> </ul> <p>\u6211\u4eec\u77e5\u9053\u6ce8\u518c\u4e00\u4e2a\u652f\u6301<code>KMS</code>\u7684DRM\u8bbe\u5907\u65f6\uff0c\u4f1a\u5728<code>/dev/drm/</code>\u4e0b\u521b\u5efa\u4e00\u4e2a<code>card%d</code>\u6587\u4ef6\uff0c\u7528\u6237\u6001\u53ef\u4ee5\u901a\u8fc7\u6253\u5f00\u8be5\u6587\u4ef6\uff0c\u5e76\u5bf9\u6587\u4ef6\u63cf\u8ff0\u7b26\u505a\u76f8\u5e94\u7684\u64cd\u4f5c\u5b9e\u73b0\u76f8\u5e94\u7684\u529f\u80fd\u3002\u8be5\u6587\u4ef6\u63cf\u8ff0\u7b26\u5bf9\u5e94\u7684\u6587\u4ef6\u64cd\u4f5c\u56de\u8c03\u51fd\u6570\uff08<code>filesystem_operations</code>\uff09\u4f4d\u4e8e<code>drm_driver</code>\u4e2d\uff0c\u5e76\u7531\u9a71\u52a8\u7a0b\u5e8f\u586b\u5145\u3002\u5178\u578b\u5982\u4e0b\uff1a <pre><code>static const struct file_operations vkms_driver_fops = {\n        .owner          = THIS_MODULE,\n        .open           = drm_open,\n        .mmap           = drm_gem_mmap,\n        .unlocked_ioctl = drm_ioctl,\n        .compat_ioctl   = drm_compat_ioctl,\n        .poll           = drm_poll,\n        .read           = drm_read,\n        .llseek         = no_llseek,\n        .release        = drm_release,\n};\n</code></pre> \u57fa\u672c\u90fd\u4e3aDRM\u6846\u67b6\u9884\u5148\u63d0\u4f9b\u597d\u7684helper\u51fd\u6570\uff0c\u53ef\u4ee5\u6839\u636e\u9a71\u52a8\u9700\u8981\u7075\u6d3b\u6539\u53d8\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#crtc","title":"CRTC","text":""},{"location":"Linux/DRM/1.1%20drm-kms/#framebuffer","title":"Framebuffer","text":"<p>\u5185\u6838\u6587\u6863 framebuffer\u5e94\u8be5\u662f\u552f\u4e00\u4e00\u4e2a\u4e0e\u786c\u4ef6\u65e0\u5173\u7684\u62bd\u8c61\u4e86\u3002\u9a71\u52a8\u7a0b\u5e8f\u9700\u8981\u63d0\u4f9b\u81ea\u5df1\u7684framebuffer\u5b9e\u73b0\uff0c\u5176\u4e3b\u8981\u5165\u53e3\u5c31\u662f\u524d\u9762\u63d0\u5230\u7684<code>drm_mode_config_funcs-&gt;fb_create</code>\u56de\u8c03\u51fd\u6570\u3002\u9a71\u52a8\u7a0b\u5e8f\u901a\u8fc7\u6269\u5c55<code>drm_framebuffer</code>\u7ed3\u6784\u4f53\u53ef\u4ee5\u5411framebuffer\u4e2d\u52a0\u5165\u81ea\u5df1\u79c1\u6709\u7684\u5b57\u6bb5\u3002 <pre><code>struct virtio_gpu_framebuffer {\n        struct drm_framebuffer base;\n        struct virtio_gpu_fence *fence;\n};\n</code></pre> \u521b\u5efaframebuffer\u65f6\uff0c\u9700\u8981\u901a\u8fc7<code>drm_framebuffer_init</code>\u51fd\u6570\u5c06framebuffer\u521d\u59cb\u5316\uff0c\u5e76\u5bfc\u51fa\u5230\u7528\u6237\u7a7a\u95f4\u3002<code>fb_create</code>\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a<code>drm_mode_fb_cmd2</code>\u7c7b\u578b\u7684\u53c2\u6570\uff1a <pre><code>struct drm_mode_fb_cmd2 {\n        __u32 fb_id;\n        __u32 width;\n        __u32 height;\n        __u32 pixel_format; /* fourcc code from drm_fourcc.h */\n        __u32 flags; /* see above flags */\n        __u32 handles[4];\n        __u32 pitches[4]; /* pitch for each plane */\n        __u32 offsets[4]; /* offset of each plane */\n        __u64 modifier[4]; /* ie, tiling, compress */\n};\n</code></pre> \u5176\u4e2d\u6700\u91cd\u8981\u7684\u5c31\u662fhandle\uff0chandle\u662fBuffer Object\u7684\u6307\u9488\uff0c\u8be5Buffer Object\u5c31\u662f\u88ab\u521b\u5efaframebuffer\u7684\u5b58\u50a8\u540e\u7aef\u3002</p> <p>TODO framebuffer releated operation</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#plane","title":"Plane","text":"<p>\u5185\u6838\u6587\u6863</p> <p>plane\u7531<code>drm_plane</code>\u8868\u793a\uff0c\u5176\u672c\u8d28\u662f\u5bf9\u663e\u793a\u63a7\u5236\u5668\u4e2dscanout\u786c\u4ef6\u7684\u62bd\u8c61\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u7ed9\u5b9a\u4e00\u4e2aplane\uff0c\u53ef\u4ee5\u8ba9\u5176\u4e0e\u4e00\u4e2aframebuffer\u5173\u8054\u8868\u793a\u8fdb\u884cscanout\u7684\u6570\u636e\uff0c\u540c\u65f6\u63a7\u5236\u63a7\u5236scanout\u65f6\u8fdb\u884c\u7684\u989d\u5916\u64cd\u4f5c\uff0c\u6bd4\u5982colorspace\u7684\u6539\u53d8\uff0c\u65cb\u8f6c\u3001\u62c9\u4f38\u7b49\u64cd\u4f5c\u3002<code>drm_plane</code>\u662f\u4e0e\u786c\u4ef6\u5f3a\u76f8\u5173\u7684\uff0c\u663e\u793a\u63a7\u5236\u5668\u652f\u6301\u7684plane\u662f\u56fa\u5b9a\u7684\uff0c\u5176\u652f\u6301\u7684\u529f\u80fd\u4e5f\u662f\u7531\u786c\u4ef6\u51b3\u5b9a\u7684\u3002</p> <p>\u5bf9\u4e8e<code>drm_plane</code>\u7684\u5206\u6790\uff0c\u6211\u4eec\u4ece\u5176\u7ed3\u6784\u4f53\u5b9a\u4e49\u5165\u624b\u3002\u9996\u5148\u53ef\u4ee5\u770b\u5230\uff0c\u4e00\u4e2aplane\u5fc5\u987b\u8981\u4e0e\u4e00\u4e2a<code>drm_deivce</code>\u5173\u8054\uff0c\u4e14\u4e00\u4e2a<code>drm_device</code>\u4e2d\u652f\u6301\u7684\u6240\u6709plane\u90fd\u88ab\u4fdd\u5b58\u5728\u4e00\u4e2a\u94fe\u8868\u4e2d\u3002<code>drm_plane</code>\u4e2d\u5b58\u6709\u4e00\u4e2amask\uff0c\u7528\u4ee5\u8868\u793a\u8be5<code>drm_plane</code>\u53ef\u4ee5\u7ed1\u5b9a\u7684CRTC\u3002\u540c\u65f6<code>drm_plane</code>\u4e2d\u4e5f\u4fdd\u5b58\u4e86\u4e00\u4e2a<code>format_types</code>\u6570\u7ec4\uff0c\u8868\u793a\u8be5<code>plane</code>\u652f\u6301\u7684framebuffer\u683c\u5f0f\u3002</p> <p>\u6240\u6709\u7684<code>drm_plane</code>\u5fc5\u4e3a\u4e09\u79cd\u7c7b\u578b\u4e4b\u4e00\uff1a</p> <ul> <li><code>Primary</code>\u00a0- \u4e3bplane\uff0c\u4e00\u822c\u63a7\u5236\u6574\u4e2a\u663e\u793a\u5668\u7684\u8f93\u51fa\u3002CRTC\u5fc5\u987b\u8981\u6709\u4e00\u4e2a\u8fd9\u6837\u7684plane\u3002</li> <li><code>Curosr</code>\u00a0- \u8868\u793a\u9f20\u6807\u5149\u6807\uff0c\u53ef\u9009\u3002</li> <li><code>Overlay</code>\u00a0- \u53e0\u52a0plane\uff0c\u53ef\u4ee5\u5728\u4e3bplane\u4e0a\u53e0\u52a0\u4e00\u5c42\u8f93\u51fa\uff0c\u53ef\u9009\u3002</li> </ul> <p>\u6765\u56de\u987e\u4e00\u70b9\u5386\u53f2\uff1a\u5185\u6838\u5411\u7528\u6237\u6001\u5bfc\u51fa\u7684\u63a5\u53e3\u5b9e\u9645\u4e0a\u4e0d\u5305\u542b<code>Primary Plane</code>\uff0c\u5bf9\u5e94plane\u7684\u63a5\u53e3\u53ea\u80fd\u64cd\u4f5c<code>Cursor Plane</code>\u548c<code>Overlay Plane</code>\uff0c\u540e\u671f\u63d0\u4f9b\u4e86\u4e00\u4e2a<code>Universial Plane</code>\u7279\u6027\uff0c\u4f7f\u5f97\u7528\u6237\u6001API\u53ef\u4ee5\u76f4\u63a5\u64cd\u4f5c<code>Primary Plane</code>\u3002\u5728\u660e\u767d\u8fd9\u4e2a\u5386\u53f2\u9057\u7559\u95ee\u9898\u540e\uff0c\u5bf9<code>drm_plane</code>\u7684\u5b9e\u73b0\u5c31\u597d\u7406\u89e3\u4e86\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#encoder","title":"Encoder","text":""},{"location":"Linux/DRM/1.1%20drm-kms/#mode","title":"Mode","text":"<p>\u4e00\u822c\u4eba\u5bf9mode\u7684\u7406\u89e3\u4ec5\u4ec5\u662f\u5206\u8fa8\u7387\uff0c\u8fd9\u79cd\u7406\u89e3\u5728DRM\u4e2d\u662f\u4e0d\u591f\u7684\uff0c\u4e0d\u8db3\u4ee5\u7406\u89e3<code>drm_display_mode</code>\u662f\u5e72\u4ec0\u4e48\u7684\u3002\u7b80\u5355\u6765\u8bf4\uff0cmode\u662f\u4e00\u7ec4\u4fe1\u53f7\u65f6\u5e8f\uff0c\u7528\u4ee5\u9a71\u52a8\u663e\u793a\u5668\u6b63\u786e\u663e\u793a\u4e00\u5e27\u56fe\u50cf\u3002\u9996\u5148\u80fd\u591f\u731c\u5230\u9700\u8981\u4f20\u4ec0\u4e48\u4e1c\u897f\u7ed9\u663e\u793a\u5668\uff1a\u50cf\u7d20\u6570\u636e\u3002\u800c\u5230\u5e95\u591a\u5c11\u4e2a\u50cf\u7d20\u5c31\u8ddf\u663e\u793a\u5668\u7684\u5206\u8fa8\u7387\u6709\u5173\u4e86\uff0c\u59821080p\u7684\u663e\u793a\u5668\u9700\u8981\u4f20\u9012<code>1080 x 1920</code>\u4e2a\u50cf\u7d20\u3002\u66f4\u52a0\u5177\u4f53\u7684\u5f62\u5f0f\u662f\u4e00\u884c\u4e00\u884c\u7684\u4ece\u5de6\u5230\u53f3\u53d1\u9001\uff0c\u7531\u4e8e\u786c\u4ef6\u5b9e\u73b0\u9700\u8981\uff0c\u9700\u8981\u989d\u5916\u7684\u6b65\u9aa4\u5bf9\u4fe1\u53f7\u8fdb\u884c\u540c\u6b65\u3002\u5e27\u4e0e\u5e27\u4e4b\u95f4\u88ab\u79f0\u4e3avertical\uff0c\u5373\u7ad6\u76f4\u7684\uff0c\u800c\u884c\u4e0e\u884c\u4e4b\u95f4\u88ab\u79f0\u4e3ahorizontal\uff0c\u5373\u6c34\u5e73\u7684\uff0c\u8fd9\u76f4\u63a5\u5bf9\u5e94\u4e8e\u663e\u793a\u5668\u7684\u6a2a\u7ad6\u65b9\u5411\u3002</p> <p>\u4e0a\u9762\u5185\u6838\u6ce8\u91ca\u4e2d\u7684\u5b57\u7b26\u753b\u5b8c\u7f8e\u7684\u89e3\u91ca\u4e86<code>drm_display_mode</code>\u4e2d\u53d8\u91cf\u7684\u5b9a\u4e49\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\u73b0\u5b9e\u72b6\u51b5\u4e2d\uff0c\u8fd8\u6709\u9700\u8981\u5176\u5b83\u590d\u6742\u7684\u663e\u793a\u6a21\u5f0f\uff0c\u6bd4\u5982interlaced\u6a21\u5f0f\u7b49\uff0c\u6240\u4ee5<code>drm_display_mode</code>\u533a\u5206\u903b\u8f91\u53c2\u6570\u4e0e\u786c\u4ef6\u53c2\u6570\uff0c\u786c\u4ef6\u53c2\u6570\u5c31\u662f\u771f\u6b63\u8fdb\u884c\u786c\u4ef6\u64cd\u4f5c\u65f6\u4f7f\u7528\u7684\u53c2\u6570\uff0c\u800c\u903b\u8f91\u53c2\u6570\u662f\u4e3a\u4e86\u65b9\u4fbf\u9a71\u52a8\u5f00\u53d1\u4eba\u5458\u8fdb\u884c\u7684\u62bd\u8c61\uff0c<code>drm_display_mode</code>\u6839\u636e\u76f8\u5e94\u7684flag\u8ba1\u7b97\u51fa\u786c\u4ef6\u53c2\u6570\u3002 \u9664\u4e86\u4e0a\u8ff0\u76f4\u63a5\u4e0e\u786c\u4ef6\u76f8\u5173\u7684\u53c2\u6570\uff0c<code>drm_display_mode</code>\u8fd8\u643a\u5e26\u4e86\u4e00\u4e9bDRM\u76f8\u5173\u7684\u5c5e\u6027\u3002\u6bd4\u5982\u7c7b\u578b\uff1a</p> <p>\u53ef\u4ee5\u770b\u5230mode\u7684\u4e24\u4e2a\u6765\u6e90: \u9a71\u52a8\u521b\u5efa\u548c\u5185\u6838\u547d\u4ee4\u884c\u81ea\u884c\u5b9a\u4e49\u3002\u800c<code>DRM_MODE_TYPE_PREFERRED</code>\u6807\u8bb0\u7684 <code>drm_display_mode</code>\u5219\u4e00\u822c\u4e3a\u5bf9\u5e94connector\u7684native mode\u3002\u9664\u6b64\u4e4b\u5916\u4e00\u4e2a\u6bd4\u8f83\u91cd\u8981\u7684\u5c5e\u6027\u5c31\u662fstatus:</p> <p>\u8be5\u5c5e\u6027\u76f4\u63a5\u6807\u8bb0\u8be5mode\u662f\u5426\u53ef\u4ee5\u88ab\u786c\u4ef6\u63a5\u53d7\uff0c\u5982\u679c\u4e0d\u884c\uff0c\u5219\u4f1a\u6807\u6ce8\u51fa\u5177\u4f53\u539f\u56e0\u3002\u5bf9\u5e94\u663e\u793a\u5668\u7684\u957f\u5bbd\u4e00\u822c\u4f1a\u7531width_mm \u548cheight_mm\u8bb0\u5f55\uff0c\u5355\u4f4d\u662f\u6beb\u7c73\u3002\u6700\u540e\u6ce8\u610fdrm_display_mode \u4e00\u822c\u4e0e drm_connector \u5173\u8054\uff0c\u56e0\u6b64drm_modes.c\u4e2d\u63d0\u4f9b\u4e86\u76f8\u5e94\u7684helper\u51fd\u6570\uff0c\u6bd4\u5982:</p> <p>drm_mode_probed_add \u51fd\u6570\u5c06\u8be5mode\u6dfb\u52a0\u5230\u4e00\u4e2aconnector\u7684\u7ba1\u7406\u4e2d\u3002\u6ce8\u610fprobed_modes\u5217\u8868\u4e2d\u53ef\u80fd\u5305\u542b\u4e86\u8bb8\u591a\u786c\u4ef6\u65e0\u6cd5\u4f7f\u7528\u7684mode\uff0c\u5bf9\u4e8e\u8fd9\u6837\u7684\u4e00\u4e2a\u5217\u8868\uff0c\u53ef\u4ee5\u4f7f\u7528drm_mode_prune_invalid\u5c06\u5176\u4e2d\u975e\u6cd5\u7684mode\u6e05\u9664\u3002</p>"},{"location":"Linux/DRM/1.1%20drm-kms/#connector","title":"Connector","text":"<p>\u9996\u5148\u660e\u786econnector\u62bd\u8c61\u4e86\u4ec0\u4e48\u4e1c\u897f\u3002\u4ece\u5185\u6838\u6587\u6863\u7684\u63cf\u8ff0\u4e2d\u53ef\u4ee5\u660e\u767d\uff0cconnector\u62bd\u8c61\u7684\u662f\u4e00\u4e2a\u80fd\u591f\u663e\u793a\u50cf\u7d20\u7684\u8bbe\u5907\uff0c\u4ece\u6d41\u5a92\u4f53\u7684\u89d2\u5ea6\u6765\u8bf4\uff0c\u5c31\u662f\u4e00\u4e2asink\uff0c\u662f\u6700\u7ec8\u7684\u56fe\u50cf\u8f93\u51fa\u7684\u5730\u65b9\u3002\u6216\u8005\u66f4\u52a0\u5177\u8c61\u7684\u7406\u89e3\u4e00\u4e0b\uff0c\u5b57\u9762\u610f\u601d\u5c31\u662f\u663e\u5361\u4e0a\u9762\u7684\u63a5\u5934\uff0c\u6bd4\u5982HDMI\uff0cDP\u7b49\u63a5\u5934\u3002connector\u7531<code>struct drm_connector</code>\u8fdb\u884c\u8868\u793a\uff0c\u5e76\u5b9a\u4e49\u5728include/drm/drm_connector.h\u4e2d\uff0c\u63a5\u4e0b\u6765\u5c31\u5206\u6790\u5668\u76f8\u5173\u5b9e\u73b0\u3002</p> <p>\u9996\u5148\u4ece\u8be5\u7ed3\u6784\u4f53\u7684\u5b9a\u4e49\u4e0b\u624b\uff0c\u53ef\u4ee5\u770b\u5230\u7ed3\u6784\u4f53\u5b9a\u4e49\u5f00\u59cb\u6bd4\u8f83\u957f\u7684\uff0c\u5148\u4ece\u5e38\u89c4\u90e8\u5206\u4e0b\u624b: <pre><code>struct drm_connector {\n    /** @dev: parent DRM device */\n    struct drm_device *dev;\n</code></pre></p>"},{"location":"Linux/DRM/1.3%20drm-howto/","title":"DRM\u7528\u6237\u63a5\u53e3\u793a\u4f8b","text":""},{"location":"Linux/DRM/1.3%20drm-howto/#_1","title":"\u7b80\u4ecb","text":"<p>\u76f4\u63a5\u6e32\u67d3\u7ba1\u7406\u5668\uff08DRM\uff09\u662f\u7528\u4e8e\u7ba1\u7406\u56fe\u5f62\u5904\u7406\u5355\u5143\uff08GPU\uff09\u7684\u6846\u67b6\u3002\u5b83\u65e8\u5728\u652f\u6301\u590d\u6742\u56fe\u5f62\u8bbe\u5907\u7684\u9700\u6c42\uff0c\u901a\u5e38\u5305\u542b\u9002\u7528\u4e8e 3D \u56fe\u5f62\u52a0\u901f\u7684\u53ef\u7f16\u7a0b\u7ba1\u9053\u3002\u6b64\u5916\uff0c\u5b83\u8fd8\u8d1f\u8d23\u5185\u5b58\u7ba1\u7406\u3001\u4e2d\u65ad\u5904\u7406\u548c DMA\uff0c\u4ee5\u4fbf\u4e3a\u5e94\u7528\u7a0b\u5e8f\u63d0\u4f9b\u7edf\u4e00\u7684\u63a5\u53e3\u3002</p> <p>\u5728\u65e9\u671f\uff0c\u5185\u6838\u6846\u67b6\u4ec5\u7528\u4e8e\u5411\u7279\u6743\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b\u63d0\u4f9b\u539f\u59cb\u786c\u4ef6\u8bbf\u95ee\uff0c\u8fd9\u4e9b\u8fdb\u7a0b\u5b9e\u73b0\u4e86\u6240\u6709\u786c\u4ef6\u62bd\u8c61\u5c42\u3002\u4f46\u662f\uff0c\u8d8a\u6765\u8d8a\u591a\u7684\u4efb\u52a1\u88ab\u79fb\u5230\u4e86\u5185\u6838\u4e2d\u3002\u6240\u6709\u8fd9\u4e9b\u63a5\u53e3\u90fd\u57fa\u4e8e DRM \u5b57\u7b26\u8bbe\u5907\u7684 ioctl \u547d\u4ee4\u3002libdrm \u5e93\u4e3a\u8fd9\u4e9b\u7cfb\u7edf\u8c03\u7528\u63d0\u4f9b\u4e86\u5305\u88c5\u5668\u548c\u8bb8\u591a\u5e2e\u52a9\u7a0b\u5e8f\uff0c\u4ee5\u7b80\u5316 API\u3002</p> <p>\u5f53\u7cfb\u7edf\u68c0\u6d4b\u5230 GPU \u65f6\uff0cDRM \u7cfb\u7edf\u4f1a\u4e3a\u68c0\u6d4b\u5230\u7684\u786c\u4ef6\u7c7b\u578b\u52a0\u8f7d\u9a71\u52a8\u7a0b\u5e8f\u3002\u7136\u540e\uff0c\u6bcf\u4e2a\u8fde\u63a5\u7684 GPU \u90fd\u901a\u8fc7\u901a\u5e38\u53ef\u4f5c\u4e3a /dev/dri/card0 \u4f7f\u7528\u7684\u5b57\u7b26\u8bbe\u5907\u5448\u73b0\u7ed9\u7528\u6237\u7a7a\u95f4\uff0c\u5e76\u53ef\u4ee5\u901a\u8fc7 open\u548c close\u8bbf\u95ee\u3002\u4f46\u662f\uff0c\u5b83\u4ecd\u7136\u53d6\u51b3\u4e8e\u56fe\u5f62\u9a71\u52a8\u7a0b\u5e8f\u5728\u8fd9\u4e9b\u8bbe\u5907\u4e0a\u53ef\u7528\u7684\u63a5\u53e3\u3002\u5982\u679c\u63a5\u53e3\u4e0d\u53ef\u7528\uff0c\u5219\u7cfb\u7edf\u8c03\u7528\u5c06\u5931\u8d25\u5e76\u51fa\u73b0 EINVAL \u9519\u8bef\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/","title":"GEM","text":""},{"location":"Linux/DRM/2.1%20drm-gem/#gemttm","title":"GEM\u4e0eTTM\u4e4b\u95f4\u7684\u5173\u7cfb","text":"<p>TTM\u662f\u5185\u6838\u6700\u521d\u7684DRM\u663e\u5b58\u7ba1\u7406\u5668\uff0c\u5176\u8bbe\u8ba1\u601d\u60f3\u662f\u8bd5\u56fe\u4e3a\u6240\u6709\u7684\u663e\u5361\u9a71\u52a8\u63d0\u4f9b\u4e00\u4e2a\u516c\u5171\u7684API\u3002TTM\u540e\u9762\u88ab\u8ba4\u4e3a\u662f\u5931\u8d25\u7684\uff0c\u5176API\u4e0e\u5b9e\u73b0\u590d\u6742\u4e0d\u53ef\u63a7\uff0c\u6ca1\u6709\u4eba\u613f\u610f\u7528\u4ed6\u3002\u540e\u6765intel\u5438\u53d6\u6559\u8bad\uff0c\u8bbe\u8ba1\u4e86GEM\uff0c\u5176\u8bbe\u8ba1\u8f83\u4e3a\u7075\u6d3b\uff0c\u53ea\u63d0\u4f9b\u57fa\u672c\u7684\u5b9e\u73b0\uff0c\u90e8\u5206\u529f\u80fd\u9700\u8981\u9a71\u52a8\u7a0b\u5e8f\u901a\u8fc7\u9a71\u52a8\u81ea\u5b9a\u7684\u63a5\u53e3\u8fdb\u884c\u6269\u5c55\u3002GEM\u4e0eTTM\u5728\u7279\u6027\u4e0a\u7684\u4e3b\u8981\u533a\u522b\u4e3aGEM\u4e0d\u652f\u6301\u7ba1\u7406\u72ec\u7acb\u663e\u5b58\uff0c\u53ea\u652f\u6301UMA\uff0c\u800cTTM\u4e24\u79cd\u90fd\u652f\u6301\u3002\u76ee\u524d\u7684DRM\u9a71\u52a8\u7a0b\u5e8f\u4e2d\uff0c\u57fa\u672c\u90fd\u4f7f\u7528GEM\u4f5c\u4e3a\u524d\u7aef\u4e3a\u7528\u6237\u6001\u63d0\u4f9b\u63a5\u53e3\uff0c\u800c\u6d89\u53ca\u5230\u7ba1\u7406\u72ec\u7acb\u663e\u5b58\u7684\u65f6\u5019\uff0c\u5219\u501f\u52a9TTM\u4f5c\u4e3a\u540e\u7aef\u5b9e\u73b0\u7ba1\u7406\u529f\u80fd\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#_1","title":"\u6846\u67b6\u521d\u59cb\u5316","text":"<p>\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4ee5\u81ea\u5df1\u9009\u62e9\u662f\u5426\u4f7f\u7528GEM\u6846\u67b6\uff0c\u5982\u679c\u9009\u62e9\u4f7f\u7528\uff0c\u5219\u9700\u8981\u5728\u6ce8\u518c<code>drm_driver</code>\u5230DRM core\u4e2d\u65f6\uff0c\u5728<code>driver_features</code>\u91cc\u8bbe\u7f6eDRIVER_GEM\u6807\u5fd7\u3002\u5728\u9a71\u52a8\u52a0\u8f7d\u65f6\uff0cDRM\u6846\u67b6\u4f1a\u81ea\u52a8\u521d\u59cb\u5316GEM\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#handlename","title":"handle\u4e0ename","text":"<p>handle\u662fgem_object\u7684\u5f15\u7528\uff0c\u5176\u4f5c\u7528\u57df\u88ab\u9650\u5236\u5728drm\u6587\u4ef6\u63cf\u8ff0\u7b26\u5185\uff0c\u7528\u4e8e\u7528\u6237\u6001\u7a0b\u5e8f\u5f15\u7528\u5185\u6838\u6001\u7684drm_gem_object\u3002\u5f53drm\u6587\u4ef6\u63cf\u8ff0\u7b26\u88ab\u5173\u95ed\u65f6\uff0c\u6240\u6709\u7684handle\u90fd\u4f1a\u88ab\u5173\u95ed\u3002\u800cname\u5219\u662fdrm_gem_object\u7684\u540d\u79f0\uff0c\u4e3a\u4e00\u4e2a32-bit\u6574\u6570\u3002name\u7684\u4f5c\u7528\u57df\u662f\u5168\u5c40\u7684\uff0c\u56e0\u6b64\u88ab\u76f4\u63a5\u4fdd\u5b58\u5728drm_gem_object\u5185\u3002\u9ed8\u8ba4\u60c5\u51b5\u4e0bdrm_gem_object\u7684name\u90fd\u4e3a0\uff0c\u8868\u793a\u5176\u662f\u672a\u547d\u540d\u7684\u3002\u7528\u6237\u6001\u53ef\u4ee5\u901a\u8fc7FLINK\u4e3adrm_gem_object\u547d\u540d\uff0c\u4e4b\u540e\u7cfb\u7edf\u5185\u7684\u5176\u4ed6\u8fdb\u7a0b\u53ef\u4ee5\u901a\u8fc7\u5bf9\u5e94\u7684name\u5bf9\u8be5drm_gem_object\u8fdb\u884c\u8bbf\u95ee\u3002 handle\u7684\u521b\u5efa\u662f\u521b\u5efaGEM\u5bf9\u8c61\u7684\u4e00\u4e2a\u6b65\u9aa4\u3002\u76ee\u524dGEM\u5bf9\u8c61\u7684\u521b\u5efa\u4e00\u822c\u662f\u901a\u8fc7\u8bbe\u5907\u76f8\u5173\u7684API\u8fdb\u884c\u5b9e\u73b0\u7684\uff0c\u9a71\u52a8\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7<code>drm_gem_handle_create</code>\u51fd\u6570\u4ece\u5bf9\u5e94drm\u6587\u4ef6\u4e2d\u521b\u5efa\u4e00\u4e2ahandle\u8fd4\u56de\u7ed9\u7528\u4e8e\u6001\u3002\u5173\u4e8ehandle\uff0cgem core\u4e2d\u8fd8\u63d0\u4f9b\u4e86<code>drm_gem_handle_delete</code>\u548c<code>drm_gem_handle_lookup</code>\u51fd\u6570\u3002\u4e8b\u5b9e\u4e0a\uff0chandle\u7684\u7ba1\u7406\u662f\u901a\u8fc7idr\u5b9e\u73b0\u7684\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#drm_gem_object","title":"drm_gem_object","text":"<p>\u8be5\u5bf9\u8c61\u662fGEM\u5185\u5b58\u7ba1\u7406\u7684\u6838\u5fc3\u3002GEM\u76ee\u524d\u63d0\u4f9b\u7684\u529f\u80fd\u662f\u4e0d\u5b8c\u5168\u7684\uff0c\u90e8\u5206\u7a7a\u7f3a\u9700\u8981\u9a71\u52a8\u81ea\u884c\u586b\u8865\uff0c\u56e0\u6b64GEM\u6846\u67b6\u8981\u6c42\u9a71\u52a8\u5728<code>drm_gem_object</code>\u7684\u57fa\u7840\u4e0a\u5b9e\u73b0\u81ea\u5df1\u7684GEM\u5bf9\u8c61\u3002\u8fd9\u4e2a\u64cd\u4f5c\u5b9e\u9645\u4e0a\u5c31\u662f\u5c06<code>drm_gem_object</code>\u5d4c\u5165\u5230\u9a71\u52a8\u81ea\u5df1\u5b9a\u4e49\u7684<code>{driver}_gem_object</code>\u4e2d\u3002<code>drm_gem_object</code>\u5b9a\u4e49\u5728<code>include/drm/drm_gem.h</code>\u4e2d\uff0c\u4e14\u6709\u8be6\u7ec6\u7684\u6ce8\u91ca\uff0c\u8fd9\u91cc\u4e0d\u518d\u8d58\u8ff0\uff0c\u91cd\u70b9\u5206\u6790\u4e00\u4e9b\u5b57\u6bb5\u3002</p> <p><code>filp</code>\u662f\u4e00\u4e2a\u6307\u5411<code>struct file</code>\u7684\u6307\u9488\uff0c\u8981\u7406\u89e3\u5b83\u7684\u4f5c\u7528\u5c31\u5fc5\u987b\u7406\u89e3\u771f\u6b63\u7684\u5185\u5b58\u662f\u5982\u4f55\u5206\u914d\u7684\u3002\u524d\u9762\u63d0\u5230\u4e86GEM\u53ea\u652f\u6301UMA\uff0c\u5373\u663e\u5361\u4f7f\u7528RAM\u505a\u4e3a\u663e\u5b58\uff0c\u8fd9\u5c31\u53c8\u6d89\u53ca\u5230\u4e86\u4e24\u79cd\u60c5\u51b5\u3002\u5728PC\u4e2d\u7531\u4e8eIOMMU\u7684\u5b58\u5728\uff0c\u663e\u5361\u5e76\u4e0d\u5f3a\u5236\u8981\u6c42\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\uff0c\u56e0\u6b64GEM\u53ef\u4ee5\u4f7f\u7528SHMFS\u505a\u4e3a\u5b58\u50a8\u540e\u7aef\uff0c\u6b64\u65f6filp\u6307\u9488\u5c31\u6307\u5411\u5bf9\u5e94\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u3002\u800c\u5728\u5d4c\u5165\u5f0f\u5e94\u7528\u573a\u666f\u4e0b\uff0c\u5927\u90e8\u5206\u8bbe\u5907\u6ca1\u6709IOMMU\uff0c\u56e0\u6b64\u5fc5\u987b\u8981\u6c42\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\uff0c\u6b64\u65f6filp\u4e3aNULL\uff0c\u9a71\u52a8\u901a\u8fc7CMA\u7533\u8bf7\u5230\u8fde\u7eed\u7684\u7269\u7406\u5185\u5b58\u7528\u4f5c\u5b58\u50a8\u540e\u7aef\u3002\u6ce8\u610f\uff0cGEM\u6846\u67b6\u5e76\u4e0d\u8d1f\u8d23\u7ba1\u7406\u5b58\u50a8\u540e\u7aef\uff0c\u53ea\u63d0\u4f9b\u4e86\u4e00\u4e9b\u57fa\u672c\u7684helper\uff0c\u800c\u5b58\u50a8\u7684\u5206\u914d\u4e0e\u91ca\u653e\u5b8c\u5168\u7531\u9a71\u52a8\u7a0b\u5e8f\u63a7\u5236\u3002</p> <p>TODO\uff1a \u7814\u7a76\u4e00\u4e0bSHMFS</p> <p><code>vma_node</code>\u7b80\u5355\u6765\u8bf4\u662f\u4fdd\u5b58\u4e86\u8fd9\u4e2aobject\u7684mmap\u504f\u79fb\u91cf\u3002\u8fd9\u91cc\u53c8\u9700\u8981\u63d0\u53ca<code>drm_gem_object</code>\u5411\u7528\u6237\u6001\u7684\u6620\u5c04\u95ee\u9898\u3002GEM\u76ee\u524d\u57fa\u672c\u4e0a\u662f\u901a\u8fc7\u4e24\u79cd\u65b9\u5f0f\u5b9e\u73b0MAP gem_object\u5230\u7528\u6237\u6001\u7684\uff1a\u8bbe\u5907\u76f8\u5173IOCTL\u548c\u57fa\u4e8edrm\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684mmap\u3002\u540e\u8005\u901a\u8fc7\u4e00\u4e2a\u865a\u62df\u7684\u504f\u79fb\u91cf\u786e\u5b9ammap\u7a76\u7adf\u5728\u6620\u5c04\u54ea\u4e00\u4e2a<code>drm_gem_object</code>\u3002\u8be5\u673a\u5236\u7684\u5b9e\u73b0\u7ec6\u8282\u9700\u8981\u5355\u72ec\u8ba8\u8bba\u3002</p> <p><code>dma_buf</code>\u5b57\u6bb5\u662f\u4e00\u4e2a<code>struct dma_buf</code>\u7c7b\u578b\u7684\u5b57\u6bb5\u3002\u8fd9\u91cc\u53c8\u8bbe\u8ba1drm-prime\u6846\u67b6\u7684\u7ec6\u8282\u4e86\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u901a\u8fc7name\u6765\u5b9e\u73b0\u8fdb\u7a0b\u95f4\u5171\u4eab<code>drm_gem_object</code>\u5b58\u5728\u663e\u800c\u6613\u89c1\u7684\u5b89\u5168\u6027\u95ee\u9898\uff0c\u6bd5\u7adfname\u662f\u5168\u5c40\u7684\u3002\u653b\u51fb\u8005\u53ef\u4ee5\u901a\u8fc7\u7279\u5b9a\u7684pattern\u63a8\u6d4b\u6216\u8005\u679a\u4e3e<code>drm_gem_object</code>\u7684name\uff0c\u8fbe\u5230\u7a83\u53d6\u6570\u636e\u7684\u76ee\u7684\u3002\u540e\u7eedGEM\u96c6\u6210\u4e86dma_buf\uff0c\u53ef\u4ee5\u901a\u8fc7dma_buf\u5b9e\u73b0\u5171\u4eab\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#_2","title":"\u7528\u6237\u6001\u6620\u5c04","text":"<p>\u7528\u6237\u6001\u6620\u5c04\u5b9e\u8d28\u4e0a\u5c31\u662f\u5c06<code>drm_gem_object</code>\u63cf\u8ff0\u7684\u5b58\u50a8\u7a7a\u95f4\u6620\u5c04\u5230\u7528\u6237\u6001\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff0c\u8ba9\u7528\u6237\u6001\u8fdb\u7a0b\u53ef\u4ee5\u968f\u673a\u8bfb\u5199\u3002\u6b63\u5982\u524d\u9762\u63d0\u5230\u7684\uff0c\u8fd9\u91cc\u53ea\u5206\u6790GEM\u63d0\u4f9b\u7684\u65b9\u5f0f\uff0c\u5373\u57fa\u4e8edrm\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684mmap\u3002\u6211\u4eec\u77e5\u9053mmap\u7cfb\u7edf\u8c03\u7528\u7684\u539f\u578b\u5982\u4e0b\uff1a <pre><code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);\n</code></pre></p> <p>GEM\u6846\u67b6\u53ef\u4ee5\u4e3a\u6bcf\u4e00\u4e2a<code>drm_gem_object</code>\u7ed1\u5b9a\u4e00\u4e2a\u7279\u5b9a\u865a\u62dfoffset\uff0c\u901a\u8fc7offset\u8fa8\u522b\u9700\u8981\u6620\u5c04\u5230\u7528\u6237\u6001\u7684<code>drm_gem_object</code>\u3002\u8be5\u673a\u5236\u9700\u8981drm\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e0e<code>drm_gem_object</code>\u7684\u5171\u540c\u534f\u4f5c\uff0c\u524d\u9762\u770b\u5230<code>drm_gem_object</code>\u4e2d\u63d0\u4f9b\u4e86vma_node\u7528\u4e8e\u4fdd\u5b58\u8be5\u4fe1\u606f\uff0c\u9a71\u52a8\u7a0b\u5e8f\u9700\u8981\u81ea\u884c\u8c03\u7528<code>drm_gem_create_mmap_offset</code>\u4e3a\u4e00\u4e2a<code>drm_gem_object</code>\u6ce8\u518c\u4e00\u4e2a\u865a\u62dfoffset\u3002\u865a\u62dfoffset\u9700\u8981\u901a\u8fc7\u8bbe\u5907\u76f8\u5173\u7684IOCTL\u4f20\u9012\u7ed9\u7528\u6237\u6001\u3002<code>drm_device</code>\u4e2d\u5b58\u5728vma_offset_manager\u7528\u4e8e\u7edf\u4e00\u7ba1\u7406mmap\u7684\u865a\u62dfoffset\uff0c\u5176\u540e\u7aef\u57fa\u672c\u4e0a\u4e3adrm_mm\u4e0e\u7ea2\u9ed1\u6811\u7f13\u5b58\u7684\u7ec4\u5408</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#dumb","title":"DUMB","text":""},{"location":"Linux/DRM/2.1%20drm-gem/#gbm","title":"GBM","text":"<p>\u524d\u9762\u770b\u5230\u57fa\u4e8eGEM\u7684\u9a71\u52a8\u5bf9\u5916\u662f\u6ca1\u6709\u63d0\u4f9b\u7edf\u4e00\u7684\u5185\u5b58\u7ba1\u7406\u63a5\u53e3\u7684\uff0c\u81f3\u5c11Buffer Object\u521b\u5efa\u9500\u6bc1\u7b49\u64cd\u4f5c\u662f\u9700\u8981\u81ea\u884c\u63d0\u4f9b\u8bbe\u5907\u76f8\u5173\u7684\u5373\u53e3\u8fdb\u884c\u5b9e\u73b0\u7684\u3002\u7528\u6237\u6001\u6ca1\u6709\u7edf\u4e00\u7684\u63a5\u53e3\u5bf9\u7f13\u51b2\u533a\u8fdb\u884c\u7ba1\u7406\uff0c\u8fd9\u5bfc\u81f4\u67d0\u4e9b\u7279\u5b9a\u7528\u6237\u6001\u7a0b\u5e8f\u7684\u5f00\u53d1\u7684\u56f0\u96be\uff0c\u5982wayland compositor\u3002MESA\u9879\u76ee\u63d0\u4f9b\u4e86libgbm\uff0c\u62bd\u8c61\u5e76\u5b9e\u73b0\u4e86\u4e00\u4e2a\u901a\u7528\u7684buffer\u7ba1\u7406API\u3002\u8fd9\u91cc\u8bb0\u5f55\u5bf9\u8be5API\u8fdb\u884c\u7684\u63a2\u8ba8\u3002</p> <p>\u7ecf\u8fc7\u4ee3\u7801\u5206\u6790\uff0cgbm\u5b9e\u9645\u4e0a\u6765\u6e90\u4e8eMESA\u5185\u5b58OpenGL\u5b9e\u73b0\u7684<code>internal/drm_interface.h</code>\uff0c\u4e5f\u5c31\u662fMesa OpenGL\u5b9e\u73b0\u7684\u4e00\u4e2a\u79c1\u6709\u517c\u5bb9\u5c42\u3002</p>"},{"location":"Linux/DRM/2.1%20drm-gem/#gbm_device","title":"gbm_device","text":"<p><code>gbm_device</code>\u662fDRM\u8bbe\u5907\u7684\u62bd\u8c61\uff0c\u7ba1\u7406\u6240\u6709\u7684\u5206\u914d\u51fa\u6765\u7684BO\uff08Buffer Object\uff09\u3002\u81ea\u7136\u800c\u7136\uff1a</p>"},{"location":"Linux/DRM/2.2%20drm-gem-prime/","title":"drm: base prime/dma-buf support","text":"<pre><code>From: Dave Airlie &lt;airlied@redhat.com&gt;\n\nThis adds the basic drm dma-buf interface layer, called PRIME,\n\nThe main APIs exposed to userspace allow translating a 32-bit object handle\nto a file descriptor, and a file descriptor to a 32-bit object handle.\n\nThe flags value is currently limited to O_CLOEXEC.\n\nAcknowledgements:\nDaniel Vetter: lots of review\nRob Clark: cleaned up lots of the internals and did lifetime review.\n\nThis is what I intend to send to Linus to form the basis for prime work\nin the drivers.\n\nSigned-off-by: Dave Airlie &lt;airlied@redhat.com&gt;\n</code></pre> <p>\u9996\u5148\u5728drm_open\u65f6\uff0c\u68c0\u67e5DRIVER_PRIME feature,\u5e76\u521d\u59cb\u5316priv-&gt;prime\u7ed3\u6784\u4f53\uff0c <code>drm_prime_init_file_private(&amp;priv-&gt;prime);</code> \u5176\u6b21\uff0c\u589e\u52a0\u4e24\u4e2aIOCTL\uff0c\u66b4\u9732\u7ed9\u7528\u6237\u7a7a\u95f4 <pre><code>DRM_IOCTL_DEF(DRM_IOCTL_PRIME_HANDLE_TO_FD, drm_prime_handle_to_fd_ioctl, DRM_AUTH|DRM_UNLOCKED),\nDRM_IOCTL_DEF(DRM_IOCTL_PRIME_FD_TO_HANDLE, drm_prime_fd_to_handle_ioctl, DRM_AUTH|DRM_UNLOCKED)\n</code></pre> \u5bf9\u4e8edrm_gem_prime_handle_to_fd, \u9700\u8981\u5c06device\u7684BO export\u51fa\u53bb\uff0c\u6240\u4ee5\u5f53\u4f20\u5165\u4e00\u4e2ahandle\u4e4b\u540e\uff0c\u901a\u8fc7per device \u53d8\u91cfhandle\u9996\u5148\u7d22\u5f15\u5230\u9700\u8981export\u7684BO\uff0c <pre><code>int drm_gem_prime_handle_to_fd(struct drm_device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 struct drm_file *file_priv, uint32_t handle, uint32_t flags,\n\u00a0 \u00a0 \u00a0 \u00a0 int *prime_fd)\n{\n\u00a0 \u00a0 struct drm_gem_object *obj;\n\u00a0 \u00a0 obj = drm_gem_object_lookup(dev, file_priv, handle);\n\u00a0 \u00a0 if (!obj)\n\u00a0 \u00a0 \u00a0 \u00a0 return -ENOENT;\n\n\u00a0 \u00a0 /* \u68c0\u67e5import_attach,\u4e0d\u5141\u8bb8\u5df2\u7ecfimport\u7684bo\u518d\u6b21\u88abexport */\n\u00a0 \u00a0 if (obj-&gt;import_attach) {\n\u00a0 \u00a0 \u00a0 \u00a0 drm_gem_object_unreference_unlocked(obj);\n\u00a0 \u00a0 \u00a0 \u00a0 return -EINVAL;\n\u00a0 \u00a0 }\n\u00a0 \u00a0 \n\u00a0 \u00a0 /* \u68c0\u67e5export_dma_buf, \u5982\u679c\u5df2\u7ecf\u88abexport\u5219\u76f4\u63a5\u83b7\u53d6prime_fd */\n\u00a0 \u00a0 if (obj-&gt;export_dma_buf) {\n\u00a0 \u00a0 \u00a0 \u00a0 get_file(obj-&gt;export_dma_buf-&gt;file);\n\u00a0 \u00a0 \u00a0 \u00a0 *prime_fd = dma_buf_fd(obj-&gt;export_dma_buf, flags);\n\u00a0 \u00a0 \u00a0 \u00a0 drm_gem_object_unreference_unlocked(obj);\n\u00a0 \u00a0 } else {\n\u00a0 \u00a0  /* \u5426\u5219,\u6267\u884cexport\u6d41\u7a0b, \u8c03\u7528gem_prime_export\u8d4b\u503cexport_dma_buf*/\n\u00a0 \u00a0 \u00a0 \u00a0 obj-&gt;export_dma_buf =\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dev-&gt;driver-&gt;gem_prime_export(dev, obj, flags);\n\u00a0 \u00a0 \u00a0 \u00a0 if (IS_ERR_OR_NULL(obj-&gt;export_dma_buf)) {\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 drm_gem_object_unreference_unlocked(obj);\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return PTR_ERR(obj-&gt;export_dma_buf);\n\u00a0 \u00a0 \u00a0 \u00a0 }\n\u00a0 \u00a0 \u00a0 \u00a0 *prime_fd = dma_buf_fd(obj-&gt;export_dma_buf, flags);\n\u00a0 \u00a0 }\n\u00a0 \u00a0 return 0;\n}\nEXPORT_SYMBOL(drm_gem_prime_handle_to_fd);\n</code></pre></p> <p>\u76f8\u53cd\u7684\u63a5\u53e3drm_gem_prime_fd_to_handle,\u5219\u662f\u5c06BO import\u8fdb\u6765\uff0c\u65e0\u8bba\u662f\u53e6\u4e00\u4e2adevice\u8fd8\u662f\u540c\u4e00device\u3002 <pre><code>int drm_gem_prime_fd_to_handle(struct drm_device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 struct drm_file *file_priv, int prime_fd, uint32_t *handle)\n{\n\u00a0 \u00a0 struct dma_buf *dma_buf;\n\u00a0 \u00a0 struct drm_gem_object *obj;\n\u00a0 \u00a0 int ret;\n\n\u00a0 \u00a0 /* \u4ece\u4f20\u5165\u7684prime_fd\u8f6c\u6362\u5230dma_buf */\n\u00a0 \u00a0 dma_buf = dma_buf_get(prime_fd);\n\u00a0 \u00a0 if (IS_ERR(dma_buf))\n\u00a0 \u00a0 \u00a0 \u00a0 return PTR_ERR(dma_buf);\n\u00a0 \u00a0 /* \u4ece\u5f53\u524ddevice\u7684prime\u94fe\u8868\u4e2d\u67e5\u627edma_buf\uff0c\u6210\u529f\u5219\u76f4\u63a5\u8fd4\u56de */\n\u00a0 \u00a0 ret = drm_prime_lookup_fd_handle_mapping(&amp;file_priv-&gt;prime,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dma_buf, handle);\n\u00a0 \u00a0 if (!ret) {\n\u00a0 \u00a0 \u00a0 \u00a0 dma_buf_put(dma_buf);\n\u00a0 \u00a0 \u00a0 \u00a0 return 0;\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 /* \u5426\u5219\uff0cdma_buf\u5c5e\u4e8e\u53e6\u5916device\uff0c\u8c03\u7528gem_prime_import\u5bfc\u5165\u8be5dma_buf\u4e3aobj */\n\u00a0 \u00a0 obj = dev-&gt;driver-&gt;gem_prime_import(dev, dma_buf);\n\u00a0 \u00a0 if (IS_ERR_OR_NULL(obj)) {\n\u00a0 \u00a0 \u00a0 \u00a0 ret = PTR_ERR(obj);\n\u00a0 \u00a0 \u00a0 \u00a0 goto fail_put;\n\u00a0 \u00a0 }\n\u00a0 \u00a0 /* \u4e3a\u5bfc\u5165\u7684obj\u521b\u5efagem\u63a5\u53e3 */\n\u00a0 \u00a0 ret = drm_gem_handle_create(file_priv, obj, handle);\n\u00a0 \u00a0 drm_gem_object_unreference_unlocked(obj);\n\u00a0 \u00a0 if (ret)\n\u00a0 \u00a0 \u00a0 \u00a0 goto fail_put;\n\u00a0 \u00a0 /* \u5c06\u5bfc\u5165\u7684dma_buf\u63a5\u5165\u5230\u8be5device\u7684prime\u94fe\u8868 */\n\u00a0 \u00a0 ret = drm_prime_insert_fd_handle_mapping(&amp;file_priv-&gt;prime,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 dma_buf, *handle);\n\u00a0 \u00a0 if (ret)\n\u00a0 \u00a0 \u00a0 \u00a0 goto fail;\n\n\u00a0 \u00a0 return 0;\n\nfail:\n\u00a0 \u00a0 drm_gem_object_handle_unreference_unlocked(obj);\nfail_put:\n\u00a0 \u00a0 dma_buf_put(dma_buf);\n\u00a0 \u00a0 return ret;\n}\nEXPORT_SYMBOL(drm_gem_prime_fd_to_handle);\n</code></pre></p>"},{"location":"Linux/DRM/2.2%20drm-gem-prime/#prime-helper-functions","title":"PRIME Helper Functions","text":"<ul> <li>gem_prime_get_sg_table: provide a scatter/gather table of pinned pages</li> <li>gem_prime_vmap: vmap a buffer exported by your driver</li> </ul> <p>\u8be5\u52a9\u624b\u7a0b\u5e8f\u4ece\u4e00\u7ec4\u9875\u9762\u521b\u5efa\u4e00\u4e2a sg \u8868\u5bf9\u8c61\uff0c\u9a71\u52a8\u7a0b\u5e8f\u8d1f\u8d23\u5c06\u8fd9\u4e9b\u9875\u9762\u6620\u5c04\u5230\u5bfc\u5165\u5668\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u4f9b dma_buf \u672c\u8eab\u4f7f\u7528\u3002 <pre><code>struct sg_table *drm_prime_pages_to_sg(struct page **pages, int nr_pages)\n{\n\u00a0 \u00a0 struct sg_table *sg = NULL;\n\u00a0 \u00a0 struct scatterlist *iter;\n\u00a0 \u00a0 int i;\n\u00a0 \u00a0 int ret;\n\n\u00a0 \u00a0 sg = kzalloc(sizeof(struct sg_table), GFP_KERNEL);\n\u00a0 \u00a0 if (!sg)\n\u00a0 \u00a0 \u00a0 \u00a0 goto out;\n\n\u00a0 \u00a0 ret = sg_alloc_table(sg, nr_pages, GFP_KERNEL);\n\u00a0 \u00a0 if (ret)\n\u00a0 \u00a0 \u00a0 \u00a0 goto out;\n\n\u00a0 \u00a0 for_each_sg(sg-&gt;sgl, iter, nr_pages, i)\n\u00a0 \u00a0 \u00a0 \u00a0 sg_set_page(iter, pages[i], PAGE_SIZE, 0);\n\n\u00a0 \u00a0 return sg;\nout:\n\u00a0 \u00a0 kfree(sg);\n\u00a0 \u00a0 return NULL;\n}\nEXPORT_SYMBOL(drm_prime_pages_to_sg);\n</code></pre></p> <p>drm_gem_dmabuf_export -&gt; drm_gem_dmabuf_export -&gt; dma_buf_export</p> <pre><code>struct dma_buf *drm_gem_dmabuf_export(struct drm_device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 struct dma_buf_export_info *exp_info)\n{\n\u00a0 \u00a0 struct drm_gem_object *obj = exp_info-&gt;priv;\n\u00a0 \u00a0 struct dma_buf *dma_buf;\n\n\u00a0 \u00a0 dma_buf = dma_buf_export(exp_info);\n\u00a0 \u00a0 if (IS_ERR(dma_buf))\n\u00a0 \u00a0 \u00a0 \u00a0 return dma_buf;\n\n\u00a0 \u00a0 drm_dev_get(dev);\n\u00a0 \u00a0 drm_gem_object_get(obj);\n\u00a0 \u00a0 dma_buf-&gt;file-&gt;f_mapping = obj-&gt;dev-&gt;anon_inode-&gt;i_mapping;\n\n\u00a0 \u00a0 return dma_buf;\n}\nEXPORT_SYMBOL(drm_gem_dmabuf_export);\n</code></pre> <pre><code>struct dma_buf *drm_gem_prime_export(struct drm_gem_object *obj,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0int flags)\n{\n\u00a0 \u00a0 struct drm_device *dev = obj-&gt;dev;\n\u00a0 \u00a0 struct dma_buf_export_info exp_info = {\n\u00a0 \u00a0 \u00a0 \u00a0 .exp_name = KBUILD_MODNAME, /* white lie for debug */\n\u00a0 \u00a0 \u00a0 \u00a0 .owner = dev-&gt;driver-&gt;fops-&gt;owner,\n\u00a0 \u00a0 \u00a0 \u00a0 .ops = &amp;drm_gem_prime_dmabuf_ops,\n\u00a0 \u00a0 \u00a0 \u00a0 .size = obj-&gt;size,\n\u00a0 \u00a0 \u00a0 \u00a0 .flags = flags,\n\u00a0 \u00a0 \u00a0 \u00a0 .priv = obj,\n\u00a0 \u00a0 \u00a0 \u00a0 .resv = obj-&gt;resv,\n\u00a0 \u00a0 };\n\n\u00a0 \u00a0 return drm_gem_dmabuf_export(dev, &amp;exp_info);\n}\nEXPORT_SYMBOL(drm_gem_prime_export);\n</code></pre> <p>amdgpu_gem_prime_import -&gt; drm_gem_prime_import -&gt; dma_buf_attach -&gt; amdgpu_gem_prime_import_sg_table Import BO\u4ee3\u8868\u8be5\u8bbe\u5907\u5f15\u5165\u5176\u4ed6\u7684BO\uff0c\u8be5\u64cd\u4f5c\u5e94\u8be5\u589e\u52a0BO\u7684\u5f15\u7528\u8ba1\u6570\uff0c\u4fdd\u8bc1BO\u4e0d\u4f1a\u88ab\u91ca\u653e\u3002 <pre><code>struct drm_gem_object *drm_gem_prime_import_dev(struct drm_device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 struct dma_buf *dma_buf,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 struct device *attach_dev)\n{\n\u00a0 \u00a0 struct dma_buf_attachment *attach;\n\u00a0 \u00a0 struct sg_table *sgt;\n\u00a0 \u00a0 struct drm_gem_object *obj;\n\u00a0 \u00a0 int ret;\n\n\u00a0 \u00a0 if (dma_buf-&gt;ops == &amp;drm_gem_prime_dmabuf_ops) {\n\u00a0 \u00a0 \u00a0 \u00a0 obj = dma_buf-&gt;priv;\n\u00a0 \u00a0 \u00a0 \u00a0 if (obj-&gt;dev == dev) {\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 /*\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0* Importing dmabuf exported from our own gem increases\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0* refcount on gem itself instead of f_count of dmabuf.\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0*/\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 drm_gem_object_get(obj);\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 return obj;\n\u00a0 \u00a0 \u00a0 \u00a0 }\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 if (!dev-&gt;driver-&gt;gem_prime_import_sg_table)\n\u00a0 \u00a0 \u00a0 \u00a0 return ERR_PTR(-EINVAL);\n\n\u00a0 \u00a0 attach = dma_buf_attach(dma_buf, attach_dev);\n\u00a0 \u00a0 if (IS_ERR(attach))\n\u00a0 \u00a0 \u00a0 \u00a0 return ERR_CAST(attach);\n\n\u00a0 \u00a0 get_dma_buf(dma_buf);\n\u00a0 \u00a0 sgt = dma_buf_map_attachment_unlocked(attach, DMA_BIDIRECTIONAL);\n\u00a0 \u00a0 if (IS_ERR(sgt)) {\n\u00a0 \u00a0 \u00a0 \u00a0 ret = PTR_ERR(sgt);\n\u00a0 \u00a0 \u00a0 \u00a0 goto fail_detach;\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 obj = dev-&gt;driver-&gt;gem_prime_import_sg_table(dev, attach, sgt);\n\u00a0 \u00a0 if (IS_ERR(obj)) {\n\u00a0 \u00a0 \u00a0 \u00a0 ret = PTR_ERR(obj);\n\u00a0 \u00a0 \u00a0 \u00a0 goto fail_unmap;\n\u00a0 \u00a0 }\n\n\u00a0 \u00a0 obj-&gt;import_attach = attach;\n\u00a0 \u00a0 obj-&gt;resv = dma_buf-&gt;resv;\n\u00a0 \u00a0 return obj;\n\nfail_unmap:\n\u00a0 \u00a0 dma_buf_unmap_attachment_unlocked(attach, sgt, DMA_BIDIRECTIONAL);\nfail_detach:\n\u00a0 \u00a0 dma_buf_detach(dma_buf, attach);\n\u00a0 \u00a0 dma_buf_put(dma_buf);\n\n\u00a0 \u00a0 return ERR_PTR(ret);\n}\nEXPORT_SYMBOL(drm_gem_prime_import_dev);\n</code></pre></p> <pre><code>struct drm_gem_object *\namdgpu_gem_prime_import_sg_table(struct drm_device *dev,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0struct dma_buf_attachment *attach,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0struct sg_table *sg)\n{\n\u00a0 \u00a0 struct dma_resv *resv = attach-&gt;dmabuf-&gt;resv;\n\u00a0 \u00a0 struct amdgpu_device *adev = drm_to_adev(dev);\n\u00a0 \u00a0 struct amdgpu_bo *bo;\n\u00a0 \u00a0 struct amdgpu_bo_param bp;\n\u00a0 \u00a0 int ret;\n\n\u00a0 \u00a0 memset(&amp;bp, 0, sizeof(bp));\n\u00a0 \u00a0 bp.size = attach-&gt;dmabuf-&gt;size;\n\u00a0 \u00a0 bp.byte_align = PAGE_SIZE;\n\u00a0 \u00a0 bp.domain = AMDGPU_GEM_DOMAIN_CPU;\n\u00a0 \u00a0 bp.flags = 0;\n\u00a0 \u00a0 bp.type = ttm_bo_type_sg;\n\u00a0 \u00a0 bp.resv = resv;\n\u00a0 \u00a0 bp.bo_ptr_size = sizeof(struct amdgpu_bo);\n\u00a0 \u00a0 dma_resv_lock(resv, NULL);\n\u00a0 \u00a0 ret = amdgpu_bo_create(adev, &amp;bp, &amp;bo);\n\u00a0 \u00a0 if (ret)\n\u00a0 \u00a0 \u00a0 \u00a0 goto error;\n\n\u00a0 \u00a0 bo-&gt;tbo.sg = sg;\n\u00a0 \u00a0 bo-&gt;tbo.ttm-&gt;sg = sg;\n\u00a0 \u00a0 bo-&gt;allowed_domains = AMDGPU_GEM_DOMAIN_GTT;\n\u00a0 \u00a0 bo-&gt;preferred_domains = AMDGPU_GEM_DOMAIN_GTT;\n\u00a0 \u00a0 dma_resv_unlock(resv);\n\u00a0 \u00a0 return &amp;bo-&gt;tbo.base;\n\nerror:\n\u00a0 \u00a0 dma_resv_unlock(resv);\n\u00a0 \u00a0 return ERR_PTR(ret);\n}\n</code></pre>"},{"location":"Linux/DRM/2.4%20vgem/","title":"2.4 vgem","text":"<p>\u9a71\u52a8 drivers/gpu/drm/vgem/vgem_drv.c \u6d4b\u8bd5 tools/testing/selftests/dmabuf-heaps/dmabuf-heap.c</p> <pre><code>static int __init vgem_init(void)\n{\n\u00a0 \u00a0 struct platform_device *pdev;\n\u00a0 \u00a0 pdev = platform_device_register_simple(\"vgem\", -1, NULL, 0);\n\n    /* \u8bbe\u7f6edevice\u7684dma\u53c2\u6570*/\n\u00a0 \u00a0 dma_coerce_mask_and_coherent(&amp;pdev-&gt;dev,\u00a0DMA_BIT_MASK(64));\n\u00a0 \u00a0 vgem_device = devm_drm_dev_alloc(&amp;pdev-&gt;dev, &amp;vgem_driver,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0struct vgem_device, drm);\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0\n    ret = drm_dev_register(&amp;vgem_device-&gt;drm, 0);\n......\n</code></pre>"},{"location":"Linux/DRM/2.4%20vgem/#vgem_device","title":"vgem_device","text":"<pre><code>static struct vgem_device {\n\u00a0 \u00a0 struct drm_device drm;\n\u00a0 \u00a0 struct platform_device *platform;\n} *vgem_device;\n</code></pre>"},{"location":"Linux/DRM/2.4%20vgem/#vgem_driver","title":"vgem_driver","text":"<pre><code>static const struct drm_driver vgem_driver = {\n\u00a0 \u00a0 .driver_features \u00a0 \u00a0 \u00a0 \u00a0= DRIVER_GEM | DRIVER_RENDER,\n\u00a0 \u00a0 .open \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = vgem_open,\n\u00a0 \u00a0 .postclose \u00a0 \u00a0 \u00a0 \u00a0 \u00a0= vgem_postclose,\n\u00a0 \u00a0 .ioctls \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = vgem_ioctls,\n\u00a0 \u00a0 .num_ioctls \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = ARRAY_SIZE(vgem_ioctls),\n\u00a0 \u00a0 .fops \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = &amp;vgem_driver_fops,\n\n\u00a0 \u00a0 /* DRM_GEM_SHMEM_DRIVER_OPS */\n\u00a0 \u00a0 .gem_prime_import_sg_table = drm_gem_shmem_prime_import_sg_table,\n\u00a0 \u00a0 .dumb_create \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 = drm_gem_shmem_dumb_create,\n\u00a0 \u00a0 .gem_create_object \u00a0 \u00a0 \u00a0= vgem_gem_create_object,\n......\n</code></pre> <p>\u9996\u5148\u5206\u6790 DRIVER_GEM, </p>"},{"location":"Linux/DRM/2.6%20ttm_pool/","title":"2.6 ttm pool","text":"<p>\u4ece\u5f15\u5165\u8be5feature\u7684\u7b2c\u4e00\u7b14patch\u770b\u8d77\u3002\u7531\u4e8edgpu\u7684\u663e\u5b58\u7ba1\u7406\u7531drm_mm\u66f4\u65b0\u5230drm_buddy\uff0c\u4e3a\u4e86\u66f4\u597d\u5229\u7528buddy\u9875\u9762\uff0c\u5141\u8bb8\u66f4\u5927\u7684\u7269\u7406\u8fde\u7eed\u5206\u914d\uff0c\u589e\u52a0TLB\u7684\u5229\u7528\u7387\uff0cChristian\u63d0\u51fa\u4e86ttm_pool.</p>"},{"location":"Linux/DRM/2.6%20ttm_pool/#drmttm-new-tt-backend-allocation-pool","title":"drm/ttm: new TT backend allocation pool","text":"<pre><code>This replaces the spaghetti code in the two existing page pools.\n\nFirst of all depending on the allocation size it is between 3 (1GiB) and\n5 (1MiB) times faster than the old implementation.\n\nIt makes better use of buddy pages to allow for larger physical contiguous\nallocations which should result in better TLB utilization at least for amdgpu.\n\nInstead of a completely braindead approach of filling the pool with one CPU\nwhile another one is trying to shrink it we only give back freed pages.\n\nThis also results in much less locking contention and a trylock free MM\nshrinker callback, so we can guarantee that pages are given back to the system\nwhen needed.\n\nDownside of this is that it takes longer for many small allocations until the\npool is filled up. We could address this, but I couldn't find an use case\nwhere this actually matters. And we don't bother freeing large chunks of pages\nany more.\n\nThe sysfs files are replaced with a single module parameter, allowing users to\noverride how many pages should be globally pooled in TTM. This unfortunately\nbreaks the UAPI slightly, but as far as we know nobody ever depended on this.\n\nZeroing memory coming from the pool was handled inconsistently. The\nalloc_pages() based pool was zeroing it, the dma_alloc_attr() based one wasn't.\nThe new implementation isn't zeroing pages from the pool either and only sets\nthe __GFP_ZERO flag when necessary.\n\nThe implementation has only 753 lines of code compared to the over 2600 of the\nold one, and also allows for saving quite a bunch of code in the drivers since\nwe don't need specialized handling there any more based on kernel config.\n\nAdditional to all of that there was a neat bug with IOMMU, coherent DMA\nmappings and huge pages which is now fixed in the new code as well.\n\nPlease review and comment,\nChristian.\n</code></pre> <p>ttm_tt_populate -&gt; amdgpu_ttm_tt_populate -&gt; ttm_pool_alloc</p> <p>ttm_pool_alloc \u4f5c\u4e3a\u663e\u5b58\u5206\u914d\u7684help\u51fd\u6570</p>"},{"location":"Linux/DRM/Overview/","title":"Overview","text":"<p>DRM\u662flinux\u5185\u6838\u5b50\u7cfb\u7edf\uff0c\u8d1f\u8d23\u4e0e\u663e\u5361\u4ea4\u4e92\u3002DRM\u63d0\u4f9b\u4e86\u4e00\u7ec4API\uff0c\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528\u8be5API\u5c06\u547d\u4ee4\u5475\u62a4\u6570\u636e\u53d1\u9001\u5230GPU\u5e76\u6267\u884c\u8bf8\u5982\u914d\u7f6e\u663e\u793a\u5668\u7684\u6a21\u5f0f\u8bbe\u7f6e\u4e4b\u7c7b\u7684\u64cd\u4f5c\u3002</p> <p>Linux \u5185\u6838\u5df2\u7ecf\u6709fbdev\u7684API\uff0c\u4f46\u662f\u4e0d\u80fd\u6ee1\u8db33D\u52a0\u901f\u9700\u6c42 \u5f53\u4e24\u4e2a\u6216\u591a\u4e2a\u7a0b\u5e8f\u8bd5\u56fe\u540c\u65f6\u63a7\u5236\u76f8\u540c\u7684\u786c\u4ef6\uff0c\u4f1a\u5bfc\u81f4\u95ee\u9898\u3002 DRM\u7684\u521b\u5efa\u65f6\u4e3a\u4e86\u5141\u8bb8\u591a\u4e2a\u7a0b\u5e8f\u540c\u65f6\u4f7f\u7528\u89c6\u9891\u786c\u4ef6\u8d44\u6e90\u3002DRM\u83b7\u5f97\u5bf9GPU\u7684\u72ec\u5360\u8bbf\u95ee\u6743\uff0c\u5e76\u8d1f\u8d23\u521d\u59cb\u8bdd\u548c\u7ef4\u62a4\u547d\u4ee4\u961f\u5217\uff0c\u5185\u5b58\u548c\u4efb\u4f55\u5176\u4ed6\u8d44\u6e90\u3002\u5e0c\u671b\u4f7f\u7528GPU\u7684\u7a0b\u5e8f\u5c06\u8bf7\u6c42\u53d1\u9001\u5200\u7247DRM\uff0cDRM\u5145\u5f53\u4ef2\u88c1\u7a0b\u5e8f\uff0c\u5e76\u89c4\u907f\u53ef\u80fd\u7684\u51b2\u7a81</p> <p>\u591a\u5e74\u6765\uff0cDRM\u7684\u8303\u56f4\u5df2\u5f97\u5230\u6269\u5c55\uff0c\u4ee5\u6db5\u76d6\u4ee5\u524d\u7531\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u5904\u7406\u7684\u591a\u91cd\u529f\u80fd\uff0c\u4f8b\u5982==framebuffer\u7ba1\u7406==\u548c\u6a21\u5f0f\u8bbe\u7f6e\uff0c\u5185\u5b58\u5171\u4eab\u5bf9\u8c61==\u548c==\u5185\u5b58\u540c\u6b65\u3002\u8fd9\u4e9b\u6269\u5c55\u4e2d\u7684\u67d0\u4e9b\u88ab\u8d4b\u4e88\u7279\u5b9a\u7684\u540d\u79f0\uff0c\u4f8b\u5982 \u56fe\u5f62\u6267\u884c\u7ba1\u7406\u5668(GEM) \u6216 \u5185\u6838\u6a21\u5f0f\u8bbe\u7f6e(KMS)</p>"},{"location":"Linux/DRM/Overview/#software-architecture","title":"Software architecture","text":"<p>DRM\u9a7b\u7559\u5728\u5185\u6838\u7a7a\u95f4\u4e2d\uff0c\u56e0\u6b64\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u5fc5\u987b\u4f7f\u7528\u5185\u6838\u7cfb\u7edf\u8c03\u7528\u6765\u8bf7\u6c42\u5176\u670d\u52a1\u3002\u4f46\u662fDRM\u6ca1\u6709\u5b9a\u4e49\u81ea\u5df1\u7684\u81ea\u5b9a\u4e49\u8c03\u7528\u3002\u76f8\u53cd\uff0c\u5b83\u9075\u5faaUnix\u539f\u5219\u201c\u4e00\u5207\u7686\u6587\u4ef6\u201d\uff0c\u4f7f\u7528/dev\u5c42\u6b21\u7ed3\u6784\u4e0b\u7684\u8bbe\u5907\u6587\u4ef6\u901a\u8fc7\u6587\u4ef6\u7cfb\u7edf\u540d\u79f0\u7a7a\u95f4\u516c\u5f00GPU\u3002DRM\u68c0\u6d4b\u5230\u7684\u6bcf\u4e2aGPU\u90fd\u79f0\u4e3aDRM\u8bbe\u5907\uff0c\u5e76\u521b\u5efa\u4e86\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6/dev/dri/cardX\uff08X\u662f\u4e00\u4e2a\u5e8f\u5217\u53f7\uff09\u4e0e\u4e4b\u8fde\u63a5\uff0c\u5e76\u4f7f\u7528ioctl\u8c03\u7528\u4e0eDRM\u8fdb\u884c\u901a\u4fe1\u3002\u4e0d\u540c\u7684ioctl\u5bf9\u5e94\u4e8eDRM API\u7684\u4e0d\u540c\u529f\u80fd\u3002</p> <p>\u521b\u5efa\u4e86\u4e00\u4e2a\u540d**\u4e3a==libdrm==\u7684\u5e93**\uff0c\u4ee5\u65b9\u4fbf\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u4e0eDRM\u5b50\u7cfb\u7edf\u7684\u63a5\u53e3\u3002\u8be5\u5e93\u53ea\u662f\u4e00\u4e2a\u5305\u88c5\u5668\uff0c\u5b83\u4e3aDRM API\u7684\u6bcf\u4e2aioctl\u63d0\u4f9b\u7528C\u7f16\u5199\u7684\u51fd\u6570\uff0c\u4ee5\u53ca\u5e38\u91cf\u3001\u7ed3\u6784\u548c\u5176\u4ed6\u8f85\u52a9\u5143\u7d20\u3002\u4f7f\u7528libdrm\u4e0d\u4ec5\u907f\u514d\u5c06\u5185\u6838\u63a5\u53e3\u76f4\u63a5\u66b4\u9732\u7ed9\u5e94\u7528\u7a0b\u5e8f\uff0c\u800c\u4e14\u8fd8\u63d0\u4f9b\u4e86\u5728\u7a0b\u5e8f\u4e4b\u95f4\u91cd\u7528\u548c\u5171\u4eab\u4ee3\u7801\u7684\u4f18\u70b9\u3002</p> <p>DRM\u7531\u4e24\u90e8\u5206\u7ec4\u6210\uff1a\u901a\u7528\u201cDRM core\u201d\u548c\u6bcf\u79cd\u53d7\u652f\u6301\u7684\u7279\u5b9a\u90e8\u5206\uff08\u201cDRM Driver\u201d\uff09\u3002DRM core\u63d0\u4f9b\u4e86\u53ef\u4ee5\u6ce8\u518c\u4e0d\u540cDRM\u9a71\u52a8\u7a0b\u5e8f\u7684\u57fa\u672c\u6846\u67b6\uff0c\u8fd8\u4e3a\u7528\u6237\u7a7a\u95f4\u63d0\u4f9b\u4e86\u5177\u6709\u901a\u7528\u7684\uff0c\u72ec\u7acb\u4e8e\u786c\u4ef6\u7684\uff0c\u529f\u80fd\u7684\u6700\u5c11ioctl\u96c6\u3002\u53e6\u4e00\u65b9\u9762\uff0cDRM Driver\u5b9e\u73b0API\u7684\u786c\u4ef6\u76f8\u5173\u90e8\u5206\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5b83\u6240\u652f\u6301\u7684GPU\u7c7b\u578b\uff0c\u5b83\u5e94\u63d0\u4f9bDRM\u6838\u5fc3\u672a\u6db5\u76d6\u7684\u5176\u4f59ioctl\u7684\u5b9e\u73b0\u3002</p> <p>DRM\u9a71\u52a8\u4e5f\u53ef\u4ee5\u6269\u5c55API\uff0c\u63d0\u4f9b\u7279\u5b9aGPU\u4e0a\u53ef\u7528\u7684\u5177\u6709\u9644\u52a0\u529f\u80fd\u7684\u9644\u52a0ioctl\u3002\u5f53\u7279\u5b9a\u7684DRM\u9a71\u52a8\u7a0b\u5e8f\u63d0\u4f9b\u589e\u5f3a\u7684API\u65f6\uff0c\u7528\u6237\u7a7a\u95f4libdrm\u4e5f\u5c06\u901a\u8fc7\u4e00\u4e2a\u989d\u5916\u7684\u5e93libdrm-driver\u6269\u5c55\uff0c\u8fd9\u4e2a\u6269\u5c55\u5e93\u53ef\u4ee5\u88ab\u7528\u6237\u7a7a\u95f4\u7528\u6765\u8c03\u7528\u5176\u4ed6ioctl\u63a5\u53e3\u3002</p>"},{"location":"Linux/DRM/Overview/#api","title":"API","text":"<p>DRM Core\u5c06\u51e0\u4e2a\u63a5\u53e3\u5bfc\u51fa\u5230\u7528\u6237\u7a7a\u95f4\u5e94\u7528\u7a0b\u5e8f\uff0c\u8ba9\u76f8\u5e94\u7684libdrm\u5305\u88c5\u6210\u51fd\u6570\u540e\u6765\u4f7f\u7528\u3002 DRM Driver\u901a\u8fc7ioctl\u548csysfs\u6587\u4ef6\u5bfc\u51fa\u8bbe\u5907\u4e13\u7528\u7684\u63a5\u53e3\uff0c\u4f9b\u7528\u6237\u7a7a\u95f4\u9a71\u52a8\u7a0b\u5e8f\u548c\u652f\u6301\u8bbe\u5907\u7684\u5e94\u7528\u7a0b\u5e8f\u4f7f\u7528\u3002\u5916\u90e8\u63a5\u53e3\u5305\u62ec\uff1a\u5185\u5b58\u6620\u5c04\uff0c\u4e0a\u4e0b\u6587\u7ba1\u7406\uff0cDMA\u64cd\u4f5c\uff0cAGP\u7ba1\u7406\uff0cvblank\u63a7\u5236\uff0cfence\u7ba1\u7406\uff0c\u5185\u5b58\u7ba1\u7406\u548c\u8f93\u51fa\u7ba1\u7406\u3002</p>"},{"location":"Linux/DRM/Overview/#gem","title":"GEM","text":"<p>Graphics Execution Manager\uff08GEM\uff09\u662f\u4e00\u79cd\u5185\u5b58\u7ba1\u7406\u65b9\u6cd5\u3002\u7531\u4e8e\u89c6\u9891\u5b58\u50a8\u5668\u7684\u5927\u5c0f\u589e\u52a0\u4ee5\u53ca\u8bf8\u5982OpenGL\u4e4b\u7c7b\u7684\u56fe\u5f62API\u7684\u65e5\u76ca\u590d\u6742\u6027\uff0c\u4ece\u6027\u80fd\u89d2\u5ea6\u770b\uff0c\u5728\u6bcf\u4e2a\u4e0a\u4e0b\u6587\u5207\u6362\u5904\u91cd\u65b0\u521d\u59cb\u5316\u56fe\u5f62\u5361\u72b6\u6001\u7684\u7b56\u7565\u8fc7\u4e8e\u4f4e\u6548\u3002\u53e6\u5916\uff0c\u73b0\u4ee3linux\u684c\u9762\u8fd8\u9700\u8981\u4e00\u79cd\u6700\u4f73\u65b9\u5f0f\u4e0e\u5408\u6210\u7ba1\u7406\u5668\uff08compositing manager\uff09\u5171\u4eab\u5c4f\u5e55\u5916\u7f13\u51b2\u533a\u3002\u8fd9\u4e9b\u8981\u6c42\u8bde\u751f\u5f00\u53d1\u4e86\u7528\u4e8e\u7ba1\u7406\u5185\u6838\u5185\u90e8\u56fe\u5f62\u7f13\u51b2\u533a\u7684\u65b0\u65b9\u6cd5\uff0c\u56fe\u5f62\u6267\u884c\u7ba1\u7406\u65b9\u6cd5\uff08GEM\uff09\u662f\u5176\u4e2d\u4e00\u79cd\u3002</p> <p>GEM\u4e3aAPI\u63d0\u4f9b\u4e86\u663e\u5f0f\u7684\u5185\u5b58\u7ba1\u7406\u539f\u8bed\u3002\u901a\u8fc7GEM\uff0c\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u53ef\u4ee5\u521b\u5efa\uff0c\u5904\u7406\u548c\u9500\u6bc1GPU\u89c6\u9891\u5185\u5b58\u4e2d\u7684\u5185\u5b58\u5bf9\u8c61\uff08Bo\uff09\u3002\u4ece\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u7684\u89d2\u5ea6\u770b\uff0c\u8fd9\u4e9b\u88ab\u79f0\u4e3aGEM\u7684\u5bf9\u8c61\u662f\u6301\u4e45\u6027\u7684\uff0c\u4e0d\u9700\u8981\u5728\u7a0b\u5e8f\u6bcf\u6b21\u91cd\u65b0\u83b7\u5f97\u5bf9GPU\u7684\u63a7\u5236\u65f6\uff0c\u91cd\u65b0\u52a0\u8f7d\u4ed6\u4eec\u3002\u5f53\u7528\u6237\u7a7a\u95f4\u9700\u8981\u5927\u91cf\u7684\u89c6\u9891\u5185\u5b58(\u4ee5\u5b58\u50a8frame buffer\uff0c\u7eb9\u7406\u6216\u8005GPU\u6240\u9700\u7684\u4efb\u4f55\u5176\u4ed6\u6570\u636e)\u65f6\uff0c\u5b83\u5c06\u4f7f\u7528GEM API\u8bf7\u6c42\u5206\u914d\u3002DRM\u9a71\u52a8\u7a0b\u5e8f\u4f1a\u8ddf\u8e2a\u5df2\u4f7f\u7528\u7684\u89c6\u9891\u5185\u5b58\uff0c\u5982\u679c\u6709\u53ef\u7528\u7684\u7a7a\u95f2\u5185\u5b58\uff0c\u5c06\u53e5\u67c4\u8fd4\u56de\u7ed9\u7528\u6237\u7a7a\u95f4\uff0c\u5728\u4ee5\u540e\u7684\u64cd\u4f5c\u4e2d\u8fdb\u4e00\u6b65\u5f15\u7528\u5206\u914d\u7684\u5185\u5b58. GEM API \u8fd8\u63d0\u4f9b\u4e86\u4e00\u4e9b\u64cd\u4f5c\uff0c\u4ee5\u586b\u5145BO\u5e76\u5728\u4e0d\u9700\u8981\u65f6\u91ca\u653e\u3002\u5f53\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b\u6709\u610f\u6216\u8005\u7531\u4e8e\u7ec8\u6b62\u800c\u5173\u95edDRM\u8bbe\u5907\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u672a\u91ca\u653e\u7684GEM\u5185\u5b58\u5c06\u6062\u590d.</p> <p>GEM\u8fd8\u5141\u8bb8\u4f7f\u7528\u540c\u4e00\u4e2aDRM\u8bbe\u5907\u7684\u4e24\u4e2a\u6216\u8005\u591a\u4e2a\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b\u5171\u4eabGEM\u5bf9\u8c61\u3002 GEM\u53e5\u67c4\u662f\u67d0\u4e2a\u8fdb\u7a0b\u552f\u4e00\u7684\u5c40\u90e832\u4f4d\u6574\u6570\uff0c\u4f46\u5728\u5176\u4ed6\u8fdb\u7a0b\u4e2d\u53ef\u91cd\u590d\uff0c\u56e0\u6b64\u4e0d\u9002\u5408\u5171\u4eab\u3002\u6240\u4ee5\u9700\u8981\u4e00\u4e2a\u5168\u5c40\u547d\u540d\u7a7a\u95f4\uff0cGEM\u901a\u8fc7\u4f7f\u7528\u79f0\u4e3aGEM names\u7684\u5168\u5c40\u53e5\u67c4\u6765\u63d0\u4f9b\u4e00\u4e2a\u547d\u540d\u7a7a\u95f4\u3002GEM\u540d\u79f0\u662f\u6307\u4f7f\u7528\u76f8\u540c\u7684DRM\u9a71\u52a8\u7a0b\u5e8f\u5728\u540c\u4e00\u4e2aDRM\u8bbe\u5907\u4e2d\u901a\u8fc7\u4f7f\u7528\u552f\u4e00\u768432\u4f4d\u6574\u6570\u521b\u5efa\u4e00\u4e2aGEM\u5bf9\u8c61\uff0c\u5e76\u4e14\u4ec5\u662f\u4e00\u4e2aGEM\u5bf9\u8c61. GEM\u63d0\u4f9b\u4e86\u4e00\u4e2a\u64cd\u4f5cflink\u6765\u4eceGEM\u53e5\u67c4\u83b7\u53d6GEM\u540d\u79f0\u3002\u7136\u540e\u8be5\u8fdb\u7a0b\u53ef\u4ee5\u4f7f\u7528\u4efb\u4f55\u53ef\u7528IPC\u673a\u5236\u5c06GEM\u540d\u79f0\u4f20\u9012\u7ed9\u4e00\u4e2a\u8fdb\u7a0b\u3002</p> <p>\u4e0d\u5e78\u7684\u662f\uff0c\u4f7f\u7528GEM\u540d\u79f0\u5171\u4eabBO\u5e76\u4e0d\u5b89\u5168\u3002\u4e00\u4e2a\u6076\u610f\u7684\u7b2c\u4e09\u65b9\u8fdb\u7a0b\u8bbf\u95ee\u540c\u4e00DRM\u8bbe\u5907\u53ef\u4ee5\u901a\u8fc7\u63a2\u67e532\u6574\u6570\u6765\u731c\u6d4b\u4e24\u4e2a\u8fdb\u7a0b\u5171\u4eab\u7684\u7f13\u51b2\u533aGEM\u540d\u79f0\u3002\u540e\u6765\u901a\u8fc7\u5728DRM\u4e2d\u5f15\u5165\u4e86DMA_BUF\u652f\u6301\u6765\u514b\u670d\u6b64\u7f3a\u70b9\uff0c\u56e0\u6b64DMA_BUF\u5c06\u7528\u6237\u7a7a\u95f4\u4e2d\u7684BO\u8868\u793a\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u53ef\u4ee5\u5b89\u5168\u7684\u5171\u4eab\u5b83\u4eec\u3002</p> <p>\u9664\u4e86\u7ba1\u7406\u89c6\u9891\u5185\u5b58\u7a7a\u95f4\u5916\uff0c\u4efb\u4f55\u89c6\u9891\u5185\u5b58\u7ba1\u7406\u7cfb\u7edf\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u4efb\u52a1\u662f\u5904\u7406GPU\u548cCPU\u4e4b\u95f4\u7684\u5185\u5b58\u540c\u6b65\u3002\u5f53\u524d\u7684\u5b58\u50a8\u5668\u67b6\u6784\u975e\u5e38\u590d\u6742\uff0c\u5e76\u4e14\u901a\u5e38\u6d89\u53ca\u7528\u4e8eSRAM\u4ee5\u53ca\u6709\u65f6\u4e5f\u7528\u4e8eVRAM\u7684\u5404\u79cd\u7ea7\u522b\u7684\u9ad8\u901f\u7f13\u5b58\u3002\u56e0\u6b64\uff0c\u89c6\u9891\u5185\u5b58\u7ba1\u7406\u5668\u8fd8\u5e94\u5904\u7406\u7f13\u5b58\u4e00\u81f4\u6027\uff0c\u4ee5\u786e\u4fddCPU\u548cGPU\u4e4b\u95f4\u5171\u4eab\u7684\u6570\u636e\u4e00\u81f4\uff0c\u8fd9\u610f\u5473\u7740VRAM\u901a\u5e38\u9ad8\u5ea6\u4f9d\u8d56\u4e8eGPU\u548c\u5b58\u50a8\u4f53\u7cfb\u7ed3\u6784\u7684\u786c\u4ef6\u7ec6\u8282\uff0c\u56e0\u6b64\u53d6\u51b3\u4e8e\u9a71\u52a8\u7a0b\u5e8f\u3002</p> <p>GEM\u6700\u521d\u662f\u7531\u82f1\u7279\u5c14\u5de5\u7a0b\u5e08\u5f00\u53d1\u7684\uff0c\u65e8\u5728\u4e3a\u5176i915\u9a71\u52a8\u7a0b\u5e8f\u63d0\u4f9bVRAM\u7ba1\u7406\u3002\u82f1\u7279\u5c14GMA\u5bb6\u65cf\u5177\u6709\u7edf\u4e00\u5185\u5b58\u67b6\u6784(UMA)\u7684\u96c6\u6210GPU\uff0c\u5176\u4e2dGPU\u548cCPU\u5171\u4eab\u7269\u7406\u5185\u5b58\uff0c\u5e76\u4e14\u6ca1\u6709\u4e13\u7528\u7684VRAM\u3002GEM\u5b9a\u4e49\u4e86\u7528\u4e8e\u5185\u5b58\u540c\u6b65\u7684==\u5185\u5b58\u57df==\uff0c\u5c3d\u7ba1\u8fd9\u4e9b\u5185\u5b58\u57df\u4e0eGPU\u65e0\u5173, \u4f46\u4ed6\u4eec\u5728\u8bbe\u8ba1\u65f6\u7279\u522b\u8003\u8651\u4e86UMA\u5185\u5b58\u67b6\u6784\uff0c\u8fd9\u4f7f\u5176\u4e0d\u9002\u7528\u4e8e\u5176\u4ed6\u5185\u5b58\u67b6\u6784\uff0c\u4f8b\u5982\u5177\u6709\u5355\u72ecVRAM\u7684\u5185\u5b58\u67b6\u6784\u3002\u56e0\u6b64\uff0c\u5176\u4ed6\u7684DRM\u9a71\u52a8\u7a0b\u5e8f\u5df2\u51b3\u5b9a\u5411\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u516c\u5f00GEM API\uff0c\u4f46\u5728\u5185\u90e8\u4ed6\u4eec\u5b9e\u73b0\u4e86\u66f4\u9002\u5408\u5176\u7279\u5b9a\u786c\u4ef6\u548c\u5185\u5b58\u4f53\u7cfb\u7ed3\u6784\u7684\u5176\u4ed6\u5185\u5b58\u7ba1\u7406\u5668\u3002</p> <p>GEM API\u8fd8\u63d0\u4f9b\u4e86\u7528\u4e8e\u63a7\u5236\u6267\u884c\u6d41(ring buffer)\u7684ioctl,\u9664\u4e86\u7279\u5b9a\u4e8e\u5185\u5b58\u7ba1\u7406\u7684ioctl\uff0c\u6ca1\u6709DRM\u9a71\u52a8\u7a0b\u5e8f\u8bd5\u56fe\u53bb\u5b9e\u73b0GEM API\u7684\u5176\u4ed6\u4efb\u4f55\u90e8\u5206\u3002</p>"},{"location":"Linux/DRM/Overview/#ttm-translation-table-maps","title":"TTM (Translation Table Maps)","text":"<p>Translation Table Maps\uff08TTM\uff09\u662f\u5728GEM\u4e4b\u524d\u5f00\u53d1\u7684\u7528\u4e8eGPU\u7684\u901a\u7528\u5185\u5b58\u7ba1\u7406\u5668\u540d\u79f0\u3002\u5b83\u4e13\u95e8\u7528\u4e8e==\u7ba1\u7406GPU\u53ef\u80fd\u8bbf\u95ee\u7684\u4e0d\u540c\u7c7b\u578b\u7684\u5185\u5b58==\uff0c\u5305\u62ec\u4e13\u7528\u7684Video RAM\uff08\u901a\u5e38\u5b89\u88c5\u5728\u663e\u5361\u4e2d\uff09\u4e0e\u53ef\u901a\u8fc7\u79f0\u4e3aGraphics\u00a0Address\u00a0Remapping Table\uff08GART\uff09\u7684I/O\u5185\u5b58\u7ba1\u7406\u5355\u5143\u8bbf\u95ee\u7684\u7cfb\u7edf\u5185\u5b58\u3002\u8003\u8651\u5230\u7528\u6237\u7a7a\u95f4\u56fe\u5f62\u5e94\u7528\u7a0b\u5e8f\u901a\u5e38\u4f1a\u5904\u7406\u5927\u91cf\u89c6\u9891\u6570\u636e\uff0cTTM\u8fd8\u5e94\u5904\u7406CPU\u65e0\u6cd5\u76f4\u63a5\u5bfb\u5740\u7684Video RAM\u90e8\u5206\uff0c\u5e76\u4ee5\u6700\u4f73\u6027\u80fd\u6765\u5b9e\u73b0\u3002\u53e6\u4e00\u4e2a\u91cd\u8981\u7684\u4e8b\u60c5\u662f\u4fdd\u6301\u6240\u6d89\u53ca\u7684\u4e0d\u540c\u5185\u5b58\u548c\u7f13\u5b58\u4e4b\u95f4\u7684\u4e00\u81f4\u6027\u3002</p> <p>TTM\u7684\u4e3b\u8981\u6982\u5ff5\u662fBO\uff0c\u5373\u5728\u67d0\u4e9b\u65f6\u523bGPU\u662f\u53ef\u5bfb\u5740\u7684\u89c6\u9891\u5185\u5b58\u3002\u5f53\u7528\u6237\u7a7a\u95f4\u56fe\u5f62\u5e94\u7528\u7a0b\u5e8f\u60f3\u8981\u8bbf\u95ee\u67d0\u4e2aBO\u65f6\uff0cTTM\u53ef\u80fd\u9700\u8981\u5c06\u5176\u91cd\u65b0\u5b9a\u4f4d\u4e3aCPU\u53ef\u5bfb\u5740\u7684\u4e00\u79cdRAM\u3002\u5f53GPU\u9700\u8981\u8bbf\u95ee\u7684BO\u8fd8\u4e0d\u5728GPU\u7684\u5730\u5740\u7a7a\u95f4\u4e2d\u65f6\uff0c\u53ef\u80fd\u8fd8\u4f1a\u53d1\u751f\u8fdb\u4e00\u6b65\u7684\u91cd\u5b9a\u4f4d\u6216\u8005GART\u6620\u5c04\u64cd\u4f5c\u3002\u8fd9\u4e9b\u91cd\u5b9a\u4f4d\u64cd\u4f5c\u4e2d\u7684\u6bcf\u4e00\u4e2a\u90fd\u5fc5\u987b\u5904\u7406\u4efb\u4f55\u76f8\u5173\u7684\u6570\u636e\u548c\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898\u3002</p> <p>TTM\u7684\u53e6\u4e00\u4e2a\u91cd\u8981\u6982\u5ff5\u662f\u56f4\u680f\uff08fences\uff09\u3002\u56f4\u680f\u672c\u8d28\u4e0a\u662f\u4e00\u79cd\u7ba1\u7406CPU\u548cGPU\u4e4b\u95f4\u5e76\u53d1\u6027\u7684\u673a\u5236\u3002\u56f4\u680f\u8ddf\u8e2aGPU\u4f55\u65f6\u4e0d\u518d\u4f7f\u7528\u7f13\u51b2\u533a\u5bf9\u8c61\uff0c\u901a\u5e38\u7528\u4e8e\u901a\u77e5\u4efb\u4f55\u5177\u6709\u8bbf\u95ee\u6743\u9650\u7684\u7528\u6237\u7a7a\u95f4\u8fdb\u7a0b.</p> <p>TTM\u8bd5\u56fe\u4ee5\u5408\u9002\u7684\u65b9\u5f0f\u7ba1\u7406\u6240\u6709\u7c7b\u578b\u7684\u5185\u5b58\u4f53\u7cfb\u7ed3\u6784\uff0c\u5305\u62ec\u6709\u548c\u6ca1\u6709\u4e13\u7528VRAM\u7684\u4f53\u7cfb\u7ed3\u6784\uff0c\u5e76\u5728\u5185\u5b58\u7ba1\u7406\u5668\u4e2d\u63d0\u4f9b\u6240\u6709\u53ef\u60f3\u5230\u7684\u529f\u80fd\uff0c\u4ee5\u4fbf\u4e0e\u4efb\u4f55\u7c7b\u578b\u7684\u786c\u4ef6\u4e00\u8d77\u4f7f\u7528\uff0c\u8fd9\u5bfc\u81f4\u4e86\u8fc7\u4e8e\u590d\u6742\u7684\u60c5\u51b5\u3002API\u8fdc\u8fdc\u8d85\u51fa\u6240\u9700\u7684\u89e3\u51b3\u65b9\u6848\u3002\u4e00\u4e9bDRM\u5f00\u53d1\u4eba\u5458\u8ba4\u4e3a\u5b83\u4e0d\u9002\u7528\u4e8e\u4efb\u4f55\u7279\u5b9a\u7684\u9a71\u52a8\u7a0b\u5e8f\uff0c\u5c24\u5176\u662fAPI\u3002\u5f53GEM\u6210\u4e3a\u4e00\u79cd\u66f4\u7b80\u5355\u7684\u5185\u5b58\u7ba1\u7406\u5668\u65f6\uff0c\u5b83\u7684API\u4f18\u4e8eTTM\u3002\u4f46\u662f\u4e00\u4e9b\u9a71\u52a8\u7a0b\u5e8f\u5f00\u53d1\u4eba\u5458\u8ba4\u4e3aTTM\u6240\u91c7\u7528\u7684\u65b9\u6cd5\u66f4\u9002\u5408\u4e8e\u5177\u6709\u4e13\u7528Video RAM\u548cIOMMU\u7684\u5206\u7acb\u663e\u5361\uff0c\u56e0\u6b64\u4ed6\u4eec\u51b3\u5b9a\u5728\u5185\u90e8\u4f7f\u7528TTM\uff0c\u540c\u65f6\u5c06\u5176\u7f13\u51b2\u533a\u5bf9\u8c61\u516c\u5f00\u4e3aGEM\u5bf9\u8c61\uff0c\u4ece\u800c\u652f\u6301GEM API\u3002\u5f53\u524d\u4f7f\u7528TTM\u4f5c\u4e3a\u5185\u90e8\u5185\u5b58\u7ba1\u7406\u5668\u4f46\u63d0\u4f9bGEM API\u7684\u9a71\u52a8\u7a0b\u5e8f\u5b9e\u4f8b\u5305\u62ecAMD\u663e\u5361\u7684radeon\u9a71\u52a8\u7a0b\u5e8f\u548cNVIDIA\u663e\u5361\u7684nouveau\u9a71\u52a8\u7a0b\u5e8f\u3002</p>"},{"location":"Linux/DRM/Overview/#dma-buffer-sharing-and-prime","title":"DMA Buffer Sharing and PRIME","text":"<p>DMA\u7f13\u51b2\u533a\u5171\u4eabAPI\uff08\u901a\u5e38\u7f29\u5199\u4e3aDMA-BUF\uff09\u662f\u4e00\u79cdLinux\u5185\u6838\u5185\u90e8API\uff0c\u65e8\u5728\u63d0\u4f9b\u4e00\u79cd\u901a\u7528\u673a\u5236\u6765\u5728\u591a\u4e2a\u8bbe\u5907\u4e4b\u95f4\u5171\u4eabDMA\u7f13\u51b2\u533a\uff0c\u5e76\u53ef\u80fd\u7531\u4e0d\u540c\u7c7b\u578b\u7684\u8bbe\u5907\u9a71\u52a8\u8fdb\u884c\u7ba1\u7406\u3002\u4f8b\u5982\uff0cVdieo4Linux\u8bbe\u5907\u548c\u56fe\u5f62\u9002\u914d\u5668\u8bbe\u5907\u53ef\u4ee5\u901a\u8fc7DMA-BUF\u5171\u4eab\u7f13\u51b2\u533a\uff0c\u4ee5\u5b9e\u73b0\u524d\u8005\u4ea7\u751f\u5e76\u7531\u540e\u8005\u6d88\u8017\u7684\u89c6\u9891\u6d41\u6570\u636e\u7684\u96f6\u590d\u5236\u3002\u4efb\u4f55Linux\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u90fd\u53ef\u4ee5\u5c06\u6b64API\u5b9e\u73b0\u4e3a\u5bfc\u51fa\u5668\u3001\u7528\u6237\uff08\u6d88\u8d39\u8005\uff09\u6216\u8005\u4e8c\u8005\u517c\u800c\u6709\u4e4b\u3002</p> <p>\u5728DRM\u4e2d\u9996\u6b21\u5229\u7528\u6b64\u529f\u80fd\u6765\u5b9e\u73b0PRIME(\u663e\u5361\u4ea4\u706b), \u8fd9\u662f\u4e00\u79cd\u7528\u4e8eGPU\u5378\u8f7d\u7684\u89e3\u51b3\u65b9\u6848\uff0c\u5b83\u4f7f\u7528DMA-BUF\u5728\u72ec\u7acb\u663e\u5361\u548c\u96c6\u6210\u663e\u5361\u4e4b\u95f4\u5171\u4eab\u751f\u6210\u7684framebuffer\u3002DMA-BUF\u7684\u4e00\u9879\u91cd\u8981\u529f\u80fd\u662f\u4e3a\u4e86\u5c06\u5171\u4eabBO\u4f5c\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\u63d0\u4f9b\u7ed9\u7528\u6237\u7a7a\u95f4\u3002\u4e3a\u4e86\u5f00\u53d1PRIME\uff0c\u5728DRM API\u4e2d\u6dfb\u52a0\u4e86\u4e24\u4e2a\u65b0\u7684ioctl, \u4e00\u4e2a\u5c06\u672c\u5730GEM\u53e5\u67c4\u8f6c\u6362\u4e3aDMA-BUF\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0c\u53e6\u4e00\u4e2a\u7528\u4e8e\u76f8\u53cd\u7684\u64cd\u4f5c\u3002</p> <p>\u540e\u6765\u8fd9\u4e24\u4e2a\u65b0\u7684ioctl\u88ab\u7528\u4f5c\u89e3\u51b3GEM\u7f13\u51b2\u533a\u5171\u4eab\u56fa\u6709\u7684\u4e0d\u5b89\u5168\u6027\u7684\u4e00\u79cd\u65b9\u6cd5\u3002\u4e0eGEM\u540d\u79f0\u4e0d\u540c\uff0c\u65e0\u6cd5\u731c\u6d4b\u5230\u6587\u4ef6\u63cf\u8ff0\u7b26(\u5b83\u4eec\u4e0d\u662f\u5168\u5c40\u547d\u540d\u7a7a\u95f4) \uff0c \u5e76\u4e14Unix\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e86\u4e00\u79cd\u5b89\u5168\u7684\u65b9\u6cd5\u6765\u4f20\u9012Unix\u57df\u5957\u63a5\u5b57\uff0c\u901a\u8fc7\u4f7f\u7528SCM_RIGHTS\u8bed\u4e49\u3002==\u4e00\u4e2a\u60f3\u8981\u4e0e\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u5171\u4eabGEM\u5bf9\u8c61\u7684\u8fdb\u7a0b\u53ef\u4ee5\u5c06\u672c\u5730GEM\u53e5\u67c4\u8f6c\u6362\u4e3aDMA-BUF\u6587\u4ef6\u7b26\uff0c\u7136\u540e\u5c06\u5176\u4f20\u9012\u7ed9\u63a5\u6536\u8005\uff0c\u540e\u8005\u53ef\u4ee5\u4ece\u63a5\u6536\u7684\u6587\u4ef6\u63cf\u8ff0\u7b26\u4e2d\u83b7\u5f97\u81ea\u5df1\u7684GEM\u53e5\u67c4\u3002==DRI3\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u5728\u5ba2\u6237\u7aef\u548cX Server\u6216\u8005Wayland\u4e4b\u95f4\u5171\u4eab\u7f13\u51b2\u533a\u3002</p> <p>fd\u662f\u72ec\u7acb\u4e8e\u6bcf\u4e2a\u8fdb\u7a0b\u7684\uff0c\u6240\u4ee5\u53d1\u9001\u65b9\u7684fd\u53ef\u80fd\u548c\u63a5\u6536\u65b9\u7684fd\u503c\u4e0d\u4e00\u6837\u3002\u521b\u5efaUNIX socket\uff0c\u8bbe\u7f6ecmptr-&gt;cmsg_type\u4e3aSCM_RIGHTS.</p>"},{"location":"Linux/DRM/Overview/#kernel-mode-setting","title":"Kernel Mode Setting","text":"<p>\u4e3a\u4e86\u6b63\u5e38\u5de5\u4f5c\uff0c\u663e\u5361\u6216\u8005\u56fe\u5f62\u9002\u914d\u5668\u5fc5\u987b\u8bbe\u7f6e\u4e00\u79cd\u6a21\u5f0f\uff08\u5c4f\u5e55\u5206\u8fa8\u7387\u3001\u989c\u8272\u6df1\u5ea6\u548c\u5237\u65b0\u7387\u7684\u7ec4\u5408\uff09\uff0c\u8be5\u6a21\u5f0f\u5e94\u5728\u5176\u81ea\u8eab\u548c\u6240\u8fde\u63a5\u7684\u663e\u793a\u5c4f\u6240\u652f\u6301\u7684\u503c\u7684\u8303\u56f4\u5185\u3002\u6b64\u64cd\u4f5c\u79f0\u4e3amode-setting\u3002\u901a\u5e38\u9700\u8981\u5bf9\u56fe\u5f62\u786c\u4ef6\u8fdb\u884c\u539f\u59cb\u8bbf\u95ee\uff0c\u5199\u5165\u89c6\u9891\u5361\u67d0\u4e9b\u5bc4\u5b58\u5668\u7684\u80fd\u529b\u3002\u5728\u5f00\u59cb\u4f7f\u7528framebuffer\u4e4b\u524d\uff0c\u4ee5\u53ca\u5728\u5e94\u7528\u7a0b\u5e8f\u6216\u8005\u7528\u6237\u8981\u6c42\u66f4\u6539\u6a21\u5f0f\u65f6\uff0c\u90fd\u5fc5\u987b\u6267\u884c\u6a21\u5f0f\u8bbe\u7f6e\u64cd\u4f5c\u3002 \u00a0 \u5728\u65e9\u671f\uff0c\u5e0c\u671b\u4f7f\u7528\u56fe\u5f62framebuffer\u7684\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u8fd8\u8d1f\u8d23\u63d0\u4f9b\u6a21\u5f0f\u8bbe\u7f6e\u64cd\u4f5c\uff0c\u56e0\u6b64\u5b83\u4eec\u9700\u8981\u5728\u5bf9\u89c6\u9891\u786c\u4ef6\u8fdb\u884c\u7279\u6743\u8bbf\u95ee\u7684\u60c5\u51b5\u4e0b\u8fd0\u884c\u3002\u5728Unix\u7c7b\u578b\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e2d\uff0cX Server\u662f\u6700\u7a81\u51fa\u7684\u793a\u4f8b\uff0c\u5176\u6a21\u5f0f\u8bbe\u7f6e\u5b9e\u73b0\u5b58\u5728\u4e8e\u6bcf\u79cd\u7279\u5b9a\u7c7b\u578b\u7684\u663e\u5361\u7684DDX\u9a71\u52a8\u7a0b\u5e8f\u4e2d\u3002\u8fd9\u79cd\u65b9\u6cd5\uff08\u4ee5\u540e\u79f0\u4e3a\u7528\u6237\u7a7a\u95f4\u6a21\u5f0f\u8bbe\u7f6e\u6216UMS\uff09\u5e26\u6765\u4e86\u51e0\u4e2a\u95ee\u9898\u3002\u8fd9\u4e0d\u4ec5\u6253\u7834\u4e86\u64cd\u4f5c\u7cfb\u7edf\u5e94\u5728\u7a0b\u5e8f\u548c\u786c\u4ef6\u4e4b\u95f4\u63d0\u4f9b\u7684\u9694\u79bb\u6027\uff0c\u4ece\u800c\u63d0\u9ad8\u7a33\u5b9a\u6027\u548c\u5b89\u5168\u6027\uff0c\u800c\u5982\u679c\u4e24\u4e2a\u6216\u591a\u4e2a\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u5c1d\u8bd5\u5728\u64cd\u4f5c\u7cfb\u7edf\u4e0a\u8fdb\u884c\u6a21\u5f0f\u8bbe\u7f6e\uff0c\u53ef\u80fd\u4f1a\u4f7f\u56fe\u5f62\u786c\u4ef6\u5904\u4e8e\u4e0d\u4e00\u81f4\u7684\u72b6\u6001\u3002\u540c\u65f6\uff0c\u4e3a\u4e86\u907f\u514d\u8fd9\u79cd\u51b2\u7a81\uff0c\u5b9e\u9645\u4e0aX Server\u6210\u4e3a\u4e86\u552f\u4e00\u6267\u884c\u6a21\u5f0f\u8bbe\u7f6e\u64cd\u4f5c\u7684\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u3002\u5176\u4f59\u7684\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u4f9d\u9760X Server\u6765\u8bbe\u7f6e\u9002\u5f53\u7684\u6a21\u5f0f\u5e76\u5904\u7406\u6d89\u53ca\u6a21\u5f0f\u8bbe\u7f6e\u7684\u4efb\u4f55\u5176\u4ed6\u64cd\u4f5c\u3002\u6700\u521d\uff0c\u6a21\u5f0f\u8bbe\u7f6e\u4ec5\u5728X Server\u542f\u52a8\u8fc7\u7a0b\u4e2d\u6267\u884c\uff0c\u4f46\u662f\u540e\u6765X Server\u53ef\u4ee5\u5728\u8fd0\u884c\u65f6\u8fdb\u884c\u8bbe\u7f6e\u3002XFree86 3.1.2\u4e2d\u5f15\u5165\u4e86XFree-VidModeExtension\u6269\u5c55\uff0c\u4ee5\u5141\u8bb8X-Client\u8bf7\u6c42\u5bf9X Server\u7684modeline\uff08\u5206\u8fa8\u7387\uff09\u66f4\u6539\u3002VidModeExtension\u540e\u6765\u88ab\u66f4\u52a0\u901a\u7528\u7684XRandR\u6269\u5c55\u53d6\u4ee3\u3002</p> <p>\u7136\u800c\uff0c\u8fd9\u4e0d\u662f\u5728linux\u7cfb\u7edf\u4e2d\u8fdb\u884c\u6a21\u5f0f\u8bbe\u7f6e\u7684\u552f\u4e00\u4ee3\u7801\u3002==\u5728\u7cfb\u7edf\u5f15\u5bfc\u8fc7\u7a0b\u4e2d\uff0cLinux\u5185\u6838\u5fc5\u987b\u4e3a\u865a\u62df\u63a7\u5236\u53f0\u8bbe\u7f6e\u6700\u5c0f\u6587\u672c\u6a21\u5f0f\uff08\u57fa\u4e8eVESA BIOS\u6269\u5c55\u5b9a\u4e49\u7684\u6807\u51c6\u6a21\u5f0f\uff09\u3002==Linux\u5185\u6838\u5e27\u7f13\u51b2\u9a71\u52a8\u7a0b\u5e8f\u8fd8\u5305\u542b\u7528\u4e8e\u914d\u7f6e\u5e27\u7f13\u51b2\u8bbe\u5907\u7684\u6a21\u5f0f\u4ee3\u7801\u3002\u4e3a\u4e86\u907f\u514d\u6a21\u5f0f\u8bbe\u7f6e\u51b2\u7a81\uff0cXFree86 Server\uff08\u4ee5\u53ca\u540e\u6765\u7684X.Org Server\uff09\u5728\u7528\u6237\u4ece\u56fe\u5f62\u73af\u5883\u5207\u6362\u5230\u6587\u672c\u865a\u62df\u63a7\u5236\u53f0\u65f6\u4fdd\u5b58\u6a21\u5f0f\u8bbe\u7f6e\u72b6\u6001\uff0c\u5e76\u5728\u5207\u56de\u5230X\u56fe\u5f62\u73af\u5883\u65f6\u8fd8\u539f\u5b83\u3002\u6b64\u8fc7\u7a0b\u5728\u8fc7\u6e21\u4e2d\u5f15\u53d1\u4e86\u95ea\u70c1\u73b0\u8c61\uff0c\u5e76\u4e14\u8fd8\u53ef\u80fd\u5931\u8d25\uff0c\u4ece\u800c\u5bfc\u81f4\u8f93\u51fa\u663e\u793a\u635f\u574f\u6216\u65e0\u6cd5\u4f7f\u7528\u3002</p> <p>==\u4e3a\u4e86\u89e3\u51b3\u8fd9\u4e9b\u95ee\u9898\uff0c\u5c06\u6a21\u5f0f\u8bbe\u7f6e\u4ee3\u7801\u79fb\u81f3\u5185\u6838\u4e2d\u7684\u5355\u4e2a\u4f4d\u7f6e\uff0c\u653e\u5230\u4e86\u73b0\u6709\u7684DRM\u6a21\u5757\u4e2d\u3002==\u7136\u540e\u6bcf\u4e2a\u8fdb\u7a0b\uff08\u5305\u62ecX Server\uff09\u90fd\u5e94\u8be5\u80fd\u591f\u547d\u4ee4\u5185\u6838\u6267\u884c\u6a21\u5f0f\u8bbe\u7f6e\u64cd\u4f5c\uff0c\u5e76\u4e14\u5185\u6838\u5c06\u786e\u4fdd\u5e76\u53d1\u64cd\u4f5c\u4e0d\u4f1a\u5bfc\u81f4\u4e0d\u4e00\u81f4\u7684\u72b6\u6001\u3002\u6dfb\u52a0\u5230DRM\u6a21\u5757\u4ee5\u6267\u884c\u8fd9\u4e9b\u6a21\u5f0f\u8bbe\u7f6e\u64cd\u4f5c\u7684\u65b0\u5185\u6838API\u548c\u4ee3\u7801\u79f0\u4e3aKernel Mode-Setting(KMS)\u3002</p> <p>Kernel Mode-Setting(KMS)\u6709\u51e0\u4e2a\u597d\u5904\u3002\u6700\u76f4\u63a5\u662f\u4ece\u5185\u6838\uff08Linux\u63a7\u5236\u53f0\uff0cfbdev\uff09\u548c\u7528\u6237\u7a7a\u95f4\uff08X Server DDX\u9a71\u52a8\u7a0b\u5e8f\uff09\u4e2d\u5220\u9664\u91cd\u590d\u7684\u6a21\u5f0f\u8bbe\u7f6e\u4ee3\u7801\u3002KMS\u8fd8\u4f7f\u7f16\u5199\u66ff\u4ee3\u56fe\u5f62\u7cfb\u7edf\u53d8\u5f97\u66f4\u52a0\u5bb9\u6613\uff0c\u800c\u8fd9\u4e9b\u56fe\u5f62\u7cfb\u7edf\u73b0\u5728\u4e0d\u9700\u8981\u5b9e\u73b0\u81ea\u5df1\u7684\u6a21\u5f0f\u8bbe\u7f6e\u4ee3\u7801\u3002\u901a\u8fc7\u63d0\u4f9b\u96c6\u4e2d\u7684\u6a21\u5f0f\u7ba1\u7406\uff0cKMS\u89e3\u51b3\u4e86\u5728\u63a7\u5236\u53f0\u548cX\u4e4b\u95f4\u4ee5\u53caX\u7684\u4e0d\u540c\u5b9e\u4f8b\u4e4b\u95f4\u5207\u6362\u5f15\u8d77\u7684\u95ea\u5c4f\u95ee\u9898\u3002\u7531\u4e8e\u5b83\u5728\u5185\u6838\u4e2d\u53ef\u7528\uff0c\u56e0\u6b64\u4e5f\u53ef\u4ee5\u5728\u5f15\u5bfc\u8fc7\u7a0b\u5f00\u59cb\u65f6\u4f7f\u7528\u5b83\uff0c\u4ece\u800c\u907f\u514d\u4e86\u7531\u4e8e\u8fd9\u4e9b\u65e9\u671f\u9636\u6bb5\u7684\u6a21\u5f0f\u66f4\u6539\u800c\u5bfc\u81f4\u7684\u95ea\u70c1\u3002</p> <p>\u4e3a\u907f\u514d\u7834\u574fDRM API\u7684\u5411\u540e\u517c\u5bb9\u6027\uff0c\u5185\u6838\u6a21\u5f0f\u8bbe\u7f6e\u4f5c\u4e3a\u67d0\u4e9bDRM\u9a71\u52a8\u7a0b\u5e8f\u7684\u9644\u4ef6\u9a71\u52a8\u7a0b\u5e8f\u529f\u80fd\u63d0\u4f9b\u3002\u4efb\u4f55DRM\u9a71\u52a8\u7a0b\u5e8f\u5728\u5411DRM\u5185\u6838\u6ce8\u518c\u65f6\u90fd\u53ef\u4ee5\u9009\u62e9\u63d0\u4f9bDRIVER_MODESET\u6807\u5fd7\uff0c\u4ee5\u6307\u793a\u5b83\u652f\u6301KMS API\u3002\u90a3\u4e9b\u5b9e\u73b0\u5185\u6838\u6a21\u5f0f\u8bbe\u7f6e\u7684\u9a71\u52a8\u7a0b\u5e8f\u901a\u5e38\u88ab\u79f0\u4e3aKMS\u9a71\u52a8\u7a0b\u5e8f\uff0c\u4ee5\u5c06\u5b83\u4eec\u4e0e\u4f20\u7edf\u7684\uff08\u65e0KMS\uff09DRM\u9a71\u52a8\u3002</p>"},{"location":"Linux/DRM/Overview/#29-render-nodes","title":"2.9 Render nodes","text":"<p>\u5728\u539f\u59cbDRM API\u4e2d\uff0cDRM\u8bbe\u5907\u201c/dev/dri/cardX\u201d\u7528\u4e8e\u7279\u6743\uff08\u6a21\u5f0f\u8bbe\u7f6e\uff0c\u5176\u4ed6\u663e\u793a\u63a7\u4ef6\uff09\u548c\u975e\u7279\u6743\uff08\u6e32\u67d3\uff0cGPGPU\u8ba1\u7b97\uff09\u64cd\u4f5c\u3002 \u51fa\u4e8e\u5b89\u5168\u539f\u56e0\uff0c\u6253\u5f00\u5173\u8054\u7684DRM\u8bbe\u5907\u6587\u4ef6\u9700\u8981\u201c\u7b49\u540c\u4e8eroot\u7279\u6743\u201d\u7684\u7279\u6b8a\u7279\u6743\u3002\u8fd9\u5bfc\u81f4\u4e86\u4e00\u79cd\u4f53\u7cfb\u7ed3\u6784\uff0c\u5176\u4e2d\u53ea\u6709\u4e00\u4e9b\u53ef\u9760\u7684\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\uff08X\u670d\u52a1\u5668\uff0c\u56fe\u5f62\u5408\u6210\u5668\u7b49\uff09\u53ef\u4ee5\u5b8c\u5168\u8bbf\u95eeDRM API\uff0c\u5305\u62ec\u7279\u6743\u90e8\u5206\uff08\u5982\u6a21\u5f0f\u96c6API\uff09\u3002 \u60f3\u8981\u6e32\u67d3\u6216\u8fdb\u884cGPGPU\u8ba1\u7b97\u7684\u5176\u4f59\u7528\u6237\u7a7a\u95f4\u5e94\u7528\u7a0b\u5e8f\u5e94\u7531DRM\u8bbe\u5907\u7684\u6240\u6709\u8005\uff08\u201cDRM\u4e3b\u8bbe\u5907\u201d\uff09\u901a\u8fc7\u4f7f\u7528\u7279\u6b8a\u7684\u8eab\u4efd\u9a8c\u8bc1\u754c\u9762\u6765\u6388\u4e88\u3002\u7136\u540e\uff0c\u7ecf\u8fc7\u8eab\u4efd\u9a8c\u8bc1\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u4f7f\u7528DRM API\u7684\u53d7\u9650\u7248\u672c\u6765\u5448\u73b0\u6216\u8fdb\u884c\u8ba1\u7b97\uff0c\u800c\u65e0\u9700\u7279\u6743\u64cd\u4f5c\u3002\u8fd9\u79cd\u8bbe\u8ba1\u65bd\u52a0\u4e86\u4e25\u683c\u7684\u7ea6\u675f\uff1a\u5fc5\u987b\u59cb\u7ec8\u6709\u8fd0\u884c\u4e2d\u7684\u56fe\u5f62\u670d\u52a1\u5668\uff08X\u670d\u52a1\u5668\uff0cWayland\u5408\u6210\u5668\uff0c...\uff09\u5145\u5f53DRM\u8bbe\u5907\u7684DRM\u4e3b\u8bbe\u5907\uff0c\u4ee5\u4fbf\u53ef\u4ee5\u6388\u4e88\u5176\u4ed6\u7528\u6237\u7a7a\u95f4\u7a0b\u5e8f\u4f7f\u7528DRM\u8bbe\u5907\u7684\u6743\u9650\uff0c\u5373\u4f7f\u5728\u4e0d\u6d89\u53ca\u4efb\u4f55\u56fe\u5f62\u663e\u793a\uff08\u5982GPGPU\u8ba1\u7b97\uff09\u7684\u60c5\u51b5\u4e0b\u3002</p> <p>\u201c\u6e32\u67d3\u8282\u70b9\uff08Render nodes\uff09\u201d\u6982\u5ff5\u8bd5\u56fe\u901a\u8fc7\u5c06DRM\u7528\u6237\u7a7a\u95f4API\u5206\u6210\u4e24\u4e2a\u63a5\u53e3\uff08\u4e00\u4e2a\u7279\u6743\u548c\u4e00\u4e2a\u975e\u7279\u6743\uff09\u5e76\u4e3a\u6bcf\u4e2a\u63a5\u53e3\u4f7f\u7528\u5355\u72ec\u7684\u8bbe\u5907\u6587\u4ef6\uff08\u6216\u201c\u8282\u70b9\u201d\uff09\u6765\u89e3\u51b3\u8fd9\u4e9b\u60c5\u51b5\u3002\u5bf9\u4e8e\u627e\u5230\u7684\u6bcf\u4e2aGPU\uff0c\u5176\u5bf9\u5e94\u7684DRM\u9a71\u52a8\u7a0b\u5e8f\uff08\u5982\u679c\u5b83\u652f\u6301\u6e32\u67d3\u8282\u70b9\u529f\u80fd\uff09\u9664\u4e86\u4e3b\u8282\u70b9/dev /dri/cardX\u4e4b\u5916\uff0c\u8fd8\u4f1a\u521b\u5efa\u4e00\u4e2a\u8bbe\u5907\u6587\u4ef6/dev/dri/renderDX\uff0c\u79f0\u4e3a\u6e32\u67d3\u8282\u70b9\u3002\u4f7f\u7528\u76f4\u63a5\u6e32\u67d3\u6a21\u578b\u7684\u5ba2\u6237\u7aef\u548c\u60f3\u8981\u5229\u7528GPU\u7684\u8ba1\u7b97\u529f\u80fd\u7684\u5e94\u7528\u7a0b\u5e8f\u53ef\u4ee5\u901a\u8fc7\u7b80\u5355\u5730\u6253\u5f00\u4efb\u4f55\u73b0\u6709\u7684\u6e32\u67d3\u8282\u70b9\u5e76\u4f7f\u7528DRM API\u652f\u6301\u7684\u6709\u9650\u5b50\u96c6\u6765\u5206\u6d3eGPU\u64cd\u4f5c\uff0c\u800c\u65e0\u9700\u5176\u4ed6\u7279\u6743\u5373\u53ef\u505a\u5230\u8fd9\u4e00\u70b9--\u524d\u63d0\u662f\u5b83\u4eec\u5177\u6709\u6253\u5f00\u8bbe\u5907\u6587\u4ef6\u7684\u6587\u4ef6\u7cfb\u7edf\u6743\u9650\u3002 \u663e\u793a\u670d\u52a1\u5668\uff0c\u5408\u6210\u5668\u548c\u4efb\u4f55\u5176\u4ed6\u8bf7\u6c42\u6a21\u5f0fAPI\u6216\u4efb\u4f55\u5176\u4ed6\u7279\u6743\u64cd\u4f5c\u7684\u7a0b\u5e8f\uff0c\u90fd\u5fc5\u987b\u6253\u5f00\u6388\u4e88\u5bf9\u5b8c\u6574DRM API\u7684\u8bbf\u95ee\u6743\u9650\u7684\u6807\u51c6\u4e3b\u8282\u70b9\uff0c\u5e76\u50cf\u5f80\u5e38\u4e00\u6837\u4f7f\u7528\u5b83\u3002\u6e32\u67d3\u8282\u70b9\u663e\u5f0f\u7981\u6b62GEM flink\u64cd\u4f5c\uff0c\u4ee5\u9632\u6b62\u4f7f\u7528\u4e0d\u5b89\u5168\u7684GEM\u5168\u5c40\u540d\u79f0\u5171\u4eab\u7f13\u51b2\u533a\u3002 \u53ea\u80fd\u901a\u8fc7\u4f7f\u7528PRIME\uff08DMA-BUF\uff09\u6587\u4ef6\u63cf\u8ff0\u7b26\u7684\u65b9\u5f0f\uff0c\u4e0e\u5305\u62ec\u56fe\u5f62\u670d\u52a1\u5668\u5728\u5185\u7684\u53e6\u4e00\u4e2a\u5ba2\u6237\u7aef\u5171\u4eab\u7f13\u51b2\u533a\u3002</p> <p>\u8303\u4f8b <pre><code>#include &lt;errno.h&gt;\n#include &lt;fcntl.h&gt;\n#include &lt;stdbool.h&gt;\n#include &lt;stdint.h&gt;\n#include &lt;stdio.h&gt;\n#include &lt;stdlib.h&gt;\n#include &lt;string.h&gt;\n#include &lt;sys/mman.h&gt;\n#include &lt;time.h&gt;\n#include &lt;unistd.h&gt;\n#include \"xf86drm.h\"\n#include \"xf86drmMode.h\"\n\n#define uint32_t unsigned int \n\nstruct framebuffer{\n    uint32_t size;\n    uint32_t handle;    \n    uint32_t fb_id;\n    uint32_t *vaddr;    \n};\n\nstatic void create_fb(int fd,uint32_t width, uint32_t height, uint32_t color ,struct framebuffer *buf)\n{\n    struct drm_mode_create_dumb create = {};\n    struct drm_mode_map_dumb map = {};\n    uint32_t i;\n    uint32_t fb_id;\n\n    create.width = width;\n    create.height = height;\n    create.bpp = 32;\n    drmIoctl(fd, DRM_IOCTL_MODE_CREATE_DUMB, &amp;create);  //\u521b\u5efa\u663e\u5b58,\u8fd4\u56de\u4e00\u4e2ahandle\n\n    drmModeAddFB(fd, create.width, create.height, 24, 32, create.pitch,create.handle, &amp;fb_id); \n\n    map.handle = create.handle;\n    drmIoctl(fd, DRM_IOCTL_MODE_MAP_DUMB, &amp;map);    //\u663e\u5b58\u7ed1\u5b9afd\uff0c\u5e76\u6839\u636ehandle\u8fd4\u56deoffset\n\n    //\u901a\u8fc7offset\u627e\u5230\u5bf9\u5e94\u7684\u663e\u5b58(framebuffer)\u5e76\u6620\u5c04\u5230\u7528\u6237\u7a7a\u95f4\n    uint32_t *vaddr = mmap(0, create.size, PROT_READ | PROT_WRITE,MAP_SHARED, fd, map.offset);  \n\n    for (i = 0; i &lt; (create.size / 4); i++)\n        vaddr[i] = color;\n\n    buf-&gt;vaddr=vaddr;\n    buf-&gt;handle=create.handle;\n    buf-&gt;size=create.size;\n    buf-&gt;fb_id=fb_id;\n\n    return;\n}\n\nstatic void release_fb(int fd, struct framebuffer *buf)\n{\n    struct drm_mode_destroy_dumb destroy = {};\n    destroy.handle = buf-&gt;handle;\n\n    drmModeRmFB(fd, buf-&gt;fb_id);\n    munmap(buf-&gt;vaddr, buf-&gt;size);\n    drmIoctl(fd, DRM_IOCTL_MODE_DESTROY_DUMB, &amp;destroy);\n}\n\nint main(int argc, char **argv)\n{\n    int fd;\n    struct framebuffer buf[3];\n    drmModeConnector *connector;\n    drmModeRes *resources;\n    uint32_t conn_id;\n    uint32_t crtc_id;\n\n\n    fd = open(\"/dev/dri/card0\", O_RDWR | O_CLOEXEC);    //\u6253\u5f00card0\uff0ccard0\u4e00\u822c\u7ed1\u5b9aHDMI\u548cLVDS\n\n    resources = drmModeGetResources(fd);    //\u83b7\u53d6drmModeRes\u8d44\u6e90,\u5305\u542bfb\u3001crtc\u3001encoder\u3001connector\u7b49\n\n    crtc_id = resources-&gt;crtcs[0];          //\u83b7\u53d6crtc id\n    conn_id = resources-&gt;connectors[0];     //\u83b7\u53d6connector id\n\n    connector = drmModeGetConnector(fd, conn_id);   //\u6839\u636econnector_id\u83b7\u53d6connector\u8d44\u6e90\n\n    printf(\"hdisplay:%d vdisplay:%d\\n\",connector-&gt;modes[0].hdisplay,connector-&gt;modes[0].vdisplay);\n\n    create_fb(fd,connector-&gt;modes[0].hdisplay,connector-&gt;modes[0].vdisplay, 0xff0000, &amp;buf[0]); //\u521b\u5efa\u663e\u5b58\u548c\u4e0a\u8272\n    create_fb(fd,connector-&gt;modes[0].hdisplay,connector-&gt;modes[0].vdisplay, 0x00ff00, &amp;buf[1]); \n    create_fb(fd,connector-&gt;modes[0].hdisplay,connector-&gt;modes[0].vdisplay, 0x0000ff, &amp;buf[2]); \n\n    drmModeSetCrtc(fd, crtc_id, buf[0].fb_id,   \n            0, 0, &amp;conn_id, 1, &amp;connector-&gt;modes[0]);   //\u521d\u59cb\u5316\u548c\u8bbe\u7f6ecrtc\uff0c\u5bf9\u5e94\u663e\u5b58\u7acb\u5373\u5237\u65b0\n    sleep(5);\n\n    drmModeSetCrtc(fd, crtc_id, buf[1].fb_id,\n        0, 0, &amp;conn_id, 1, &amp;connector-&gt;modes[0]);\n    sleep(5);\n\n    drmModeSetCrtc(fd, crtc_id, buf[2].fb_id,\n        0, 0, &amp;conn_id, 1, &amp;connector-&gt;modes[0]);\n    sleep(5);\n\n    release_fb(fd, &amp;buf[0]);\n    release_fb(fd, &amp;buf[1]);\n    release_fb(fd, &amp;buf[2]);\n\n    drmModeFreeConnector(connector);\n    drmModeFreeResources(resources);\n\n    close(fd);\n\n    return 0;\n</code></pre></p>"},{"location":"Linux/DRM/Overview/#_1","title":"\u5f15\u7528","text":"<p>https://blog.csdn.net/yangguoyu8023/article/details/129241987?spm=1001.2014.3001.5501</p>"},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/","title":"1. intel gpu\u5206\u914d\u663e\u5b58\u548c\u6620\u5c04","text":"<p>intel\u7528\u6237\u6001\u9a71\u52a8\u521b\u5efa\u4e00\u4e2abuffer\uff0c\u8fd9\u4e2abuffer\u5305\u542b\u7684\u4fe1\u606f\uff0c\u5927\u5c0f\uff0c\u5730\u5740\uff0cmap\u7b49\uff0c\u901a\u5e38\u4f7f\u7528\u4e00\u4e2abo\u6765\u8868\u793a\u8fd9\u4e9b\u4fe1\u606f\u3002bo\u7684\u521b\u5efa\u6709\u591a\u79cd\u65b9\u5f0f 1. \u4ece\u5916\u90e8\u5bfc\u5165\u4e00\u4e2abo 2. \u521b\u5efa\u4e00\u4e2abo 3. \u4ece\u7528\u6237\u6307\u5b9a\u7684\u7cfb\u7edf\u5185\u5b58\u5730\u5740\u521b\u5efa\u4e00\u4e2abo</p>"},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#_1","title":"\u5916\u90e8\u5bfc\u5165","text":""},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#fdbo","title":"\u4ecefd\u5bfc\u5165bo","text":"<p>handle\u662f\u6bcf\u4e2agem context\u62e5\u6709\u7684\uff0c\u4e0d\u80fd\u8de8\u8fdb\u7a0b\u4f20\u8f93\u3002\u5982\u679c\u9700\u8981\u8de8\u8fdb\u7a0b\u4f20\u8f93\uff0c\u5219\u9700\u8981\u5229\u7528\u53ef\u4ee5\u8fdb\u7a0b\u901a\u4fe1\u7684fd\uff0c\u5c06handle\u548cfd\u8054\u7cfb\u8d77\u6765\u3002android\u5927\u90e8\u5206buffer\u90fd\u662f\u901a\u8fc7binder\u4f20\u9012fd\u3002gem\u5728\u901a\u8fc7handle\u53bb\u67e5\u627e\u4e00\u4e2abo\u3002 drm\u63d0\u4f9b\u4e86drmPrimeFDtoHandle\u63a5\u53e3\uff0c\u83b7\u5f97fd\u5bf9\u5e94\u7684handle\u3002\u5bf9\u5e94\u7684handle\u8f6cfd\u51fd\u6570\u662fdrmPrimeHandleToFD\u3002</p>"},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#namebo","title":"\u4ecename\u5bfc\u5165bo","text":"<p>GEM name\u5728\u7528\u9014\u4e0a\u7c7b\u4f3c\u4e8e\u53e5\u67c4\uff0c\u4f46\u4e0d\u662fDRM\u6587\u4ef6\u7684\u672c\u5730\u540d\u79f0\u3002\u5b83\u4eec\u53ef\u4ee5\u5728\u8fdb\u7a0b\u4e4b\u95f4\u4f20\u9012\u4ee5\u5168\u5c40\u5f15\u7528GEM\u5bf9\u8c61\u3002\u540d\u79f0\u4e0d\u7528\u76f4\u63a5\u7528\u4e8e\u5f15\u7528DRM API\u7684\u5bf9\u8c61\uff0c\u5e94\u7528\u7a0b\u5e8f\u5fc5\u987b\u5206\u522b\u4f7f\u7528DRM_IOCTL_GEM_FLINK \u548c DRM_IOCTL_GEM_OPEN ioctl\u5c06\u53e5\u67c4\u8f6c\u6362\u4e3aname\uff0c\u5e76\u5c06name\u8f6c\u6362\u4e3a\u53e5\u67c4\u3002\u8f6c\u6362\u7531DRM\u6838\u5fc3\u5904\u7406\uff0c\u5e76\u4e0d\u7279\u5b9a\u4e8e\u9a71\u52a8\u7a0b\u5e8f\u652f\u6301\u3002</p>"},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#bo","title":"\u5206\u914d\u4e00\u4e2abo","text":""},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#_2","title":"\u5185\u5b58\u7c7b\u578b\u6ce8\u518c","text":"<p>intel gpu \u9a71\u52a8\u5206\u4e3asystem \u5185\u5b58\u548clocal \u5185\u5b58\u3002 <pre><code>enum intel_memory_type {\n\u00a0 \u00a0 INTEL_MEMORY_SYSTEM = I915_MEMORY_CLASS_SYSTEM,\n\u00a0 \u00a0 INTEL_MEMORY_LOCAL = I915_MEMORY_CLASS_DEVICE,\n\u00a0 \u00a0 INTEL_MEMORY_STOLEN_SYSTEM,\n\u00a0 \u00a0 INTEL_MEMORY_STOLEN_LOCAL,\n\u00a0 \u00a0 INTEL_MEMORY_MOCK,\n};\n</code></pre></p> <p>\u4e24\u79cd\u5185\u5b58\u90fd\u6ce8\u518c\u6210intel region. system \u5185\u5b58\u6ce8\u518ci915_gem_ttm_system_setup \u663e\u5b58\u6ce8\u518c intel_gt_setup_lmem\u3002 \u5bf9\u4e8ei915 \u9a71\u52a8\u65e0\u8bba\u54ea\u79cd\u5185\u5b58\u65b9\u5f0f\u90fd\u662f\u7528intel_memory_region_create \u6ce8\u518c\u4e00\u4e2amemory \u7684\u533a\u57df\u3002</p> <pre><code>struct intel_memory_region {\n\n\u00a0 \u00a0 struct drm_i915_private *i915; //\n\u00a0 \u00a0 const struct intel_memory_region_ops *ops;\n\u00a0 \u00a0 struct io_mapping iomap;\n\u00a0 \u00a0 struct resource region;\n\u00a0 \u00a0 struct resource io;\n\u00a0 \u00a0 resource_size_t min_page_size;\n\u00a0 \u00a0 resource_size_t total;\n\u00a0 \u00a0 u16 type;\n\u00a0 \u00a0 u16 instance;\n\u00a0 \u00a0 enum intel_region_id id;\n\u00a0 \u00a0 char name[16];\n\u00a0 \u00a0 char uabi_name[16];\n\u00a0 \u00a0 bool private; /* not for userspace */\n\u00a0 \u00a0 \n\u00a0 \u00a0 struct {\n\u00a0 \u00a0 \u00a0 \u00a0 struct mutex lock; /* Protects access to objects */\n\u00a0 \u00a0 \u00a0 \u00a0 struct list_head list;\n\u00a0 \u00a0 } objects;  \n\n\u00a0 \u00a0 bool is_range_manager;\n\u00a0 \u00a0 void *region_private;\n};\n</code></pre> <p>\u591a\u4e2aintel_memory_region\u6307\u5411\u540c\u4e00\u4e2adrm_i915_private <pre><code>struct drm_i915_private {\n\u00a0 \u00a0 struct drm_device drm; //\u5bf9\u5e94\u4e8e\u4e0a\u5c42\u7684\u8bbe\u5907\u865a\u62df\u5185\u5b58\u7ba1\u7406\n\u00a0 \u00a0 struct {\n\u00a0 \u00a0 \u00a0 \u00a0 struct pci_dev *pdev;\n\u00a0 \u00a0 \u00a0 \u00a0 struct resource mch_res;\n\u00a0 \u00a0 \u00a0 \u00a0 bool mchbar_need_disable;\n\u00a0 \u00a0 } gmch;\n\n    ......\n\n\u00a0 \u00a0 struct i915_gem_mm mm;\n\n    ......\n\n\u00a0 \u00a0 struct {\n\u00a0 \u00a0 \u00a0 \u00a0 struct i915_gem_contexts {\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 spinlock_t lock; /* locks list */\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 struct list_head list;\n\u00a0 \u00a0 \u00a0 \u00a0 } contexts;\n\u00a0 \u00a0 \u00a0 \u00a0 struct file *mmap_singleton;\n\u00a0 \u00a0 } gem;\n\n    ......\n\n\u00a0 \u00a0 /* The TTM device structure. */\n\u00a0 \u00a0 struct ttm_device bdev; //\u5bf9\u5e94\u4e8e\u4e0b\u5c42\u7684\u8bbe\u5907\u7269\u7406\u5185\u5b58\u7ba1\u7406\n};\n</code></pre></p> <p>\u5176\u4e2d\uff0c\u53ea\u4f1a\u5728 intel_region_lmem_ops -&gt; region_lmem_init -&gt; i915_ttm_buddy_man_init \u4f1a\u521d\u59cb\u5316bdev\uff0c\u5904\u7406\u5b9e\u9645\u7684\u663e\u5b58\u7ba1\u7406\u3002</p> <pre><code>struct ttm_device {\n\u00a0 \u00a0 struct list_head device_list;\n\u00a0 \u00a0 const struct ttm_device_funcs *funcs;\n\u00a0 \u00a0 struct ttm_resource_manager sysman;\n\u00a0 \u00a0 struct ttm_resource_manager *man_drv[TTM_NUM_MEM_TYPES]; \\\\ttm\u7ba1\u7406\u5668\n\u00a0 \u00a0 struct drm_vma_offset_manager *vma_manager;\n\u00a0 \u00a0 struct ttm_pool pool; \n\u00a0 \u00a0 spinlock_t lru_lock;\n\u00a0 \u00a0 struct list_head pinned;\n\u00a0 \u00a0 struct address_space *dev_mapping;\n\u00a0 \u00a0 struct workqueue_struct *wq;\n};\n</code></pre> <p><pre><code>struct ttm_resource_manager {\n\u00a0 \u00a0 bool use_type;\n\u00a0 \u00a0 bool use_tt;\n\u00a0 \u00a0 struct ttm_device *bdev;\n\u00a0 \u00a0 uint64_t size;\n\u00a0 \u00a0 const struct ttm_resource_manager_func *func; \\\\ttm_resource\u7ba1\u7406\u51fd\u6570\n\u00a0 \u00a0 spinlock_t move_lock;\n\u00a0 \u00a0 struct dma_fence *move;\n\u00a0 \u00a0 struct list_head lru[TTM_MAX_BO_PRIORITY];\n\u00a0 \u00a0 uint64_t usage;\n};\n</code></pre> \u7531\u4e8ettm \u66f4\u65b0\u81f3buddy\u7ba1\u7406\u5668\uff0c\u5728i915_ttm_buddy_man_init\u4e2d\uff0cdrm_buddy_init \u521d\u59cb\u5316 i915_ttm_buddy_manager -&gt; mm, \u5c06i915_ttm_buddy_manager -&gt;manager\u7ed1\u5b9a\u5230 ttm_device -&gt; ttm_resource_manager [type] ,\u518d\u5904\u7406ttm_resource_manager -&gt; func \u5e76ttm_resource_manager_init\u521d\u59cb\u5316i915_ttm_buddy_manager -&gt;manager.</p> <pre><code>struct i915_ttm_buddy_manager {\n\u00a0 \u00a0 struct ttm_resource_manager manager;\n\u00a0 \u00a0 struct drm_buddy mm;\n\u00a0 \u00a0 struct list_head reserved;\n\u00a0 \u00a0 struct mutex lock;\n\u00a0 \u00a0 unsigned long visible_size;\n\u00a0 \u00a0 unsigned long visible_avail;\n\u00a0 \u00a0 unsigned long visible_reserved;\n\u00a0 \u00a0 u64 default_page_size;\n\n};\n</code></pre> <p>intel_memory_region \u5b9e\u9645\u521d\u59cb\u5316\u4e86lmem, system_mem, gem_shmem, gem_stolen.</p>"},{"location":"Linux/KMD/1.%20intel%20gpu%E5%88%86%E9%85%8D%E6%98%BE%E5%AD%98%E5%92%8C%E6%98%A0%E5%B0%84/#_3","title":"\u7528\u6237\u6001\u5206\u914d","text":"<p>1.mesa \u4e0b\u53d1\u547d\u4ee4 mesa \u6839\u636e\u914d\u7f6e\u7684\u53c2\u6570 \u8c03\u7528<code>DRM_IOCTL_I915_GEM_CREATE_EXT</code>\u8c03\u7528__i915_gem_object_create_user_ext\u5206\u914d\u5185\u6838\u4e2d\u4e00\u4e2aobj\u3002</p> <p>2.\u521d\u59cb\u5316obj \u72b6\u6001\u4fe1\u606f intel_memory_region -&gt; __i915_gem_ttm_object_init \u5219\u88ab\u4f7f\u7528\u6765\u521d\u59cb\u5316\u4e00\u4e2attm obj\u548cttm_resource. ttm_resource_alloc\u8c03\u7528 i915_ttm_buddy_man_alloc \u51fd\u6570\u5b8c\u6210ttm_resource \u5206\u914d\u548c\u521d\u59cb\u5316\u3002</p> <pre><code>int __i915_gem_ttm_object_init(struct intel_memory_region *mem,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0struct drm_i915_gem_object *obj,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0resource_size_t offset,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0resource_size_t size,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0resource_size_t page_size,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0unsigned int flags)\n{\n    ......\n\u00a0 \u00a0 struct ttm_operation_ctx ctx = {\n\u00a0 \u00a0 \u00a0 \u00a0 .interruptible = true,\n\u00a0 \u00a0 \u00a0 \u00a0 .no_wait_gpu = false,\n\u00a0 \u00a0 };\n    ......\n\u00a0 \u00a0 drm_gem_private_object_init(&amp;i915-&gt;drm, &amp;obj-&gt;base, size);\n\u00a0 \u00a0 i915_gem_object_init(obj, &amp;i915_gem_ttm_obj_ops, &amp;lock_class, flags);\n\n\u00a0 \u00a0 obj-&gt;bo_offset = offset;\n\u00a0 \u00a0 obj-&gt;mm.region = mem;\n\n\u00a0 \u00a0 INIT_LIST_HEAD(&amp;obj-&gt;mm.region_link);\n\u00a0 \u00a0 INIT_RADIX_TREE(&amp;obj-&gt;ttm.get_io_page.radix, GFP_KERNEL | __GFP_NOWARN);\n\u00a0 \u00a0 mutex_init(&amp;obj-&gt;ttm.get_io_page.lock);\n\n\u00a0 \u00a0 bo_type = (obj-&gt;flags &amp; I915_BO_ALLOC_USER) ? ttm_bo_type_device :\n\u00a0 \u00a0 \u00a0 \u00a0 ttm_bo_type_kernel;\n\n   \u00a0 obj-&gt;base.vma_node.driver_private = i915_gem_to_ttm(obj);\n\n\u00a0 \u00a0 i915_gem_object_make_unshrinkable(obj);\n\n\u00a0 \u00a0 ret = ttm_bo_init_reserved(&amp;i915-&gt;bdev, i915_gem_to_ttm(obj), bo_type,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&amp;i915_sys_placement, page_size &gt;&gt; PAGE_SHIFT,\n\u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0 \u00a0&amp;ctx, NULL, NULL, i915_ttm_bo_destroy);\n    ......\n\u00a0\n\u00a0 \u00a0 obj-&gt;ttm.created = true;\n\n\u00a0 \u00a0 i915_gem_object_release_memory_region(obj);\n\u00a0 \u00a0 i915_gem_object_init_memory_region(obj, mem);\n\u00a0 \u00a0 i915_ttm_adjust_domains_after_move(obj);\n\u00a0 \u00a0 i915_ttm_adjust_gem_after_move(obj);\n\u00a0 \u00a0 i915_gem_object_unlock(obj);\n\n  \u00a0 return 0;\n}\n</code></pre> <p><code>drm_gem_private_object_init</code>\u521d\u59cb\u5316 <code>drm_gem_object</code> ,\u5176\u4e2d\u521d\u59cb\u5316obj\u7684\u5f15\u7528,resv\uff0c vma_node\u7b49\u4e09\u4e2a\u7ed3\u6784\u4f53\u3002<code>kref_init(&amp;obj-&gt;refcount)</code>, <code>dma_resv_init(&amp;obj-&gt;_resv)</code>, <code>drm_vma_node_reset(&amp;obj-&gt;vma_node)</code>.****</p>"},{"location":"Linux/KMD/2.%20kfd%20read/","title":"2. kfd read","text":"<p>kfd \u5728<code>kfd_chardev.c</code>\u88ab\u521d\u59cb\u5316\u4e3a\u4e00\u4e2a\u5b57\u7b26\u8bbe\u5907\u3002</p> <p><pre><code>static const struct file_operations kfd_fops = {\n\u00a0 \u00a0 .owner = THIS_MODULE,\n\u00a0 \u00a0 .unlocked_ioctl = kfd_ioctl,\n\u00a0 \u00a0 .compat_ioctl = compat_ptr_ioctl,\n\u00a0 \u00a0 .open = kfd_open,\n\u00a0 \u00a0 .release = kfd_release,\n\u00a0 \u00a0 .mmap = kfd_mmap,\n};\n</code></pre> kfd_mmap\u901a\u8fc7vma\u4f20\u5165\u7684\u865a\u62df\u5730\u5740\u504f\u79fbmmap_offset\u6765\u89e3\u6790\u6620\u5c04\u3002\u5176\u4e2d\u9ad8\u4f4d\u4e3a\u6620\u5c04\u663e\u5b58\u7c7b\u578b\u3002</p>"},{"location":"Linux/KMD/2.%20kfd%20read/#kfd-ioctl","title":"KFD IOCTL","text":"<p>kfd_ioctl_alloc_memory_of_gpu     mem \u2190 amdgpu_amdkfd_gpuvm_alloc_memory_of_gpu()         amdgpu_gem_object_create         drm_vma_node_allow         drm_gem_handle_create</p> <p>kfd_ioctl_map_memory_to_gpu     mem \u2192 amdgpu_amdkfd_gpuvm_map_memory_to_gpu()         kfd_mem_attach             kfd_mem_attach_dmabuf                 kfd_mem_export_dmabuf                 amdgpu_gem_prime_import                     amdgpu_dma_buf_create_obj                     dma_buf_dynamic_attach</p> <pre><code>    reserve_bo_and_vm\n    map_bo_to_gpuvm\n    unreserve_bo_and_vms\n</code></pre>"},{"location":"Linux/KMD/DRM-KMS/","title":"DRM KMS","text":"<p>\u5728\u5404\u7c7bSOC\u4e0a\uff0cCRTC+Endode+Connector\u4e00\u822c\u662f\u96c6\u6210\u5728\u4e00\u4e2a\u5916\u8bbe\u6a21\u5757\u6302\u5728\u7cfb\u7edf\u603b\u7ebf\u4e0a \u6211\u4eec\u6309\u7167connector\u2192encoder\u2192crtc\u2192framebuffer\u7684\u987a\u5e8f\u5012\u8fc7\u6765\u4ecb\u7ecd\u5427</p>"},{"location":"Linux/KMD/DRM-KMS/#connector","title":"Connector","text":"<p>Connector\u5176\u5b9e\u5c31\u662f\u548c\u663e\u793a\u5668\u8fde\u63a5\u7684\u7269\u7406\u63a5\u53e3\uff0c\u5e38\u89c1\u7684\u6709VGA/HDMI/DVI/DP\u7b49\u3002</p>"},{"location":"Linux/KMD/DRM-KMS/#encoder","title":"Encoder","text":"<p>Encoder\u6bd4\u8f83\u597d\u7406\u89e3\uff0c\u5728\u6b64\u5904\u5176\u5b9e\u5c31\u662f\u5c06\u4e00\u5b9a\u683c\u5f0f\u7684\u56fe\u50cf\u4fe1\u53f7\uff08\u5982RGB\u3001YUV\u7b49\uff09\u7f16\u7801\u6210connector\u9700\u8981\u8f93\u51fa\u7684\u4fe1\u53f7\u3002</p>"},{"location":"Linux/KMD/DRM-KMS/#crtc","title":"CRTC","text":"<p>CRTC\u7684\u4efb\u52a1\u662f\u4eceFramebuffer\u4e2d\u8bfb\u51fa\u5f85\u663e\u793a\u7684\u56fe\u50cf\uff0c\u5e76\u6309\u7167\u76f8\u5e94\u7684\u683c\u5f0f\u8f93\u51fa\u7ed9Encoder</p>"},{"location":"Linux/KMD/DRM-KMS/#planes","title":"Planes","text":"<p>Plane\u5176\u5b9e\u5c31\u662f\u56fe\u5c42\uff0c\u5b9e\u9645\u8f93\u51fa\u7684\u56fe\u50cf\u5f80\u5f80\u7531\u591a\u4e2a\u56fe\u5c42\u53e0\u52a0\u800c\u6210\uff08\u60f3\u8c61\u4e00\u4e0bphotoshop\u7684\u8fc7\u7a0b\uff09</p>"},{"location":"Linux/KMD/DRM-KMS/#framebuffer","title":"Framebuffer","text":"<p>Framebuffer\u5bf9\u5e94\u7740\u5b58\u50a8\u7a7a\u95f4\u4e2d\u7684\u56fe\u50cf\u6570\u636e\uff0c\u6b64\u5904\u5bf9\u5e94\u786c\u4ef6\u4e3aDDR\u3002</p> <p>\u6211\u4eec\u77e5\u9053Framebuffer\u662f\u5b58\u50a8\u5f85\u663e\u793a\u56fe\u50cf\u4fe1\u606f\u7684\u7a7a\u95f4\uff0c\u56e0\u6b64\uff0cFramebuffer\u76f8\u5173\u9a71\u52a8\u4e2d\u4e5f\u5c31\u662f\u5bf9\u5185\u5b58\u7684\u64cd\u4f5c\uff0c\u4e5f\u5c31\u6d89\u53ca\u5230\u4e0b\u9762\u4e24\u4e2a\u90e8\u5206\uff1a \u2460 \u5bf9\u5185\u5b58\u7684\u7ba1\u7406\uff08\u5982GEM\uff0cfor Graphics Execution Manager\uff09 \u2461 \u5185\u5b58\u4e2d\u6570\u636e\u7684\u66f4\u663e\u65b9\u5f0f\uff08\u5982DMA\u7b49\uff09</p> <p>\u5bf9\u4e8e\u7b2c\u4e00\u70b9\uff0cGEM\u4e3b\u8981\u5b8c\u6210\u7684\u4e8b\u60c5\u662f\uff1a \u2460 \u5bf9\u56fe\u50cf\u5185\u5b58\uff08\u663e\u5b58\uff09\u7684\u7a7a\u95f4\u5f00\u8f9f\u3001\u91ca\u653e\uff1b \u2461 \u4e0d\u540c\u786c\u4ef6\u5bf9\u540c\u4e00\u663e\u5b58\u8d44\u6e90\u8bbf\u95ee\u4e0b\u7684\u7ba1\u7406\uff1b \u56e0\u4e3a\u5bf9\u4e8eARM\u800c\u8a00\uff0cframebuffer\u662fsystem memory\uff0c\u901a\u8fc7\u5206\u914d\u4e00\u5757\u8fde\u7eed\u7684\u5185\u5b58CMA\u6765\u5b9e\u73b0gem\u7684\u5e95\u5c42\uff0c\u4e5f\u4e0d\u9700\u8981\u589e\u52a0iommu\u7684\u652f\u6301\uff0c\u5728mmap\u63a5\u53e3\u4e2d\u76f4\u63a5\u6620\u5c04<code>remap_pfn_range()</code>\u6240\u6709\u7684gem\u5230\u7528\u6237\u7a7a\u95f4\u3002 \u5728Linux Kernel\u4e0b\u7684\u9ed8\u8ba4\u5b9e\u73b0\u65b9\u5f0f\u662fCMA\uff08Contiguous Memory Allocator\uff09\u5b9e\u73b0\u7684\uff0c\u5185\u6838\u4e2d\u5bf9\u5e94\u4ee3\u7801\u662f\uff1adrivers/gpu/drm/drm_gem_dma_helper.c</p> <p>Linux\u539f\u751f\u7cfb\u7edf\u4e2d\u63d0\u4f9b\u7531DRM+KMS\u6784\u6210\u7684DRI\uff08Direct Rendering Infrastructure\uff09\u4e2d\uff1a - DRM\u4e3b\u8981\u8d1f\u8d23\u8d1f\u8d23\u6570\u636e\u6d41\uff0c\u5373\u901a\u8fc7\u8f6f\u4ef6\u6216\u786c\u4ef6\uff0c\u751f\u6210\u76ee\u6807\u56fe\u50cf\uff0c\u5b58\u50a8\u5728framebuffer\u4e2d\uff1b - KMS\u4e3b\u8981\u8d1f\u8d23\u63a7\u5236\u6d41\uff0c\u5373\u9488\u5bf9\u5916\u7f6eLCD\u4ee5\u53ca\u6307\u5b9a\u7684\u663e\u793a\u6a21\u5f0f\u8bbe\u7f6e\uff0c\u5c06\u751f\u6210\u597d\u4e86\u7684frame\u6570\u636e\u4fe1\u606f\u9001\u5230\u54cd\u5e94display port\u4e0a\uff08VGA\u3001HDMI\u7b49\uff09\uff1b Kernel\u5c06\u8fd9\u4e24\u5927\u5757\u7684\u57fa\u672cAPI\u62bd\u51fa\u6765\u5c01\u88c5\u6210libdrm\u4f9bX\u4f7f\u7528\uff0c\u6574\u4e2a\u5e94\u7528\u5c42+kernel\u76f8\u5173\u7684GUI\u7ed3\u6784\u5982\u4e0b\u56fe\uff1a</p>"},{"location":"Linux/KMD/GEM/","title":"GEM","text":""},{"location":"Linux/KMD/GEM/#mesa","title":"mesa","text":"<pre><code>ret = drmIoctl(fd, DRM_IOCTL_AMDGPU_GEM_MMAP, &amp;map);\nsim_bo-&gt;mmap_offset = map.out.addr_ptr;\n\nsim_bo-&gt;gem_vaddr = mmap(NULL, sim_bo-&gt;size,PROT_READ | PROT_WRITE, MAP_SHARED,\nfd, sim_bo-&gt;mmap_offset);\n</code></pre>"},{"location":"Linux/KMD/GEM/#gem-ioctl","title":"gem ioctl","text":"<pre><code>DRM_IOCTL_DEF_DRV(AMDGPU_GEM_CREATE, amdgpu_gem_create_ioctl, DRM_AUTH|DRM_RENDER_ALLOW),\n\nDRM_IOCTL_DEF_DRV(AMDGPU_GEM_MMAP, amdgpu_gem_mmap_ioctl, DRM_AUTH|DRM_RENDER_ALLOW),\n</code></pre> <ol> <li> <p>amdgpu_gem_create_ioctl \u521b\u5efa\u4e00\u4e2a\u5185\u5b58\u5bf9\u8c61\uff0c\u5e76\u5b9e\u4f8b\u5316\u6210\u4e00\u4e2adma-buf\uff0c\u8fd4\u56dehandle <pre><code>    amdgpu_bo_create_user(adev, &amp;bp, &amp;ubo);\n        (*obj)-&gt;funcs = &amp;amdgpu_gem_object_funcs;\n</code></pre></p> </li> <li> <pre><code>amdgpu_gem_mmap_ioctl \u62ff\u5230\u5185\u5b58\u5bf9\u8c61\u7684\u865a\u62df\u5730\u5740\u504f\u79fb\u91cf\n</code></pre> <p><code>C *offset_p = amdgpu_bo_mmap_offset(robj);         drm_vma_node_offset_addr(&amp;bo-&gt;tbo.base.vma_node);</code></p> </li> <li> <p>addr = mmap(NULL, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, mmap_offset); <pre><code>sim_bo-&gt;gem_vaddr = mmap(NULL, sim_bo-&gt;size, PROT_READ | PROT_WRITE, MAP_SHARED,\n                         fd, sim_bo-&gt;mmap_offset);\n</code></pre>     drm_gem_dmabuf_mmap         drm_gem_prime_mmap \u8fd9\u4e2a\u65f6\u5019\uff0c\u5982\u679c\u5728\u521d\u59cb\u5316gem_obj\u7684\u65f6\u5019\u8bbe\u7f6e\u4e86mmap\u51fd\u6570\u4ee5\u53cavm_ops\uff0c\u5219\u4f1a\u8c03\u7528\u3002\u5176\u4e2d\u9700\u8981\u5173\u6ce8\u7684\u662fvm_ops.fault\u51fd\u6570<code>amdgpu_gem_fault</code>\u4ee5\u53cammap\u51fd\u6570<code>amdgpu_gem_object_mmap</code>. <pre><code>int drm_gem_prime_mmap(struct drm_gem_object *obj, struct vm_area_struct *vma)\n{\n    /* Add the fake offset */\n    vma-&gt;vm_pgoff += drm_vma_node_start(&amp;obj-&gt;vma_node);\n\n    if (obj-&gt;funcs &amp;&amp; obj-&gt;funcs-&gt;mmap) {\n        vma-&gt;vm_ops = obj-&gt;funcs-&gt;vm_ops;\n\n        drm_gem_object_get(obj);\n        ret = obj-&gt;funcs-&gt;mmap(obj, vma);\n        if (ret) {\n            drm_gem_object_put(obj);\n            return ret;\n        }\n        vma-&gt;vm_private_data = obj;\n        return 0;\n    }\n\n}\n</code></pre></p> </li> </ol>"},{"location":"Linux/KMD/GEM/#prime-importexport","title":"prime import/export","text":"<p>DRM\u63d0\u4f9b\u4e86\u4e24\u4e2aioctl\u547d\u4ee4\uff0c\u5206\u522b\u5bf9\u5e94\u5bfc\u5165\u548c\u5bfc\u51fa\uff1a <pre><code>DRM_IOCTL_DEF(DRM_IOCTL_PRIME_HANDLE_TO_FD, drm_prime_handle_to_fd_ioctl, DRM_RENDER_ALLOW)\n\nDRM_IOCTL_DEF(DRM_IOCTL_PRIME_FD_TO_HANDLE, drm_prime_fd_to_handle_ioctl, DRM_RENDER_ALLOW)\n</code></pre></p> <p>DMA Fence <pre><code>DRM_IOCTL_DEF_DRV(AMDGPU_WAIT_CS, amdgpu_cs_wait_ioctl, DRM_AUTH|DRM_RENDER_ALLOW),\n\nDRM_IOCTL_DEF_DRV(AMDGPU_WAIT_FENCES, amdgpu_cs_wait_fences_ioctl, DRM_AUTH|DRM_RENDER_ALLOW),\n</code></pre></p> <p>i915_gem_object_wait_reservation</p>"},{"location":"Linux/KMD/GPU%20PAGE%20FAULT/","title":"GPU PAGE FAULT","text":"<ol> <li>using </li> </ol>"},{"location":"Linux/KMD/GPU%E8%BF%9B%E7%A8%8B/","title":"GPU\u8fdb\u7a0b","text":""},{"location":"Linux/KMD/GPU%E8%BF%9B%E7%A8%8B/#gtt","title":"\u8fdb\u7a0bgtt\u6620\u5c04\u8868\u57fa\u5730\u5740\u5199\u5165","text":"<p>\u7528\u6237OpenGL\u4f1a\u521b\u5efa\u4e00\u4e2acontext\uff0c\u5728intel\u7528\u6237\u6001\u9a71\u52a8mesa\u4e2d\uff0c\u7528\u6237context\u4f1a\u5bf9\u5e94\u521b\u5efa\u4e00\u4e2agem context\u3002\u5185\u6838\u9a71\u52a8\u6839\u636e\u786c\u4ef6\u6709\u591a\u5c11\u4e2a\u5f15\u64ce(video, render, blitter\u7b49\u7b49) \u521b\u5efa\u591a\u5c11\u4e2aintel context(\u9a71\u52a8\u5185\u90e8\u4f7f\u7528)\u3002\u6bcf\u4e2a\u5f15\u64ce\u5bf9\u5e94\u4e00\u4e2aintel context\u3002\u6bcf\u4e2aintel context\u4f1a\u521b\u5efa\u51fa\u4e00\u4e2alogical context, logical context\u4fdd\u5b58\u4e86\u5728\u786c\u4ef6\u4e0a\u5207\u6362\u4efb\u52a1\u65f6\u5019\u7684\u4e0a\u4e0b\u6587\uff0c\u4fdd\u5b58\u4e86\u4e00\u4e9b\u786c\u4ef6\u7684\u5bc4\u5b58\u5668\u72b6\u6001\u3002\u51fd\u6570intel_engine_context_size\u7528\u6765\u83b7\u53d6intel\u4e0d\u540cgenX logical context\u7684\u5927\u5c0f\uff0c\u6700\u65b0\u7684gen12 logical context 14\u4e2apage size\u3002Logical Context\u5305\u542b\u4e09\u4e2a\u90e8\u5206: - Per-process HW Status Page(4K) - Ring Context (RingBuffer Control Registers, Page Directory Pointers) - Engine Context (PipelineStatu, Non-pipelineState, Statistics, MMIO) Ring Context \u4e2d\u4fdd\u5b58\u4e86Page Directory Pointers\uff0c\u4e5f\u5c31\u662f\u7528\u6765\u4fdd\u5b58\u8f6c\u6362\u8868\u7684\u57fa\u5730\u5740\u3002ppgtt\u8f6c\u6362\u5206\u914d\u5728\u5185\u5b58\u4e2d\u3002\u5728\u9a71\u52a8i5_gem_create_context -&gt; i915_ppgtt_create -&gt; gen8_ppgtt_create\u3002 \u4e5f\u5c31\u662f\u4e00\u4e2a\u7528\u6237\u6001\u7684gem context\u6709\u4e00\u4e2appgtt\u7684\u6620\u5c04\u8f6c\u6362\u8868\u3002 \u9a71\u52a8\u4e2d\u5b58\u5728gen6\u548cgen8\u4e24\u79cdppgtt\u63a5\u53e3\u5b9e\u73b0\u3002</p> <p>ppgtt\u6307\u5411\u7684\u5185\u5b58\u662f\u4e00\u4e2a\u5728system\u4e0a\u5206\u914d\u7684buffer\u3002</p> <p>ppgtt_init\u51fd\u6570\uff0c\u521d\u59cb\u5316\u4e86vm\u540c\u65f6\u7ed1\u5b9a\u4e86vma\u7684\u64cd\u4f5c\u51fd\u6570\u3002\u5e76\u4e14\u521d\u59cb\u5316\u4e86i915\u4e2d\u7684vm(gpu\u8fdb\u7a0b\u5730\u5740\u7a7a\u95f4)</p>"},{"location":"ROCm/ROCm%E5%88%86%E6%9E%90/","title":"ROCm\u5206\u6790","text":"<p>\u76f8\u6bd4\u82f1\u4f1f\u8fbe\u7684TensorRT-LLM\u4f18\u5316\u6846\u67b6\uff0cAMD\u7684ROCm\u751f\u6001\u4ecd\u663e\u5355\u8584\u3002\u4f8b\u5982\u8fd0\u884cLlama 3-70B\u65f6\uff0c7900 XTX\u6027\u80fd\u9aa4\u964d40%\uff0c\u66b4\u9732\u51fa\u5bf9\u590d\u6742\u6a21\u578b\u652f\u6301\u7684\u77ed\u677f\u3002\u4f8b\u5982\u8fd0\u884cLlama 3-70B\u65f6\uff0c7900 XTX\u6027\u80fd\u9aa4\u964d40%\uff0c\u66b4\u9732\u51fa\u5bf9\u590d\u6742\u6a21\u578b\u652f\u6301\u7684\u77ed\u677f\u3002</p> <p>ollama, \u504f\u5411\u4e2a\u4eba\u7528\u6237\uff0c\u90e8\u7f72\u7b80\u5355\u7f51\u7edc\u9ad8\u6548\u3002\u4e3b\u8981\u5728cpu\u4e0a\u8fd0\u884c\u5927\u6a21\u578b\uff0c\u901a\u8fc7\u5c06\u90e8\u5206\u53c2\u6570\u5378\u8f7d\u5230gpu\u6765\u63d0\u5347\u8fd0\u884c\u901f\u5ea6\u3002     Ollama\u8fce\u6765\u91cd\u5927\u66f4\u65b0\uff0c\u5f15\u5165flash attention\u4fee\u590d\u548cKV cache\u91cf\u5316 sg-lang/vllm\uff0c\u504f\u5411\u5546\u7528\uff0c\u5e76\u53d1\u6027\u5e26\u5bbd\u9ad8\u3002\u4e3b\u8981\u5728gpu\u4e0a\u8fd0\u884c\u5927\u6a21\u578b\uff0c\u5982\u679coffload\u6280\u672f\u5378\u8f7d\u90e8\u5206\u53c2\u6570\u5230cpu\u8fdb\u884c\u6267\u884c\u3002\u6027\u80fd\u63d0\u5347\u5728kvcache\u7684\u4f18\u5316\u4e0a\u3002</p> croe build 22226 2116345 5.14.0-556.el9.x86_64 fail 22016 2109964 5.14.0-547.el9.x86_64 pass"},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/","title":"\u4fee\u6539wsl\u5185torch\u5f15\u7528\u76ee\u5f55","text":"<p>pip show torch</p>"},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/#torch","title":"\u663e\u793a\u4e86torch\u5f15\u7528\u76ee\u5f55","text":"<p>-=&gt; \u00a0Location: /home/longlyao/.local/lib/python3.10/site-packages</p> <p>cd /home/longlyao/.local/lib/python3.10/site-packages/torch/lib</p>"},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/#binary","title":"\u8bbe\u7f6ebinary\u6307\u5411\u8def\u5f84","text":"<p>patchelf --set-rpath /opt/rocm/lib libamdhip64.so</p>"},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/#mv-xxx","title":"\u6216\u8005\u53ef\u4ee5\u5c06\u6211\u4eec\u5df2\u7ecf\u7f16\u8bd1\u8fc7\u7684\u76f4\u63a5\u66ff\u6362\u8fc7\u6765\uff0c\u4fee\u6539\u540d\u5b57\u4e5f\u884c mv xxx/","text":""},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/#_1","title":"\u67e5\u770b\u662f\u5426\u5df2\u7ecf\u4fee\u6539","text":"<p>readelf -d libamdhip64.so</p> <p>0x000000000000001d (RUNPATH)\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 Library runpath: [/opt/rocm/lib]</p>"},{"location":"ROCm/WSL%20torch%E5%BC%95%E7%94%A8/#_2","title":"\u9a8c\u8bc1","text":"<p>python</p> <p>import torch</p> <p>torch.cuda.is_available()</p>"},{"location":"ROCm/gemm/","title":"Gemm","text":"<p>hipblas(gemm)  -&gt; hip _runtime -&gt; libkfd -&gt; amdkfd</p> <p>\u4ecehiptest\u8bbf\u95eegpu\u7684\u8fc7\u7a0b</p>"},{"location":"ROCm/vLLM/","title":"vLLM","text":"<p>vLLM \u662f\u4e00\u4e2a LLM (Large Lanuage Model) \u63a8\u7406\u548c\u90e8\u7f72\u670d\u52a1\u5e93\uff0c\u5b83\u7ed3\u5408 iterative-level schedule (\u5e38\u88ab\u79f0\u4e3a continuous batching\uff0c\u8be5\u8c03\u5ea6\u7b97\u6cd5\u5728\u00a0Orca\u00a0\u4e2d\u9996\u6b21\u88ab\u63d0\u51fa) \u548c PagedAttention \u6ce8\u610f\u529b\u7b97\u6cd5\u4ee5\u63d0\u9ad8\u670d\u52a1\u7684\u541e\u5410\u91cf\u3002</p>"},{"location":"WeekReport/2025-W24/","title":"2025 W24","text":"<pre><code>graph TD\n    A[\u6240\u6709\u60f3\u6cd5] --&gt; B(\u6280\u672f\u70b9)\n    A --&gt; C(\u5b9e\u73b0\u6b65\u9aa4)\n    A --&gt; D(\u8e29\u5751\u8bb0\u5f55)\n    B --&gt; B1[Python\u88c5\u9970\u5668]\n    B --&gt; B2[\u5f02\u6b65IO]\n</code></pre>"},{"location":"kernel%20release/Linux_6.14/","title":"Linux 6.14","text":"<p>https://kernelnewbies.org/Linux_6.14</p> <p>dmem cgroup \u7528\u4e8e\u66f4\u597d\u5730\u63a7\u5236GPU\u5185\u5b58\u8d44\u6e90</p>"},{"location":"kernel%20release/Linux_6.15/","title":"Linux 6.15","text":""},{"location":"kernel%20release/Linux_6.15/#summary","title":"Summary:","text":"<p>This release includes a number of VFS improvements, such as mount notifications, allow creating idmapped mounts from idmapped mounts, support creating detached mounts from a detached mount, allow mount detached mounts on detached mounts, and support detached mounts in overlayfs. There is also support for latency profiling in perf, io_uring networking support for zero-copy receive, a fwctl subsystem to standarize firmware management, bcachefs improvements such as scrub, and support for broadcast TLB invalidation using AMD's INVLPGB instruction. As always, there are many other features, new drivers, improvements and fixes. Also, you might be interested in the LWN merge window report https://lwn.net/Articles/1015414/ https://lwn.net/Articles/1016119/</p>"},{"location":"kernel%20release/Linux_6.15/#1","title":"1.","text":""},{"location":"%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B2%BE%E8%AF%BB%20%E3%80%8A%E5%A5%94%E8%B7%91linux%E5%86%85%E6%A0%B8%E3%80%8B/","title":"\u7cbe\u8bfb \u300a\u5954\u8dd1linux\u5185\u6838\u300b","text":"<ul> <li>\u7b2c\u4e00\u7ae0</li> </ul>"},{"location":"%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/%E7%B2%BE%E8%AF%BB%20%E3%80%8A%E5%A5%94%E8%B7%91linux%E5%86%85%E6%A0%B8%E3%80%8B/#_1","title":"\u7b2c\u4e00\u7ae0","text":"<p>\u8fc8\u5411\u73b0\u4ee3C++</p>"}]}